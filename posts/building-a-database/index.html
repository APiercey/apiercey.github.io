<!doctype html><html lang=en><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="ie=edge"><title>Building a Simple Database - apiercey.github.io</title><meta name=viewport content="width=device-width,initial-scale=1"><link rel=icon href=https://apiercey.github.io/favicon.png><meta name=google-site-verification content="NumVaC4w3L9xrwd7wA91DomOegJLYQ-jIhXhWmK7Yd0"><meta name=robots content="index,follow"><link rel=stylesheet href=/css/style.min.e315583b83c1bb6617f4663f843dfe54334015b1c951cb47bd8484b6d697a907.css><meta name=description content="What does it take to build a database? Exploring the minimum design required to implement a simple NoSQL database and examine the complexity databases are required to deal with."><meta property="og:title" content="Building a Simple Database"><meta property="og:type" content="website"><meta property="og:url" content="https://apiercey.github.io/posts/building-a-database/"><meta property="og:image" content="https://apiercey.github.io/images/space-cerqueira.jpg"><meta property="og:description" content="What does it take to build a database? Exploring the minimum design required to implement a simple NoSQL database and examine the complexity databases are required to deal with."><meta name=twitter:card content="summary"><meta name=twitter:site content="@programincolour"><meta name=twitter:creator content="@programincolour"><link rel=preconnect href=https://fonts.gstatic.com><link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;700&display=swap" rel=stylesheet></head><body class='page page-blog-single'><div id=menu-main-mobile class=menu-main-mobile><ul class=menu><li class=menu-item-about><a href=https://apiercey.github.io/pages/about/>About</a></li><li class=menu-item-blog><a href=https://apiercey.github.io/posts/>Blog</a></li><li class=menu-item-projects><a href=https://apiercey.github.io/projects/>Projects</a></li><li class=menu-item-articles><a href=https://apiercey.github.io/articles/>Articles</a></li></ul></div><div id=wrapper class=wrapper><div class=header><a class=header-logo href=/>apiercey.github.io</a><div class=menu-main><ul><li class=menu-item-about><a href=/pages/about/><span>About</span></a></li><li class="menu-item-blog active"><a href=/posts/><span>Blog</span></a></li><li class=menu-item-projects><a href=/projects/><span>Projects</span></a></li><li class=menu-item-articles><a href=/articles/><span>Articles</span></a></li></ul></div><div id=toggle-menu-main-mobile class=hamburger-trigger><button class=hamburger>Menu</button></div></div><div class=blog><div class=intro><h1>Building a Simple Database<span class=dot>.</span></h1><img src=/images/space-cerqueira.jpg></div><div class=content><p><strong>EDIT: After digesting what I have learned from Golang and this project, I have largely rebuilt RygelDB. I&rsquo;ll update this blog article once I find the time.</strong></p><p>A colleague once said to me, <em>&ldquo;Let&rsquo;s learn Rust and build a NoSql Database! It&rsquo;s easy!&rdquo;</em></p><p>Through group learning sessions, we did learn Rust but we never did build that database. Unfortunately, the precious time we had was consumed by other responsibilities, and after some years, we no longer have delight of working together as he is currently working on some other seriously cool stuff, elsewhere!</p><p>Still, his words stuck with me over the years and scratched at the back of my head - <em>&ldquo;Is it truly so easy?&rdquo;</em></p><h2 id=tldr-show-me-the-code>TL;DR Show Me the Code</h2><p>The result of exploring this topic is <a href=https://github.com/APiercey/RygelDB>RygelDB</a>. A NoSQL document store using commands to store and query documents.</p><h2 id=gophers-by-land-crustaceans-by-sea>Gophers by Land, Crustaceans by Sea</h2><p>Golang is a hot topic for my team and I. We have chosen to incorporate the language into our toolbox to build better software in the neo-Banking domain.</p><p>For this reason, I&rsquo;ve chosen to build a NoSql database - dubbed after <a href=https://farscape.fandom.com/wiki/Rygel_XVI>sparky Rygel</a> - in Golang over Rust purely for a learning exercise and become more familiar with the Golang perspective of Software development.</p><h2 id=functionality>Functionality</h2><p>In the beginning, my imagination ran wild and before long I dreamt of a distributed datastore with read-replica support, all supported by a series of stored events, and all the bells and whistles that comes with <a href="https://news.ycombinator.com/item?id=21897132">a new toy</a>. But alas, self-guilt got the better of me and to prevent ironic friendly-fire, I drafted a scope:</p><ul><li>Store simple types, JSON documents is fine.</li><li>Querying is needed - but nothing complex outside of a few &ldquo;and&rdquo; statements.</li><li>No dynamic indices, no triggers, no cursors - no bells&mldr; no whistles.</li><li>Data should still be organizable - collections of documents is fair.</li><li>CRUD is minimum.</li><li>Persistence between database starts is a must.</li></ul><p>A sort of <strong>MVP</strong> of what you could expect of a database without optimizations.</p><p>Now, with a clearer scope in mind, let&rsquo;s draft concrete terminology.</p><h3 id=terminology>Terminology</h3><h4 id=item>Item</h4><p>A document is stored as <em>an Item</em>.</p><h4 id=collection>Collection</h4><p>Many Items are stored in <em>a Collection</em>.</p><h4 id=language>Language</h4><p>Interacting with the database uses <em>Command-Oriented</em> language. I am feeling inspired by <a href=https://redis.io/commands>Redis</a>.</p><h4 id=store>Store</h4><p>Holds references <em>to Collections</em>. Provides an interface fetching an manipulating Collections and Items.</p><h4 id=command>Command</h4><p>Executes a defined behaviour against <em>a store</em> and returns a result.</p><h2 id=basic-design>Basic Design</h2><p>The database implements as simple <a href=https://en.wikipedia.org/wiki/Read%E2%80%93eval%E2%80%93print_loop>Read-Eval-Print-Loop</a> and executes Commands issued against the database in the following order:</p><ol><li>Read input from the client (Read)</li><li>Parse into a command (Read)</li><li>Execute Command against internal Data Store (Eval)</li><li>Serialize the Result into a String (Eval)</li><li>Send the String back to the client (Print)</li><li>Wait for the next input from the client (Loop)</li></ol><figure><img src=https://g.gravizo.com/svg?%0a%40startuml%0apartition%20%22Read%22%20%7b%0a%20%20%28%2a%29%20--%3e%20%22Read%20input%22%0a%20%20%22Read%20input%22%20--%3e%20%22Parse%20Command%20from%20Input%22%0a%7d%0a%0apartition%20%22Eval%22%20%7b%0a%20%20%22Parse%20Command%20from%20Input%22%20--%3e%20%22Execute%20Command%22%0a%20%20%22Execute%20Command%22%20--%3e%20%22Serialize%20the%20Result%22%0a%7d%0a%0apartition%20%22Print%22%20%7b%0a%20%20%22Serialize%20the%20Result%22%20--%3e%20%22Return%20the%20Serialized%20Result%22%0a%7d%0a%0a%22Return%20the%20Serialized%20Result%22%20--%3e%20%22Loop%22%0a%22Loop%22%20--%3e%20%22Read%20input%22%0a%40enduml%0a alt='High-Level Overview'><figcaption>High-Level Overview</figcaption></figure><h2 id=tying-it-all-together>Tying it all Together</h2><p>The main function of the application does a few things on boot-up:</p><ol><li>Start a SocketServer</li><li>Define a ConnectionHandler</li><li>Create a new Store</li></ol><p>The <em>SocketServer</em> is used for both receiving input and returning serialized results and does so using a ConnectionHandler. When this ConnectionHandler starts, it kicks-off the REPL cycle and begins to wait for input.</p><p>Once input is received, it parses the input into a Command using a CommandParser and executing that Command against the Store.</p><figure><img src=https://g.gravizo.com/svg?%0a%40startuml%0apackage%20Store%20as%20StorePackage%20%7b%0a%20%20%5bStore%5d%0a%20%20%5bCollection%5d%20as%20Coll%0a%20%20%5bItem%5d%20as%20Item%0a%20%20%0a%20%20Store%20..%3e%20Coll%20%3a%20manages%20multiple%0a%20%20Coll%20..%3e%20Item%20%3a%20manages%20multiple%0a%7d%0a%0apackage%20Commands%20%7b%0a%20%20interface%20Command%20as%20Comm%0a%20%20%5bCommand%20Parser%5d%20as%20CommParser%0a%20%20%0a%20%20Comm%20..%3e%20Store%20%3a%20executes%20behaviour%20on%0a%20%20CommParser%20..%3e%20Comm%20%3a%20builds%0a%7d%0a%0apackage%20Main%20%7b%0a%20%20%5bSocketServer%5d%20as%20SS%0a%20%20%5bConnectionHandler%5d%20as%20CH%0a%20%20interface%20Conn%20%0a%0a%20%20SS%20..%3e%20CH%20%3a%20starts%0a%20%20SS%20..%3e%20Conn%20%3a%20builds%0a%20%20CH%20..%3e%20Conn%20%3a%20reads%20input%20using%0a%20%20Conn%20..%3e%20CH%20%3a%20sends%20result%20using%0a%20%20CH%20..%3e%20CommParser%20%3a%20parses%20input%20using%0a%20%20CH%20..%3e%20Comm%20%3a%20executes%0a%7d%0a%40enduml%0a alt='Components and their Relationships'><figcaption>Components and their Relationships</figcaption></figure><h3 id=quick-note-about-persistence>Quick Note About Persistence</h3><p>I did say I wanted to persist data between sessions - I also said I wanted things to be simple. Ultimately, I settled on a very simple approach: Commands notify the calling client (Main in the diagram above) if the store has changed. If it has, the Store will be persisted to the disk in the form of a database dump.</p><p>On boot-up, the main function looks for a database dump and attempts to unmarshal the data into a proper Store object.</p><p>It&rsquo;s not exactly elegant but fits the purpose until more strenuous needs arise.</p><h2 id=commands>Commands</h2><p>The lingual needs of the database or quite small. With only a few commands, we can achieve what we need.</p><h4 id=defining-collections>Defining Collections</h4><div class=highlight><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-1>1</a></span><span><span style=color:#ff9f43>DEFINE</span> <span style=color:#ff9f43>COLLECTION</span> collection_name
</span></span></code></pre></div><p>will create a new collection where document items may be stored.</p><h4 id=storing-data>Storing Data</h4><div class=highlight><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-1>1</a></span><span><span style=color:#ff9f43>STORE</span> <span style=color:#ff9f43>INTO</span> collection_name key {<span style=color:#5af78e>&#34;data&#34;</span>: <span style=color:#5af78e>&#34;structure of document&#34;</span>}
</span></span></code></pre></div><p>will store a document item.</p><h4 id=lookup-of-direct-data>Lookup of direct data</h4><div class=highlight><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-2-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-1>1</a></span><span><span style=color:#ff9f43>LOOKUP</span> key <span style=color:#ff9f43>IN</span> collection_name
</span></span></code></pre></div><p>retrieves a document by key</p><h4 id=querying-data>Querying data</h4><div class=highlight><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-3-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-3-1>1</a></span><span><span style=color:#ff9f43>FETCH</span> <span style=color:#ff6ac1>[</span>all <span style=color:#ff6ac1>|</span> <span style=color:#ff9f43>1</span>, <span style=color:#ff6ac1>...</span>n<span style=color:#ff6ac1>]</span> <span style=color:#ff9f43>FROM</span> collection_name <span style=color:#ff6ac1>[</span><span style=color:#ff9f43>WHERE</span> path<span style=color:#ff6ac1>.</span>of<span style=color:#ff6ac1>.</span>document<span style=color:#ff6ac1>.</span>properties <span style=color:#ff9f43>IS</span> value <span style=color:#ff9f43>AND</span> <span style=color:#ff6ac1>...</span>n<span style=color:#ff6ac1>]</span>
</span></span></code></pre></div><p>queries data using 0 or many WHERE clauses and enforces either <em>all</em> or a limit.</p><p>Given the following data:</p><div class=highlight><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-4-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-1>1</a></span><span><span style=color:#ff9f43>DEFINE</span> <span style=color:#ff9f43>COLLECTION</span> fruits
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-4-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-2>2</a></span><span><span style=color:#ff9f43>STORE</span> <span style=color:#ff9f43>INTO</span> fruits apple {<span style=color:#5af78e>&#34;key&#34;</span><span style=color:#5af78e>:&#34;apple&#34;</span>,<span style=color:#5af78e>&#34;color&#34;</span><span style=color:#5af78e>:&#34;red&#34;</span>}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-4-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-3>3</a></span><span><span style=color:#ff9f43>STORE</span> <span style=color:#ff9f43>INTO</span> fruits orange {<span style=color:#5af78e>&#34;key&#34;</span><span style=color:#5af78e>:&#34;orange&#34;</span>,<span style=color:#5af78e>&#34;color&#34;</span><span style=color:#5af78e>:&#34;orange&#34;</span>}
</span></span></code></pre></div><p>Querying for a single document would look like:</p><div class=highlight><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-1>1</a></span><span><span style=color:#ff9f43>FETCH</span> <span style=color:#ff9f43>1</span> <span style=color:#ff9f43>FROM</span> fruits
</span></span></code></pre></div><blockquote><p>[{&ldquo;color&rdquo;:&ldquo;orange&rdquo;,&ldquo;key&rdquo;:&ldquo;orange&rdquo;}]</p></blockquote><p>Querying for all documents that meet a criteria:</p><div class=highlight><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-6-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-1>1</a></span><span><span style=color:#ff9f43>FETCH</span> all <span style=color:#ff9f43>FROM</span> fruits <span style=color:#ff9f43>WHERE</span> color <span style=color:#ff9f43>IS</span> red
</span></span></code></pre></div><blockquote><p>[{&ldquo;color&rdquo;:&ldquo;red&rdquo;,&ldquo;key&rdquo;:&ldquo;apple&rdquo;}]</p></blockquote><p>It&rsquo;s possible to query based on deep properties and multiple WHERE clauses:</p><div class=highlight><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-1>1</a></span><span><span style=color:#ff9f43>STORE</span> <span style=color:#ff9f43>INTO</span> fruits orange {<span style=color:#5af78e>&#34;key&#34;</span><span style=color:#5af78e>:&#34;dragonfruit&#34;</span>,<span style=color:#5af78e>&#34;color&#34;</span><span style=color:#5af78e>:&#34;red&#34;</span>,<span style=color:#5af78e>&#34;properties&#34;</span>:{<span style=color:#5af78e>&#34;spikes&#34;</span><span style=color:#5af78e>:&#34;many&#34;</span>,<span style=color:#5af78e>&#34;internal_color&#34;</span><span style=color:#5af78e>:&#34;white&#34;</span>}}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-2>2</a></span><span><span style=color:#ff9f43>FETCH</span> all <span style=color:#ff9f43>FROM</span> fruits <span style=color:#ff9f43>WHERE</span> color <span style=color:#ff9f43>IS</span> red <span style=color:#ff9f43>AND</span> properties<span style=color:#ff6ac1>.</span>internal_color <span style=color:#ff9f43>IS</span> white
</span></span></code></pre></div><blockquote><p>[{&ldquo;color&rdquo;:&ldquo;red&rdquo;,&ldquo;key&rdquo;:&ldquo;dragonfruit&rdquo;,&ldquo;properties&rdquo;:{&ldquo;internal_color&rdquo;:&ldquo;white&rdquo;,&ldquo;spikes&rdquo;:&ldquo;many&rdquo;}}]</p></blockquote><h4 id=remove-data>Remove data</h4><div class=highlight><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-8-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-1>1</a></span><span><span style=color:#ff9f43>REMOVE</span> <span style=color:#ff6ac1>[</span><span style=color:#ff9f43>COLLECTION</span> <span style=color:#ff6ac1>|</span> <span style=color:#ff9f43>ITEM</span><span style=color:#ff6ac1>]</span> collection_name <span style=color:#ff6ac1>[</span>key<span style=color:#ff6ac1>]</span>
</span></span></code></pre></div><p>removes either a collection or a document item in a collection. Key is mandatory when removing a document item.</p><h2 id=conclusion>Conclusion</h2><p>The database is simple and served as a wonderful tool for self-improvement. In the end, my colleague was probably right - it was easy enough, if you don&rsquo;t try to build all the &ldquo;extras&rdquo; you love from the database you use in your professional life.</p><h3 id=future-ideas>Future Ideas</h3><h4 id=add-tests>Add tests</h4><p>Why didn&rsquo;t I add any? I found testing in Golang to be very straight-forward without many gotchas. Tests existed at the start but I removed them after they stopped providing value.</p><h4 id=append-to-file-for-persistence>Append To File for Persistence</h4><p>It would be far more efficient to store the results of store-altering Commands to disk rather than dumping the entire file. The Store would require replaying through the append data before serving Commands.</p><p>This would lengthen the boot-up time but incremental snapshots would make a considerable difference, as well.</p><h4 id=read-replicas>Read-Replicas</h4><p>If only for the sake of learning.</p><h4 id=implement-a-proper-command-oriented-language>Implement a Proper Command-Oriented Language</h4><p>The parse is quite naive. It is a bit clumsy in places and doesn&rsquo;t really provide flexibility needed for a proper NoSql database.</p><p>Implementing a proper Parser and Tokenzier would allow for complex queries and data manipulation.</p><h4 id=more-query-support>More Query Support</h4><p>In general, the commands provided are the basic minimum for CRUD operations but there is much left to be desired.</p><p>For instances, when multiple WHERE conditions are provided it currently only supports exact match through the <code>is</code> keyword. Future improvements could be:</p><ul><li>Partial match or LIKE match</li><li><code>is not</code> for when it should not match</li><li>When a nested structure does not confirm or when nested value does not exist</li></ul><h4 id=creating-and-removing-indices>Creating and Removing Indices</h4><p>Currently only a single &ldquo;index&rdquo; exist - which is querying by the <code>key</code> and only works for LOOKUP statements. Support for adding indices would greatly improve it&rsquo;s design and more it more flexible.</p><p>Depending on how the &ldquo;Command-Oriented Language&rdquo; would mature, it may be beneficial to continue to use indices only on LOOKUP statements rather than having FETCH operate using indices as well.</p></div></div></div><div class=footer><div class=footer-social><span class="social-icon social-icon-github"><a href=https://github.com/apiercey title=github target=_blank rel=noopener><img src=/images/social/github.svg width=24 height=24 alt=github></a></span>
<span class="social-icon social-icon-linkedin"><a href=https://www.linkedin.com/in/alexander-butt-piercey title=linkedin target=_blank rel=noopener><img src=/images/social/linkedin.svg width=24 height=24 alt=linkedin></a></span>
<span class="social-icon social-icon-twitter"><a href=https://twitter.com/programincolour title=twitter target=_blank rel=noopener><img src=/images/social/twitter.svg width=24 height=24 alt=twitter></a></span></div></div></div><script type=text/javascript src=/js/bundle.min.28d149c65e8b43f935b5da6797544f9e363170785f466641db0d007cee894169.js></script>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-CX84WRHVTJ"></script>
<script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-CX84WRHVTJ")</script></body></html>