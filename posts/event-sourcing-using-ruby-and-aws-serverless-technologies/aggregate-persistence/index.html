<!doctype html><html lang=en><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="ie=edge"><title>Event Sourcing with Ruby and AWS Serverless Technologies - Part Three: Aggregate Persistence - apiercey.github.io</title><meta name=viewport content="width=device-width,initial-scale=1"><link rel=icon href=https://apiercey.github.io/favicon.png><meta name=google-site-verification content="NumVaC4w3L9xrwd7wA91DomOegJLYQ-jIhXhWmK7Yd0"><meta name=robots content="index,follow"><link rel=stylesheet href=/css/style.min.b5158346cd0be7c685bb4907526f1b697a94560681b975b89e813e6095001706.css><meta name=description content="How complex objects are persisted and how we can tame object complexity by refactoring."><meta name=keywords content="aws,event sourcing,ruby,aggregates,persistence,event driven architecture,repository pattern,meta-programming,dynamodb,serverless,optimistic locking"><meta property="og:title" content="Event Sourcing with Ruby and AWS Serverless Technologies - Part Three: Aggregate Persistence"><meta property="og:type" content="website"><meta property="og:url" content="https://apiercey.github.io/posts/event-sourcing-using-ruby-and-aws-serverless-technologies/aggregate-persistence/"><meta property="og:image" content="https://apiercey.github.io/images/event-sourcing.jpg"><meta property="og:description" content="How complex objects are persisted and how we can tame object complexity by refactoring."><meta name=twitter:card content="summary"><meta name=twitter:site content="@programincolour"><meta name=twitter:creator content="@programincolour"><link rel=preconnect href=https://fonts.gstatic.com><link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;700&display=swap" rel=stylesheet></head><body class='page page-blog-single'><div id=menu-main-mobile class=menu-main-mobile><ul class=menu><li class=menu-item-about><a href=https://apiercey.github.io/pages/about/>About</a></li><li class=menu-item-blog><a href=https://apiercey.github.io/posts/>Blog</a></li><li class=menu-item-projects><a href=https://apiercey.github.io/projects/>Projects</a></li><li class=menu-item-articles><a href=https://apiercey.github.io/articles/>Articles</a></li></ul></div><div id=wrapper class=wrapper><div class=header><a class=header-logo href=/>apiercey.github.io</a><div class=menu-main><ul><li class=menu-item-about><a href=/pages/about/><span>About</span></a></li><li class="menu-item-blog active"><a href=/posts/><span>Blog</span></a></li><li class=menu-item-projects><a href=/projects/><span>Projects</span></a></li><li class=menu-item-articles><a href=/articles/><span>Articles</span></a></li></ul></div><div id=toggle-menu-main-mobile class=hamburger-trigger><button class=hamburger>Menu</button></div></div><div class=blog><div class=intro><h1>Event Sourcing with Ruby and AWS Serverless Technologies - Part Three: Aggregate Persistence<span class=dot>.</span></h1><img src=/images/event-sourcing.jpg></div><div class=content><aside><h2>Table of Contents</h2><nav id=TableOfContents><ul><li><a href=#designing-an-event-store>Designing an Event Store</a><ul><li><a href=#the-ability-to-persist-ordered-events>The Ability to Persist Ordered Events</a></li><li><a href=#the-ability-to-fetch-a-range-of-events>The Ability to Fetch a Range of Events</a></li><li><a href=#the-ability-to-push-events-to-downstream-listeners>The Ability to Push Events to Downstream Listeners</a></li><li><a href=#the-ability-to-prevent-conflicting-changes-from-happening-at-the-same-time>The Ability to Prevent Conflicting Changes From Happening at the Same Time</a></li><li><a href=#design-overview>Design Overview</a></li></ul></li><li><a href=#dynamodb-events-table>DynamoDB Events Table</a><ul><li><a href=#defining-the-module>Defining the Module</a></li><li><a href=#using-the-module>Using the Module</a></li></ul></li><li><a href=#repository-class>Repository Class</a><ul><li><a href=#about-the-repository-pattern>About the Repository Pattern</a></li><li><a href=#repository-outline>Repository Outline</a></li><li><a href=#store-method>Store Method</a></li><li><a href=#fetch-method>Fetch Method</a></li></ul></li><li><a href=#small-cleanup>Small Cleanup</a><ul><li><a href=#refactoring>Refactoring</a></li><li><a href=#refactoring-conclusion>Refactoring Conclusion</a></li></ul></li><li><a href=#test-run>Test Run</a></li><li><a href=#conclusion>Conclusion</a></li></ul></nav></aside><p><em>This is the third part in an on-going blog series about <a href=/posts/event-sourcing-using-ruby-and-aws-serverless-technologies/introduction>building an event sourcing system in Ruby using AWS Serverless technologies</a>.</em></p><p>Persistence of values and complex objects is an integral part of almost all modern applications. Applications which take tremendous care of how their objects actuall pass in-and-out of memory tend to perform far better than those that don&rsquo;t - especially in the face of changing and growing requirements.</p><p>This article covers how to implement aggregate persistence by using the Repository pattern and DynamoDB. We will start by designing our event store and building the first component - the events table.</p><h2 id=designing-an-event-store>Designing an Event Store</h2><p>An event store is the database in an event sourced system. It allows querying and persisting events and is the single source of truth for system data.</p><p>While an event store may be implemented with many different technologies it should meet 4 key criteria:</p><ul><li>The ability to persist ordered events.</li><li>The ability to fetch a range of events (or all events).</li><li>The ability to push events to downstream listeners.</li><li>The ability to prevent conflicting changes from happening at the same time.</li></ul><p>Our event store will be implemented using DynamoDB, Lambda, and Kinesis. Let&rsquo;s review each criteria in turn.</p><h3 id=the-ability-to-persist-ordered-events>The Ability to Persist Ordered Events</h3><p>Event ordering is paramount for event sourced aggregates. Aggregate events which are out of order can have diasterous effects.</p><p>For example, in accounting systems, accounts which are overdrawn (have negative funds) are usually subject to fixed fees regardless of the time span they are overdrawn.</p><p>Let&rsquo;s say Bob deposits 100 dollars into his account on Monday and withdraws 50 dollars on Tuesday. This means there are two events stored in the event store:</p><ul><li>FundsWithdrawn: $100 on Monday</li><li>FundsDeposited: $50 on Tuesday</li></ul><p>If the downstream application responsible for applying overdrawn fees were to receive the FundsDeposited event first before the FundsWithdrawn, poor Bob loss money (and the customer support member receiving a not-so-fun phone call)!</p><h3 id=the-ability-to-fetch-a-range-of-events>The Ability to Fetch a Range of Events</h3><p>A flexible event store allows fetching events from any given time range. Traditionally, when using an event store to rehydrate an aggregate, all events are fetched to build up the state. Expressed as <em><code>[first..last]</code></em></p><p>However, some aggregates may be more popular than others and outside it&rsquo;s normal lifecycle. In such cases, these aggregates may have hundreds of events and rehydration takes substantially longer than normal and consume far greater amounts of memory.</p><p>Through a process called <em>snapshoting</em> an aggregate&rsquo;s complete state may be persisted as an event. From there, only a range starting from the <em>last</em> snapshot till the latest event is necessary. Expressed as <em><code>[n..last]</code></em></p><p>Finally, in some cases a historical range needs to be examined. Expressed as <em><code>[a..b]</code></em>.</p><p>There are two common cases for this:</p><ul><li>An audit or inspection question is posed, &ldquo;When did <em>x</em> happen to Aggregate <em>y</em>?&rdquo;.</li><li>A report must be composed. A range of can be replayed, building up report information.</li></ul><p>Snapshoting is outside the scope of this series, however, as it comes with it&rsquo;s own set of challenges. It&rsquo;s important to be aware of the pattern in case you are experiencing this problem.</p><h3 id=the-ability-to-push-events-to-downstream-listeners>The Ability to Push Events to Downstream Listeners</h3><p>TODO: Insert link</p><p>In the first article, one of the primary reasons for introducing eventsourcing is to provide stronger gaurantees when informing interested parties about data changes. Therefore, this requirement falls under within the circle of responsibility of the event store.</p><p>An event store which does not provide this functionality may still be used but the burden falls on either the engineer utilizing the event store to provide a mechanism of informing interested parties or said parties must periodically query the event store looking for new events.</p><h3 id=the-ability-to-prevent-conflicting-changes-from-happening-at-the-same-time>The Ability to Prevent Conflicting Changes From Happening at the Same Time</h3><p>Consider two requests entering a system at the same time, requesting to change a person&rsquo;s name.</p><ol><li>Request One opens a transaction.</li><li>Request Two opens a transaction.</li><li>Request One changes the person&rsquo;s name to &ldquo;Alex&rdquo;</li><li>Request Two changes the person&rsquo;s name to &ldquo;Alexander&rdquo;</li><li>Request Two commits the transaction.</li><li>Request One commits the transaction.</li></ol><p>Request two, despite starting last beats request one to the punch. The user of this software would left confused to why their name is not as expected.</p><p>In a more series scenario, such as moving money between accounts, the risk can be much higher. A well produced event store prevents such scenarios from transpiring.</p><p>The most accepted approach a strategy known as Optimistic Locking. We&rsquo;ll discuss this in detail within this article.</p><h3 id=design-overview>Design Overview</h3><p>Our event store will utilize four AWS technologies to meet the key criteria:</p><ul><li>DynamoDB to store our aggregate events and provide optimistic locking. This will act as a hot storage.</li><li>Kinesis Streams to push events to our to interested parties.</li><li>S3 Bucket to store our events for long term storage. This will act as a cold storage.</li><li>Two Lambdas:<ul><li>The first to capture new events added to our DynamoDB table and push them to our Kinesis Stream. This will act as an event publisher.</li><li>The second to subscribe to the Kinesis stream and record events to the cold storage (S3 Bucket).</li></ul></li></ul><p><img src=/images/aws-eventsourcing/eventstore-design.jpg alt="Event Store Design"></p><h4 id=hot-vs-cold-storage>Hot vs Cold Storage</h4><p>The hot event storage provides immediate access to events and allows insertion of new events under optimic locking. There, gaurantees are made about the data being inserted into the store. Any events added here gain immediate consistency.</p><p>Reading these events must be fast and in tune with the non-functional <em>Write</em> requirements of our store.</p><p>On the opposite side, cold event storage provides infrequent access more aligned with non-function <em>Read</em> requirements of our store.</p><p>There, large batches of events can be readwithout impacting performance on the write side of our store and subjecting ourselves to large overhead costs.</p><p>For example, with tools such as <a href=https://aws.amazon.com/athena/>Athena</a>, it&rsquo;s possible to query our events using SQL to build reports or derive business insights.</p><h2 id=dynamodb-events-table>DynamoDB Events Table</h2><p>DynamoDB is serverless Document DB from AWS which scales according to demand. Unlike traditional databases technologies where each table belongs to a specific databases, a DynamoDB table do not belong to any overarching entity.</p><p>To implement a table, it requires only a few things:</p><ul><li>A tablename</li><li>A primary key, called the hash key. Must be unique.</li><li>And optionally, a range key, which when used acts as a second lookup key. Must be unique only for it&rsquo;s primary key.</li></ul><p>The primary key will act as the the lookup key for the value. It&rsquo;s possible to provide additional lookup keys, called Global or Local Secondaries, but they won&rsquo;t be necessary for our implementation.</p><p>Our first piece of Infrastructure as Code will be our table. We&rsquo;ll define both the table and a <code>event_store</code> module for future components.</p><h3 id=defining-the-module>Defining the Module</h3><p>Firstly, we&rsquo;ll need to setup our infrastructure directory to use the AWS platform.</p><div class=highlight><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-1>1</a></span><span><span style=color:#78787e># cd to an empty directory you choose</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-2>2</a></span><span>touch providers.tf
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-terraform data-lang=terraform><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-1>1</a></span><span><span style=color:#ff6ac1>provider</span> <span style=color:#5af78e>&#34;aws&#34;</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-2>2</a></span><span>  <span style=color:#57c7ff>version</span> = <span style=color:#5af78e>&#34;~&gt; 4.57&#34;</span><span style=color:#78787e> # Version used at the time of writing
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-3>3</a></span><span><span style=color:#78787e></span>  <span style=color:#57c7ff>region</span>  = <span style=color:#5af78e>&#34;us-east-1&#34;</span><span style=color:#78787e> # Change this if you wish
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-4>4</a></span><span><span style=color:#78787e></span>}
</span></span></code></pre></div><p>Next, the event store. A Terraform module is simply a directory.</p><div class=highlight><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-2-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-1>1</a></span><span>mkdir event_store
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-2-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-2>2</a></span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-2-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-3>3</a></span><span>touch event_store/variables.tf
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-2-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-4>4</a></span><span>touch event_store/outputs.tf
</span></span></code></pre></div><p>Our event store will require a name, which we can supply as a variable.</p><div class=highlight><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-terraform data-lang=terraform><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-3-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-3-1>1</a></span><span><span style=color:#78787e># event_store/variables.tf
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-3-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-3-2>2</a></span><span><span style=color:#78787e></span><span style=color:#ff6ac1>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-3-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-3-3>3</a></span><span><span style=color:#ff6ac1>variable</span> <span style=color:#5af78e>&#34;name&#34;</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-3-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-3-4>4</a></span><span>  <span style=color:#57c7ff>type</span> = string
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-3-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-3-5>5</a></span><span>}
</span></span></code></pre></div><p>Next, we&rsquo;ll define our events table.</p><div class=highlight><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-4-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-1>1</a></span><span>touch event_store/dynamodb.tf
</span></span></code></pre></div><p>The hash key (primary key) will be named <code>AggregateUuid</code> and act store out aggregate&rsquo;s identifier.</p><p>We&rsquo;ll also include a range key named <code>Version</code>. Versions are used to facilitate Optimistic Locking. We&rsquo;ll dive into that more later. Unfortunately, due to a flaw in DynamoDB we must provide range keys upfront if we wish to use them.</p><div class=highlight><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-terraform data-lang=terraform><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-1> 1</a></span><span><span style=color:#78787e># event_store/dynamodb.tf
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-2> 2</a></span><span><span style=color:#78787e></span><span style=color:#ff6ac1>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-3> 3</a></span><span><span style=color:#ff6ac1>resource</span> <span style=color:#5af78e>&#34;aws_dynamodb_table&#34;</span> <span style=color:#5af78e>&#34;es_table&#34;</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-4> 4</a></span><span>  <span style=color:#57c7ff>name</span>     = <span style=color:#5af78e>&#34;</span><span style=color:#5af78e>${</span><span style=color:#ff5c57>var</span>.name<span style=color:#5af78e>}</span><span style=color:#5af78e>-es-table&#34;</span><span style=color:#78787e> # Note the variable here
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-5> 5</a></span><span><span style=color:#78787e></span>  <span style=color:#57c7ff>hash_key</span> = <span style=color:#5af78e>&#34;AggregateUuid&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-6> 6</a></span><span>  <span style=color:#57c7ff>range_key</span> = <span style=color:#5af78e>&#34;Version&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-7> 7</a></span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-8> 8</a></span><span>  attribute {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-9> 9</a></span><span>    <span style=color:#57c7ff>name</span> = <span style=color:#5af78e>&#34;AggregateUuid&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-10><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-10>10</a></span><span>    <span style=color:#57c7ff>type</span> = <span style=color:#5af78e>&#34;S&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-11><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-11>11</a></span><span>  }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-12><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-12>12</a></span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-13><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-13>13</a></span><span>  attribute {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-14><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-14>14</a></span><span>    <span style=color:#57c7ff>name</span> = <span style=color:#5af78e>&#34;Version&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-15><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-15>15</a></span><span>    <span style=color:#57c7ff>type</span> = <span style=color:#5af78e>&#34;N&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-16><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-16>16</a></span><span>  }<span style=color:#78787e>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-17><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-17>17</a></span><span><span style=color:#78787e>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-18><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-18>18</a></span><span><span style=color:#78787e>  # For testing purposes, these values will do just fine
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-19><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-19>19</a></span><span><span style=color:#78787e></span>  <span style=color:#57c7ff>read_capacity</span> = <span style=color:#ff9f43>1</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-20><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-20>20</a></span><span>  <span style=color:#57c7ff>write_capacity</span> = <span style=color:#ff9f43>1</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-21><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-21>21</a></span><span>}
</span></span></code></pre></div><h3 id=using-the-module>Using the Module</h3><p>Now our module is ready to be used, let&rsquo;s define the module in our infrastructure directory.</p><div class=highlight><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-6-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-1>1</a></span><span>touch event_store.tf
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-terraform data-lang=terraform><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-1>1</a></span><span><span style=color:#78787e># event_store.tf
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-2>2</a></span><span><span style=color:#78787e></span><span style=color:#ff6ac1>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-3>3</a></span><span><span style=color:#ff6ac1>module</span> <span style=color:#5af78e>&#34;event-store&#34;</span> {<span style=color:#78787e> # May be whatever name you choose. Must be unique.
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-4>4</a></span><span><span style=color:#78787e></span>  <span style=color:#57c7ff>source</span> = <span style=color:#5af78e>&#34;./event_store&#34;</span><span style=color:#78787e> # points to a directory
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-5>5</a></span><span><span style=color:#78787e></span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-6>6</a></span><span>  <span style=color:#57c7ff>name</span> = <span style=color:#5af78e>&#34;scd&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-7>7</a></span><span>}
</span></span></code></pre></div><p>Our <code>event-store</code> module sources the previously defined custom module. By doing so, it will build all infrastructure resources defined within that module and treat them as a group.</p><p>We can build our infrastructure by running terraform apply.</p><div class=highlight><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-8-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-1>1</a></span><span>$ terraform apply
</span></span></code></pre></div><p>Logging into AWS and looking at DynamoDB, we can see our table. One really great feature of DynamoDB is you can inspect tables and their items from the console which makes debugging a charm.</p><p><img src=/images/aws-eventsourcing/dynamodb-scd.png alt="Events Table"></p><p>Additional event store components will be added in future articles.</p><h2 id=repository-class>Repository Class</h2><p>With our event store table ready to be used, we can turn our attention towards the Class that interfaces with it: The <code>ShoppingCartRepo</code>.</p><h3 id=about-the-repository-pattern>About the Repository Pattern</h3><p>The repository pattern is a data abstraction pattern for <em>querying</em> and <em>persisting</em> objects. It&rsquo;s responsibility is to ensure it provides <em>whole</em> objects when providing them and persisting <em>all</em> changes when storing them.</p><p>Often, Repository Pattern is compared against the ActiveRecord pattern. The two key differences are:</p><ul><li>With the ActiveRecord pattern, persistence methods are implemented on the Entites themselves. Entities understand and are responsible for persistence.</li><li>With the Repository pattern, persistence is delegated to a second object - being the repository. Entities are releieved of persistence responsibilities. Entire objects and their relations <em>must</em> be provided. Where as with ActiveRecord, related objects can be dynamically queried for after the initial data access.</li></ul><p>So how is this pattern implemented? Well&mldr;</p><h4 id=impressions-of-how-they-are-implemented>Impressions of How They Are Implemented</h4><p>The literature around the repository pattern can be eclectic and at times difficult to understand. Much of it is opinion based often handed down, from one generation of engineering teams to another.</p><p>Therefore, it&rsquo;s important for us to get on the same page of what works for us / important for us. (decide which to us)</p><p>I quite enjoy the way Vaugn Vernon summaries Repositores in his book, <a href=https://www.oreilly.com/library/view/implementing-domain-driven-design/9780133039900/><em>Implementing Domain Driven Design</em></a>, also known as <em>&lsquo;The Red Book&rsquo;</em>, which I&rsquo;ll paraphrase:</p><blockquote><p>There are two kinds of repositories. The first, acts as a collection and provides an interface for accessing entities as if they were already loaded in-memory. Changed entities are persisted by passing them to a <code>save</code> method. The second kind, provides only two methods: <code>fetch</code> and <code>store</code>, which fetch and persist single changed Entities respectfully.</p></blockquote><p>A nice way to look at this is, there are two types of Repository patterns:</p><ul><li>One which is <em>really</em> great at meeting complex querying needs. This is highly suited for the <strong>Q</strong> in CQRS.</li><li>One which is <em>really</em> great at building and saving a single complex object. This is highly suited for the <strong>C</strong> in CQRS.</li></ul><p>For accessing our aggregates, we will employ the later definition.</p><p><img src=/images/aws-eventsourcing/repo-returning-agg.jpg alt="Repository returning an aggregate"></p><p>In large applications that deal with incresingly different read and write operations, it is common to have two sets of Repository objects that implement this pattern. Often, a collection-like repository will implement only an interface of intended queries which delegate to <code>Query</code> classes.</p><h3 id=repository-outline>Repository Outline</h3><p>Our Repository will have only two methods: <code>fetch</code> and <code>store</code>, where fetch accepts a single <code>uuid</code> and <code>store</code> accepts an entire Aggregate.</p><p>Additionally, our Repository will require access to DynamoDB. This will be injected as a dependency.</p><div class=highlight><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-9-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-1> 1</a></span><span><span style=color:#ff6ac1>class</span> <span style=color:#f3f99d>ShoppingCartRepo</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-9-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-2> 2</a></span><span>  <span style=color:#ff6ac1>def</span> <span style=color:#57c7ff>initialize</span>(dynamodb_client)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-9-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-3> 3</a></span><span>    <span style=color:#ff5c57>@dynamodb_client</span> <span style=color:#ff6ac1>=</span> client
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-9-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-4> 4</a></span><span>  <span style=color:#ff6ac1>end</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-9-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-5> 5</a></span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-9-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-6> 6</a></span><span>  <span style=color:#ff6ac1>def</span> <span style=color:#57c7ff>fetch</span>(uuid)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-9-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-7> 7</a></span><span>    <span style=color:#78787e># Will implement</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-9-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-8> 8</a></span><span>  <span style=color:#ff6ac1>end</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-9-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-9> 9</a></span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-9-10><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-10>10</a></span><span>  <span style=color:#ff6ac1>def</span> <span style=color:#57c7ff>store</span>(shopping_cart)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-9-11><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-11>11</a></span><span>    <span style=color:#78787e># Will implement</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-9-12><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-12>12</a></span><span>  <span style=color:#ff6ac1>end</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-9-13><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-13>13</a></span><span><span style=color:#ff6ac1>end</span>
</span></span></code></pre></div><h3 id=store-method>Store Method</h3><p>Before we can <code>fetch</code> we must be able to <code>store</code>.</p><p>The <code>store</code> method has three responsibilities:</p><ul><li>Persisting new events (changes) that are queued in the aggregate.</li><li>Provide optimistic locking (prevent change collision).</li><li>Clearing persisted events and returning a clean aggregate, ready for further interactions.</li></ul><p>When persisting changes, each change will be persisted as a unique record in our DynamoDB table. Record uniqueness is gauranteed with two attributes:</p><ul><li>The AggregateUuid, which is the <em>hash</em> key.</li><li>The Version, which is the <em>range</em> key.</li></ul><p>Plus, the <code>Version</code> is the attribute which provides optimistic locking. We&rsquo;ll see how this is achieved later.</p><h4 id=persistence>Persistence</h4><p>Our store method.</p><div class=highlight><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-10-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-10-1> 1</a></span><span><span style=color:#ff6ac1>class</span> <span style=color:#f3f99d>ShoppingCartRepo</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-10-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-10-2> 2</a></span><span>  <span style=color:#78787e># ...</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-10-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-10-3> 3</a></span><span>  <span style=color:#ff6ac1>def</span> <span style=color:#57c7ff>store</span>(shopping_cart)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-10-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-10-4> 4</a></span><span>    new_version <span style=color:#ff6ac1>=</span> shopping_cart<span style=color:#ff6ac1>.</span>version <span style=color:#78787e># Will be added below</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-10-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-10-5> 5</a></span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-10-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-10-6> 6</a></span><span>    new_events <span style=color:#ff6ac1>=</span> shopping_cart<span style=color:#ff6ac1>.</span>changes<span style=color:#ff6ac1>.</span>map <span style=color:#ff6ac1>do</span> <span style=color:#ff6ac1>|</span>event<span style=color:#ff6ac1>|</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-10-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-10-7> 7</a></span><span>      new_version <span style=color:#ff6ac1>=</span> new_version <span style=color:#ff6ac1>+</span> <span style=color:#ff9f43>1</span> <span style=color:#78787e># New version for each event</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-10-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-10-8> 8</a></span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-10-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-10-9> 9</a></span><span>      {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-10-10><a style=outline:none;text-decoration:none;color:inherit href=#hl-10-10>10</a></span><span>        <span style=color:#5af78e>EventUuid</span>: <span style=color:#ff9f43>SecureRandom</span><span style=color:#ff6ac1>.</span>uuid,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-10-11><a style=outline:none;text-decoration:none;color:inherit href=#hl-10-11>11</a></span><span>        <span style=color:#5af78e>AggregateUuid</span>: shopping_cart<span style=color:#ff6ac1>.</span>uuid,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-10-12><a style=outline:none;text-decoration:none;color:inherit href=#hl-10-12>12</a></span><span>        <span style=color:#5af78e>Name</span>: event<span style=color:#ff6ac1>.</span>class<span style=color:#ff6ac1>::</span><span style=color:#ff9f43>NAME</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-10-13><a style=outline:none;text-decoration:none;color:inherit href=#hl-10-13>13</a></span><span>        <span style=color:#5af78e>Data</span>: event<span style=color:#ff6ac1>.</span>to_h,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-10-14><a style=outline:none;text-decoration:none;color:inherit href=#hl-10-14>14</a></span><span>        <span style=color:#5af78e>Version</span>: new_version
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-10-15><a style=outline:none;text-decoration:none;color:inherit href=#hl-10-15>15</a></span><span>      }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-10-16><a style=outline:none;text-decoration:none;color:inherit href=#hl-10-16>16</a></span><span>    <span style=color:#ff6ac1>end</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-10-17><a style=outline:none;text-decoration:none;color:inherit href=#hl-10-17>17</a></span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-10-18><a style=outline:none;text-decoration:none;color:inherit href=#hl-10-18>18</a></span><span>    put_operations <span style=color:#ff6ac1>=</span> events<span style=color:#ff6ac1>.</span>map <span style=color:#ff6ac1>do</span> <span style=color:#ff6ac1>|</span>event<span style=color:#ff6ac1>|</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-10-19><a style=outline:none;text-decoration:none;color:inherit href=#hl-10-19>19</a></span><span>      {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-10-20><a style=outline:none;text-decoration:none;color:inherit href=#hl-10-20>20</a></span><span>        <span style=color:#5af78e>put</span>: {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-10-21><a style=outline:none;text-decoration:none;color:inherit href=#hl-10-21>21</a></span><span>          <span style=color:#5af78e>item</span>: event,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-10-22><a style=outline:none;text-decoration:none;color:inherit href=#hl-10-22>22</a></span><span>          <span style=color:#5af78e>table_name</span>: <span style=color:#5af78e>&#34;scd-es-table&#34;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-10-23><a style=outline:none;text-decoration:none;color:inherit href=#hl-10-23>23</a></span><span>          <span style=color:#5af78e>condition_expression</span>: <span style=color:#5af78e>&#34;attribute_not_exists(#v)&#34;</span>, <span style=color:#78787e># Provides optimistic locking</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-10-24><a style=outline:none;text-decoration:none;color:inherit href=#hl-10-24>24</a></span><span>          <span style=color:#5af78e>expression_attribute_names</span>: {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-10-25><a style=outline:none;text-decoration:none;color:inherit href=#hl-10-25>25</a></span><span>            <span style=color:#5af78e>&#34;#v&#34;</span> <span style=color:#ff6ac1>=&gt;</span> <span style=color:#5af78e>&#34;Version&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-10-26><a style=outline:none;text-decoration:none;color:inherit href=#hl-10-26>26</a></span><span>          }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-10-27><a style=outline:none;text-decoration:none;color:inherit href=#hl-10-27>27</a></span><span>        }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-10-28><a style=outline:none;text-decoration:none;color:inherit href=#hl-10-28>28</a></span><span>      }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-10-29><a style=outline:none;text-decoration:none;color:inherit href=#hl-10-29>29</a></span><span>    <span style=color:#ff6ac1>end</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-10-30><a style=outline:none;text-decoration:none;color:inherit href=#hl-10-30>30</a></span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-10-31><a style=outline:none;text-decoration:none;color:inherit href=#hl-10-31>31</a></span><span>    <span style=color:#ff5c57>@dynamodb_client</span><span style=color:#ff6ac1>.</span>transact_write_items({<span style=color:#5af78e>transact_items</span>: put_operations})
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-10-32><a style=outline:none;text-decoration:none;color:inherit href=#hl-10-32>32</a></span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-10-33><a style=outline:none;text-decoration:none;color:inherit href=#hl-10-33>33</a></span><span>    shopping_cart<span style=color:#ff6ac1>.</span>clear_changes
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-10-34><a style=outline:none;text-decoration:none;color:inherit href=#hl-10-34>34</a></span><span>    shopping_cart<span style=color:#ff6ac1>.</span>version <span style=color:#ff6ac1>=</span> new_version
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-10-35><a style=outline:none;text-decoration:none;color:inherit href=#hl-10-35>35</a></span><span>    shopping_cart
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-10-36><a style=outline:none;text-decoration:none;color:inherit href=#hl-10-36>36</a></span><span>  <span style=color:#ff6ac1>end</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-10-37><a style=outline:none;text-decoration:none;color:inherit href=#hl-10-37>37</a></span><span><span style=color:#ff6ac1>end</span>
</span></span></code></pre></div><p>Firstly, we transform new events into a collection of hashes that will be stored as data. Part of this transformation is providing a new version for individual events.</p><p>The starting event number must come from the aggregate. So we&rsquo;ll add this functionality now to our <code>Aggregate</code> module. As we&rsquo;ll see later, the <code>fetch</code> method will set the aggregate version.</p><div class=highlight><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-11-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-11-1> 1</a></span><span><span style=color:#ff6ac1>module</span> Aggregate
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-11-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-11-2> 2</a></span><span>  <span style=color:#78787e># ...</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-11-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-11-3> 3</a></span><span>  <span style=color:#ff6ac1>def</span> <span style=color:#57c7ff>version</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-11-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-11-4> 4</a></span><span>    <span style=color:#ff5c57>@version</span> <span style=color:#ff6ac1>||</span> <span style=color:#ff9f43>0</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-11-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-11-5> 5</a></span><span>  <span style=color:#ff6ac1>end</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-11-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-11-6> 6</a></span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-11-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-11-7> 7</a></span><span>  <span style=color:#ff6ac1>def</span> <span style=color:#57c7ff>version</span><span style=color:#ff6ac1>=</span>(new_version)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-11-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-11-8> 8</a></span><span>    <span style=color:#ff5c57>@version</span> <span style=color:#ff6ac1>=</span> new_version<span style=color:#ff6ac1>.</span>to_i
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-11-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-11-9> 9</a></span><span>  <span style=color:#ff6ac1>end</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-11-10><a style=outline:none;text-decoration:none;color:inherit href=#hl-11-10>10</a></span><span>  <span style=color:#78787e># ...</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-11-11><a style=outline:none;text-decoration:none;color:inherit href=#hl-11-11>11</a></span><span><span style=color:#ff6ac1>end</span>
</span></span></code></pre></div><p>With DynamoDB, you may persist multiple changes in a transaction similar to relational databases. However, we must describe all operations and execute them in a single call.</p><p>Part of transforming events is transforming the actual event data into a structure suited for persistence. DynamoDB is a document store, so it handles Hashes just fine.</p><p>In order to accomplish this, our events must implement a <code>to_h</code> method.</p><div class=highlight><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-12-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-12-1> 1</a></span><span><span style=color:#ff6ac1>class</span> <span style=color:#f3f99d>CartOpened</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-12-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-12-2> 2</a></span><span>  <span style=color:#ff6ac1>attr_reader</span> <span style=color:#5af78e>:shopping_cart_uuid</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-12-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-12-3> 3</a></span><span>  
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-12-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-12-4> 4</a></span><span>  <span style=color:#78787e># ...</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-12-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-12-5> 5</a></span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-12-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-12-6> 6</a></span><span>  <span style=color:#ff6ac1>def</span> <span style=color:#57c7ff>to_h</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-12-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-12-7> 7</a></span><span>    { <span style=color:#5af78e>shopping_cart_uuid</span>: <span style=color:#ff5c57>@shopping_cart_uuid</span> }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-12-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-12-8> 8</a></span><span>  <span style=color:#ff6ac1>end</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-12-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-12-9> 9</a></span><span><span style=color:#ff6ac1>end</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-12-10><a style=outline:none;text-decoration:none;color:inherit href=#hl-12-10>10</a></span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-12-11><a style=outline:none;text-decoration:none;color:inherit href=#hl-12-11>11</a></span><span><span style=color:#ff6ac1>class</span> <span style=color:#f3f99d>ItemAdded</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-12-12><a style=outline:none;text-decoration:none;color:inherit href=#hl-12-12>12</a></span><span>  <span style=color:#ff6ac1>attr_reader</span> <span style=color:#5af78e>:shopping_cart_uuid</span>, <span style=color:#5af78e>:item_name</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-12-13><a style=outline:none;text-decoration:none;color:inherit href=#hl-12-13>13</a></span><span>  
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-12-14><a style=outline:none;text-decoration:none;color:inherit href=#hl-12-14>14</a></span><span>  <span style=color:#78787e># ...</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-12-15><a style=outline:none;text-decoration:none;color:inherit href=#hl-12-15>15</a></span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-12-16><a style=outline:none;text-decoration:none;color:inherit href=#hl-12-16>16</a></span><span>  <span style=color:#ff6ac1>def</span> <span style=color:#57c7ff>to_h</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-12-17><a style=outline:none;text-decoration:none;color:inherit href=#hl-12-17>17</a></span><span>    { <span style=color:#5af78e>shopping_cart_uuid</span>: <span style=color:#ff5c57>@shopping_cart_uuid</span>, <span style=color:#5af78e>item_name</span>: <span style=color:#ff5c57>@item_name</span> }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-12-18><a style=outline:none;text-decoration:none;color:inherit href=#hl-12-18>18</a></span><span>  <span style=color:#ff6ac1>end</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-12-19><a style=outline:none;text-decoration:none;color:inherit href=#hl-12-19>19</a></span><span><span style=color:#ff6ac1>end</span>
</span></span></code></pre></div><p>Finally, <code>store</code> executes the transaction and persists all changes as records.</p><h4 id=providing-optimistic-locking>Providing Optimistic Locking</h4><p>In my personal opinion, this is the most integral responsibility of a Repository object - to prevent data collisions.</p><p>Normally, in DynamodDB Tables, if a unique record already exists it is overwritten entirely. With <code>conditional_expressions</code>, it alters this behaviour to through an <a href=https://docs.aws.amazon.com/sdk-for-ruby/v3/api/Aws/DynamoDB/Errors/TransactionCanceledException.html>exception</a>.</p><p>Here is a jist from above.</p><div class=highlight><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-13-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-1>1</a></span><span>{
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-13-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-2>2</a></span><span>  <span style=color:#78787e># ...</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-13-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-3>3</a></span><span>  <span style=color:#5af78e>condition_expression</span>: <span style=color:#5af78e>&#34;attribute_not_exists(#v)&#34;</span>, 
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-13-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-4>4</a></span><span>  <span style=color:#5af78e>expression_attribute_names</span>: {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-13-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-5>5</a></span><span>    <span style=color:#5af78e>&#34;#v&#34;</span> <span style=color:#ff6ac1>=&gt;</span> <span style=color:#5af78e>&#34;Version&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-13-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-6>6</a></span><span>  }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-13-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-7>7</a></span><span>  <span style=color:#78787e># ... </span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-13-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-8>8</a></span><span>}
</span></span></code></pre></div><p>Our <code>conditional_expression</code> works by using a <a href=https://docs.aws.amazon.com/amazondynamodb/latest/developerguide/Expressions.OperatorsAndFunctions.html>DynamoDB function</a> called <code>attribute_not_exists</code> which only allows the expression to be committed if it evalues to <code>true</code> and in our case, the expression allows commits if the <code>Version</code> does not already exist.</p><p>With one important detail to remember, <code>Version</code> is a <em>range</em> field. It is only unique for it&rsquo;s given <em>range</em> (<code>AggregateUuid</code>).</p><h4 id=clearing-changes>Clearing Changes</h4><p>Lastly, our <code>store</code> method needs to clear the persisted events. We can achieve this by implementing a method to do so in the <code>Aggregate</code> module.</p><div class=highlight><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-14-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-1> 1</a></span><span><span style=color:#ff6ac1>module</span> Aggregate
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-14-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-2> 2</a></span><span>  <span style=color:#78787e># ...</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-14-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-3> 3</a></span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-14-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-4> 4</a></span><span>  <span style=color:#ff6ac1>def</span> <span style=color:#57c7ff>clear_changes</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-14-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-5> 5</a></span><span>    <span style=color:#ff5c57>@changes</span> <span style=color:#ff6ac1>=</span> <span style=color:#ff6ac1>[]</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-14-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-6> 6</a></span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-14-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-7> 7</a></span><span>    <span style=color:#ff5c57>self</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-14-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-8> 8</a></span><span>  <span style=color:#ff6ac1>end</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-14-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-9> 9</a></span><span>  
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-14-10><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-10>10</a></span><span>  <span style=color:#78787e># ...</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-14-11><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-11>11</a></span><span><span style=color:#ff6ac1>end</span>
</span></span></code></pre></div><p>Our <code>store</code> method is complete and our Aggregates can now be persisted! Congratulations!</p><h3 id=fetch-method>Fetch Method</h3><p>The best for last! With everything we&rsquo;ve build up until now, this is by far the easiest.</p><p>But first, let&rsquo;s talk about how our Aggregates are initialized.</p><h4 id=preparing-our-aggregate-module>Preparing our Aggregate Module</h4><p>Currently, to instantiate our ShoppingCart, we must provide a <code>uuid</code>:</p><div class=highlight><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-15-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-15-1> 1</a></span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-15-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-15-2> 2</a></span><span><span style=color:#ff6ac1>class</span> <span style=color:#f3f99d>ShoppingCart</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-15-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-15-3> 3</a></span><span>  <span style=color:#ff6ac1>include</span> <span style=color:#ff9f43>Aggregate</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-15-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-15-4> 4</a></span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-15-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-15-5> 5</a></span><span>  <span style=color:#ff6ac1>attr_reader</span> <span style=color:#5af78e>:items</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-15-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-15-6> 6</a></span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-15-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-15-7> 7</a></span><span>  <span style=color:#ff6ac1>def</span> <span style=color:#57c7ff>initialize</span>(uuid)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-15-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-15-8> 8</a></span><span>    <span style=color:#ff5c57>@items</span> <span style=color:#ff6ac1>=</span> <span style=color:#ff6ac1>[]</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-15-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-15-9> 9</a></span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-15-10><a style=outline:none;text-decoration:none;color:inherit href=#hl-15-10>10</a></span><span>    enqueue(<span style=color:#ff9f43>CartOpened</span><span style=color:#ff6ac1>.</span>new(uuid))
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-15-11><a style=outline:none;text-decoration:none;color:inherit href=#hl-15-11>11</a></span><span>  <span style=color:#ff6ac1>end</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-15-12><a style=outline:none;text-decoration:none;color:inherit href=#hl-15-12>12</a></span><span>  
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-15-13><a style=outline:none;text-decoration:none;color:inherit href=#hl-15-13>13</a></span><span>  <span style=color:#78787e># ...</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-15-14><a style=outline:none;text-decoration:none;color:inherit href=#hl-15-14>14</a></span><span><span style=color:#ff6ac1>end</span>
</span></span></code></pre></div><p>What about when we need to <em>rebuild</em> an aggregate? We cannot instantiate an empty Aggregate without enqueuing a &ldquo;start&rdquo; event - in our case, a <code>CartOpened</code>. There are a few options.</p><p>We could move the responsibilities of <em>building</em> a new ShoppingCart to a <code>build</code> method, that will instantiate the Aggragate and <code>apply</code> the correct event but there are some drawbacks. We now have <em>two</em> methods for instantiating objects and it can be confusing which one to use, especially as more Engineers join the project.</p><p>We could move the responsibility of instantiating a new <code>ShoppingCart</code> aggregate and <code>CartOpened</code> event to the repository, where a new Aggregate is instatiated and the <code>CartOpened</code> starting event is applied. This too, has some drawbacks. For one, the <em>event</em> which belongs to the domain model is now part of the Repository! The model has very little control over when these events become applied. No bueno!</p><p>I&rsquo;m sure there are a few other clever ways we can do this in ruby but there is one pragmatic way I&rsquo;ve come to enjoy: nullified arguments!</p><p>When instantiating a new Aggregate, we can allow passing in a <code>uuid</code> as <code>nil</code>. By doing so this allows the aggregate to choose to enqueue a new starting event or not. The aggregate retains control of when events are published and keeps a single method for instantiating aggregates.</p><p>We&rsquo;ll apply this principle to the <code>ShoppingCart</code> aggregate.</p><div class=highlight><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-16-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-1> 1</a></span><span><span style=color:#ff6ac1>class</span> <span style=color:#f3f99d>ShoppingCart</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-16-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-2> 2</a></span><span>  <span style=color:#ff6ac1>include</span> <span style=color:#ff9f43>Aggregate</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-16-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-3> 3</a></span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-16-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-4> 4</a></span><span>  <span style=color:#ff6ac1>attr_reader</span> <span style=color:#5af78e>:items</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-16-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-5> 5</a></span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-16-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-6> 6</a></span><span>  <span style=color:#ff6ac1>def</span> <span style=color:#57c7ff>initialize</span>(uuid <span style=color:#ff6ac1>=</span> <span style=color:#ff6ac1>nil</span>) <span style=color:#78787e># uuid is allowed to be nil</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-16-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-7> 7</a></span><span>    <span style=color:#ff5c57>@items</span> <span style=color:#ff6ac1>=</span> <span style=color:#ff6ac1>[]</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-16-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-8> 8</a></span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-16-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-9> 9</a></span><span>    enqueue(<span style=color:#ff9f43>CartOpened</span><span style=color:#ff6ac1>.</span>new(uuid)) <span style=color:#ff6ac1>unless</span> uuid<span style=color:#ff6ac1>.</span>nil? <span style=color:#78787e># if it&#39;s new, it&#39;s a blank object</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-16-10><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-10>10</a></span><span>  <span style=color:#ff6ac1>end</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-16-11><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-11>11</a></span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-16-12><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-12>12</a></span><span>  <span style=color:#ff6ac1>def</span> <span style=color:#57c7ff>add_item</span>(item_name)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-16-13><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-13>13</a></span><span>    enqueue(<span style=color:#ff9f43>Events</span><span style=color:#ff6ac1>::</span><span style=color:#ff9f43>ItemAdded</span><span style=color:#ff6ac1>.</span>new(uuid, item_name))
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-16-14><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-14>14</a></span><span>  <span style=color:#ff6ac1>end</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-16-15><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-15>15</a></span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-16-16><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-16>16</a></span><span>  on <span style=color:#ff9f43>CartOpened</span> <span style=color:#ff6ac1>do</span> <span style=color:#ff6ac1>|</span>event<span style=color:#ff6ac1>|</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-16-17><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-17>17</a></span><span>    <span style=color:#ff5c57>@uuid</span> <span style=color:#ff6ac1>=</span> event<span style=color:#ff6ac1>.</span>shopping_cart_uuid
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-16-18><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-18>18</a></span><span>  <span style=color:#ff6ac1>end</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-16-19><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-19>19</a></span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-16-20><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-20>20</a></span><span>  on <span style=color:#ff9f43>ItemAdded</span> <span style=color:#ff6ac1>do</span> <span style=color:#ff6ac1>|</span>event<span style=color:#ff6ac1>|</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-16-21><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-21>21</a></span><span>    <span style=color:#ff5c57>@items</span> <span style=color:#ff6ac1>=</span> <span style=color:#ff5c57>@items</span><span style=color:#ff6ac1>.</span>append(event<span style=color:#ff6ac1>.</span>item_name)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-16-22><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-22>22</a></span><span>  <span style=color:#ff6ac1>end</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-16-23><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-23>23</a></span><span><span style=color:#ff6ac1>end</span>
</span></span></code></pre></div><p>In a way, I find similarities to the <a href=https://en.wikipedia.org/wiki/Null_object_pattern><code>Null-Object</code> pattern</a>.</p><h4 id=implementing-fetch>Implementing <code>fetch</code></h4><p>The <code>fetch</code> method has three responsibilities:</p><ul><li>Query for a range of previous events using a <code>uuid</code> and apply them against an aggregate.</li><li>Ensure the latest version is set</li><li>If no events can be found <em>or</em> for some reason the <code>uuid</code> is <em><code>nil</code></em>, return <code>nil</code></li></ul><div class=highlight><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-17-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-17-1> 1</a></span><span><span style=color:#ff6ac1>class</span> <span style=color:#f3f99d>ShoppingCartRepo</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-17-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-17-2> 2</a></span><span>  <span style=color:#ff6ac1>def</span> <span style=color:#57c7ff>initialize</span>(dynamodb_client)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-17-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-17-3> 3</a></span><span>    <span style=color:#ff5c57>@dynamodb_client</span> <span style=color:#ff6ac1>=</span> dynamodb_client
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-17-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-17-4> 4</a></span><span>  <span style=color:#ff6ac1>end</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-17-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-17-5> 5</a></span><span>  
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-17-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-17-6> 6</a></span><span>  <span style=color:#ff6ac1>def</span> <span style=color:#57c7ff>fetch</span>(uuid)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-17-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-17-7> 7</a></span><span>    shopping_cart <span style=color:#ff6ac1>=</span> <span style=color:#ff9f43>ShoppingCart</span><span style=color:#ff6ac1>.</span>new
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-17-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-17-8> 8</a></span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-17-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-17-9> 9</a></span><span>    events <span style=color:#ff6ac1>=</span> fetch_aggregate_events(uuid)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-17-10><a style=outline:none;text-decoration:none;color:inherit href=#hl-17-10>10</a></span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-17-11><a style=outline:none;text-decoration:none;color:inherit href=#hl-17-11>11</a></span><span>    <span style=color:#ff6ac1>return</span> <span style=color:#ff6ac1>nil</span> <span style=color:#ff6ac1>if</span> events<span style=color:#ff6ac1>.</span>empty?
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-17-12><a style=outline:none;text-decoration:none;color:inherit href=#hl-17-12>12</a></span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-17-13><a style=outline:none;text-decoration:none;color:inherit href=#hl-17-13>13</a></span><span>    shopping_cart<span style=color:#ff6ac1>.</span>version <span style=color:#ff6ac1>=</span> events<span style=color:#ff6ac1>.</span>last<span style=color:#ff6ac1>.</span>fetch(<span style=color:#5af78e>&#34;Version&#34;</span>)<span style=color:#ff6ac1>.</span>to_i
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-17-14><a style=outline:none;text-decoration:none;color:inherit href=#hl-17-14>14</a></span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-17-15><a style=outline:none;text-decoration:none;color:inherit href=#hl-17-15>15</a></span><span>    events
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-17-16><a style=outline:none;text-decoration:none;color:inherit href=#hl-17-16>16</a></span><span>      <span style=color:#ff6ac1>.</span>map { <span style=color:#ff6ac1>|</span>event<span style=color:#ff6ac1>|</span> build_event(event) }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-17-17><a style=outline:none;text-decoration:none;color:inherit href=#hl-17-17>17</a></span><span>      <span style=color:#ff6ac1>.</span>reject(<span style=color:#ff6ac1>&amp;</span><span style=color:#5af78e>:nil?</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-17-18><a style=outline:none;text-decoration:none;color:inherit href=#hl-17-18>18</a></span><span>      <span style=color:#ff6ac1>.</span>each { <span style=color:#ff6ac1>|</span>event<span style=color:#ff6ac1>|</span> shopping_cart<span style=color:#ff6ac1>.</span>apply(event) }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-17-19><a style=outline:none;text-decoration:none;color:inherit href=#hl-17-19>19</a></span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-17-20><a style=outline:none;text-decoration:none;color:inherit href=#hl-17-20>20</a></span><span>    <span style=color:#ff6ac1>if</span> shopping_cart<span style=color:#ff6ac1>.</span>uuid<span style=color:#ff6ac1>.</span>nil?
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-17-21><a style=outline:none;text-decoration:none;color:inherit href=#hl-17-21>21</a></span><span>      <span style=color:#ff6ac1>nil</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-17-22><a style=outline:none;text-decoration:none;color:inherit href=#hl-17-22>22</a></span><span>    <span style=color:#ff6ac1>else</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-17-23><a style=outline:none;text-decoration:none;color:inherit href=#hl-17-23>23</a></span><span>      shopping_cart
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-17-24><a style=outline:none;text-decoration:none;color:inherit href=#hl-17-24>24</a></span><span>    <span style=color:#ff6ac1>end</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-17-25><a style=outline:none;text-decoration:none;color:inherit href=#hl-17-25>25</a></span><span>  <span style=color:#ff6ac1>end</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-17-26><a style=outline:none;text-decoration:none;color:inherit href=#hl-17-26>26</a></span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-17-27><a style=outline:none;text-decoration:none;color:inherit href=#hl-17-27>27</a></span><span>  <span style=color:#ff6ac1>private</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-17-28><a style=outline:none;text-decoration:none;color:inherit href=#hl-17-28>28</a></span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-17-29><a style=outline:none;text-decoration:none;color:inherit href=#hl-17-29>29</a></span><span>  <span style=color:#ff6ac1>def</span> <span style=color:#57c7ff>fetch_aggregate_events</span>(aggregate_uuid)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-17-30><a style=outline:none;text-decoration:none;color:inherit href=#hl-17-30>30</a></span><span>    query_options <span style=color:#ff6ac1>=</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-17-31><a style=outline:none;text-decoration:none;color:inherit href=#hl-17-31>31</a></span><span>      <span style=color:#5af78e>table_name</span>: <span style=color:#5af78e>&#34;scd-es-table&#34;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-17-32><a style=outline:none;text-decoration:none;color:inherit href=#hl-17-32>32</a></span><span>      <span style=color:#5af78e>key_condition_expression</span>: <span style=color:#5af78e>&#34;AggregateUuid = :aggregate_uuid&#34;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-17-33><a style=outline:none;text-decoration:none;color:inherit href=#hl-17-33>33</a></span><span>      <span style=color:#5af78e>expression_attribute_values</span>: {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-17-34><a style=outline:none;text-decoration:none;color:inherit href=#hl-17-34>34</a></span><span>        <span style=color:#5af78e>&#34;:aggregate_uuid&#34;</span> <span style=color:#ff6ac1>=&gt;</span> aggregate_uuid,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-17-35><a style=outline:none;text-decoration:none;color:inherit href=#hl-17-35>35</a></span><span>      },
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-17-36><a style=outline:none;text-decoration:none;color:inherit href=#hl-17-36>36</a></span><span>      <span style=color:#5af78e>consistent_read</span>: <span style=color:#ff6ac1>true</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-17-37><a style=outline:none;text-decoration:none;color:inherit href=#hl-17-37>37</a></span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-17-38><a style=outline:none;text-decoration:none;color:inherit href=#hl-17-38>38</a></span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-17-39><a style=outline:none;text-decoration:none;color:inherit href=#hl-17-39>39</a></span><span>    items <span style=color:#ff6ac1>=</span> <span style=color:#ff6ac1>[]</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-17-40><a style=outline:none;text-decoration:none;color:inherit href=#hl-17-40>40</a></span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-17-41><a style=outline:none;text-decoration:none;color:inherit href=#hl-17-41>41</a></span><span>    result <span style=color:#ff6ac1>=</span> <span style=color:#ff5c57>@dynamodb_client</span><span style=color:#ff6ac1>.</span>query(query_options)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-17-42><a style=outline:none;text-decoration:none;color:inherit href=#hl-17-42>42</a></span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-17-43><a style=outline:none;text-decoration:none;color:inherit href=#hl-17-43>43</a></span><span>    <span style=color:#ff6ac1>loop</span> <span style=color:#ff6ac1>do</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-17-44><a style=outline:none;text-decoration:none;color:inherit href=#hl-17-44>44</a></span><span>      items <span style=color:#ff6ac1>&lt;&lt;</span> result<span style=color:#ff6ac1>.</span>items
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-17-45><a style=outline:none;text-decoration:none;color:inherit href=#hl-17-45>45</a></span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-17-46><a style=outline:none;text-decoration:none;color:inherit href=#hl-17-46>46</a></span><span>      <span style=color:#ff6ac1>break</span> <span style=color:#ff6ac1>unless</span> (last_evaluated_key <span style=color:#ff6ac1>=</span> result<span style=color:#ff6ac1>.</span>last_evaluated_key)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-17-47><a style=outline:none;text-decoration:none;color:inherit href=#hl-17-47>47</a></span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-17-48><a style=outline:none;text-decoration:none;color:inherit href=#hl-17-48>48</a></span><span>      result <span style=color:#ff6ac1>=</span> <span style=color:#ff5c57>@dynamodb_client</span><span style=color:#ff6ac1>.</span>query(query_options<span style=color:#ff6ac1>.</span>merge(<span style=color:#5af78e>exclusive_start_key</span>: last_evaluated_key))
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-17-49><a style=outline:none;text-decoration:none;color:inherit href=#hl-17-49>49</a></span><span>    <span style=color:#ff6ac1>end</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-17-50><a style=outline:none;text-decoration:none;color:inherit href=#hl-17-50>50</a></span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-17-51><a style=outline:none;text-decoration:none;color:inherit href=#hl-17-51>51</a></span><span>    items<span style=color:#ff6ac1>.</span>flatten
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-17-52><a style=outline:none;text-decoration:none;color:inherit href=#hl-17-52>52</a></span><span>  <span style=color:#ff6ac1>end</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-17-53><a style=outline:none;text-decoration:none;color:inherit href=#hl-17-53>53</a></span><span>  
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-17-54><a style=outline:none;text-decoration:none;color:inherit href=#hl-17-54>54</a></span><span>  <span style=color:#ff6ac1>def</span> <span style=color:#57c7ff>build_event</span>(raw_event)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-17-55><a style=outline:none;text-decoration:none;color:inherit href=#hl-17-55>55</a></span><span>    <span style=color:#ff5c57>name</span> <span style=color:#ff6ac1>=</span> raw_event<span style=color:#ff6ac1>.</span>fetch(<span style=color:#5af78e>&#39;Name&#39;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-17-56><a style=outline:none;text-decoration:none;color:inherit href=#hl-17-56>56</a></span><span>    data <span style=color:#ff6ac1>=</span> raw_event<span style=color:#ff6ac1>.</span>fetch(<span style=color:#5af78e>&#39;Data&#39;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-17-57><a style=outline:none;text-decoration:none;color:inherit href=#hl-17-57>57</a></span><span>      
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-17-58><a style=outline:none;text-decoration:none;color:inherit href=#hl-17-58>58</a></span><span>    <span style=color:#ff6ac1>case</span> <span style=color:#ff5c57>name</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-17-59><a style=outline:none;text-decoration:none;color:inherit href=#hl-17-59>59</a></span><span>    <span style=color:#ff6ac1>when</span> <span style=color:#5af78e>&#34;CartOpened&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-17-60><a style=outline:none;text-decoration:none;color:inherit href=#hl-17-60>60</a></span><span>      <span style=color:#ff9f43>Events</span><span style=color:#ff6ac1>::</span><span style=color:#ff9f43>CartOpened</span><span style=color:#ff6ac1>.</span>new(data<span style=color:#ff6ac1>.</span>fetch(<span style=color:#5af78e>&#34;shopping_cart_uuid&#34;</span>))
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-17-61><a style=outline:none;text-decoration:none;color:inherit href=#hl-17-61>61</a></span><span>    <span style=color:#ff6ac1>when</span> <span style=color:#5af78e>&#34;ItemAdded&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-17-62><a style=outline:none;text-decoration:none;color:inherit href=#hl-17-62>62</a></span><span>      <span style=color:#ff9f43>Events</span><span style=color:#ff6ac1>::</span><span style=color:#ff9f43>ItemAdded</span><span style=color:#ff6ac1>.</span>new(data<span style=color:#ff6ac1>.</span>fetch(<span style=color:#5af78e>&#34;shopping_cart_uuid&#34;</span>), data<span style=color:#ff6ac1>.</span>fetch(<span style=color:#5af78e>&#34;item_name&#34;</span>))
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-17-63><a style=outline:none;text-decoration:none;color:inherit href=#hl-17-63>63</a></span><span>    <span style=color:#ff6ac1>when</span> <span style=color:#5af78e>&#34;CartClosed&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-17-64><a style=outline:none;text-decoration:none;color:inherit href=#hl-17-64>64</a></span><span>      <span style=color:#ff9f43>Events</span><span style=color:#ff6ac1>::</span><span style=color:#ff9f43>CartClosed</span><span style=color:#ff6ac1>.</span>new(data<span style=color:#ff6ac1>.</span>fetch(<span style=color:#5af78e>&#34;shopping_cart_uuid&#34;</span>))
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-17-65><a style=outline:none;text-decoration:none;color:inherit href=#hl-17-65>65</a></span><span>    <span style=color:#ff6ac1>else</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-17-66><a style=outline:none;text-decoration:none;color:inherit href=#hl-17-66>66</a></span><span>      <span style=color:#ff6ac1>nil</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-17-67><a style=outline:none;text-decoration:none;color:inherit href=#hl-17-67>67</a></span><span>    <span style=color:#ff6ac1>end</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-17-68><a style=outline:none;text-decoration:none;color:inherit href=#hl-17-68>68</a></span><span>  <span style=color:#ff6ac1>end</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-17-69><a style=outline:none;text-decoration:none;color:inherit href=#hl-17-69>69</a></span><span>  
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-17-70><a style=outline:none;text-decoration:none;color:inherit href=#hl-17-70>70</a></span><span>  <span style=color:#78787e># ...</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-17-71><a style=outline:none;text-decoration:none;color:inherit href=#hl-17-71>71</a></span><span><span style=color:#ff6ac1>end</span>
</span></span></code></pre></div><p>Our new <code>fetch</code> starts be instantiating a blank <code>ShoppingCart</code> by passing in <code>nil</code> as the <code>uuid</code>. This means it has not enqueued a <code>CartOpened</code> event. It then events are queried from DynamoDB using a the <code>key_condition_expression</code>.</p><p>In order to ensure we are querying for all available records, we must paginate over the evaluation set.</p><p>If it <em>cannot</em> find any events, it returns <code>nil</code> Otherwise, it loops over each record, first <em>initializing</em> an event and then <em>applying</em> it against the aggregate.</p><p>At the end, if the <code>uuid</code> is not <code>nil</code>, you can return the rehdrated <code>ShoppingCart</code>. Otherwise, <code>nil</code>.</p><h4 id=when-would-uuid-be-nil>When would <code>uuid</code> be nil?</h4><p>If our query returns a collection of events and our starting event <em>always</em> provides a <code>uuid</code>, when would it be <code>nil</code>?</p><p>One of the core aspects of event sourcing is that events are <strong>never</strong> deleted nor altered. The event store is append only and the events themselves are immutable! This begs the question, how are Aggregates then &ldquo;deleted&rdquo;?</p><p>By another event of course! In eventually consistent systems, an event which signifies the end of an object is called a <a href=https://en.wikipedia.org/wiki/Tombstone_(data_store)>Tombstone</a>. The motiviation section in the Wikipedia entry describes this as (emphasis my own),</p><blockquote><p>If information is deleted in an eventually-consistent distributed data store, the &ldquo;eventual&rdquo; part of the eventual consistency causes the information to ooze through the node structure, <strong>where some nodes may be unavailable at time of deletion</strong>. But a feature of eventual consistency causes a problem in case of deletion, as a node that was unavailable at that time will try to &ldquo;update&rdquo; the other nodes that no longer have the deleted entry, assuming that they have missed an insert of information. Therefore, <strong>instead of deleting the information, the distributed data store creates a (usually temporary) tombstone record</strong>, which is not returned in response to requests.</p></blockquote><p>When our aggregate should be deleted, a new event is enqueued which sets the <code>uuid</code> to <code>nil</code> effectivly deleting it. Eventually, downstream consumers will receive this event and decide what a tombstone means for their domain.</p><p>Consider the diagram below.</p><p>In this application exists an Ordering System which produces events to a stream. In this particular frame in time, a series of events have been produced which signals the creation of an object through a starting event and the deletion of an object through a tombstone event.</p><p>The Ordering System is immediatly consistent, so therefore it knows data has been deleted. Downstream System A has already processed all produced events on the event stream and so it too knows that data has been deleted.</p><p>However at the same time, Downstream System B is about to discover data has been deleted from the Ordering System while Dowstream System C hasn&rsquo;t even become aware the data existed in the first place.</p><p><img src=/images/aws-eventsourcing/tombstone-events.jpg alt="Tombstone Events"></p><p>In our <code>ShoppingCart</code>, we can define this behaviour with a <code>CartClosed</code> event.</p><div class=highlight><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-18-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-18-1> 1</a></span><span><span style=color:#ff6ac1>class</span> <span style=color:#f3f99d>ShoppingCart</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-18-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-18-2> 2</a></span><span>  <span style=color:#78787e># ...</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-18-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-18-3> 3</a></span><span>  
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-18-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-18-4> 4</a></span><span>  <span style=color:#ff6ac1>def</span> <span style=color:#57c7ff>close</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-18-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-18-5> 5</a></span><span>    enqueue(<span style=color:#ff9f43>CartClosed</span><span style=color:#ff6ac1>.</span>new(uuid))
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-18-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-18-6> 6</a></span><span>  <span style=color:#ff6ac1>end</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-18-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-18-7> 7</a></span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-18-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-18-8> 8</a></span><span>  on <span style=color:#ff9f43>CartClosed</span> <span style=color:#ff6ac1>do</span> <span style=color:#ff6ac1>|</span>event<span style=color:#ff6ac1>|</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-18-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-18-9> 9</a></span><span>    <span style=color:#ff5c57>@uuid</span> <span style=color:#ff6ac1>=</span> <span style=color:#ff6ac1>nil</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-18-10><a style=outline:none;text-decoration:none;color:inherit href=#hl-18-10>10</a></span><span>  <span style=color:#ff6ac1>end</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-18-11><a style=outline:none;text-decoration:none;color:inherit href=#hl-18-11>11</a></span><span>  
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-18-12><a style=outline:none;text-decoration:none;color:inherit href=#hl-18-12>12</a></span><span>  <span style=color:#78787e># ...</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-18-13><a style=outline:none;text-decoration:none;color:inherit href=#hl-18-13>13</a></span><span><span style=color:#ff6ac1>end</span>
</span></span></code></pre></div><p>Whenever a closed (deleted) <code>ShoppingCart</code> is rehydrated, the final event will be <code>CartClosed</code>. This will prevent the aggregate from being returned.</p><h2 id=small-cleanup>Small Cleanup</h2><p>Our repository is looking good but it&rsquo;s breaking a few SOLID rules. If we carefully read through its code, two things stand out:</p><ul><li>There are a wide array of responsibilities in a single class.</li><li>Aside from the events, there is hardly anything about this implementation that seems ShoppingCart specific.</li></ul><p>We can make this far better.</p><h3 id=refactoring>Refactoring</h3><p>We&rsquo;ll refactor our <code>ShoppingCartRepo</code> to abstract persistence behaviours into a base class. Our aim is to acheive two objectives:</p><ul><li>All aggregate repositories may inherit from the same base class and behave the same way.</li><li>A separation of concerns is desirable to produce more easily readable code.</li></ul><p>Martin Fowler&rsquo;s <em><a href=https://martinfowler.com/books/refactoring.html>Refactoring</a></em> describes a fantastic set of approaches to refactoring. We&rsquo;ll apply a few here.</p><h4 id=eventbuilder-class>EventBuilder Class</h4><p>Our repository does not need to understand how events are built. It may delegate this to a second class. Using the <em><a href=https://refactoring.com/catalog/extractClass.html>Extract Class</a></em> refactoring, we&rsquo;ll extract this behaviour to it&rsquo;s own class and inject it as a dependency.</p><div class=highlight><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-19-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-19-1> 1</a></span><span><span style=color:#ff6ac1>module</span> Events
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-19-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-19-2> 2</a></span><span>  <span style=color:#ff6ac1>class</span> <span style=color:#f3f99d>Builder</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-19-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-19-3> 3</a></span><span>    <span style=color:#ff6ac1>def</span> <span style=color:#57c7ff>build</span>(<span style=color:#ff5c57>name</span>, data)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-19-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-19-4> 4</a></span><span>      <span style=color:#ff6ac1>case</span> <span style=color:#ff5c57>name</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-19-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-19-5> 5</a></span><span>      <span style=color:#ff6ac1>when</span> <span style=color:#5af78e>&#34;CartOpened&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-19-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-19-6> 6</a></span><span>        <span style=color:#ff9f43>CartOpened</span><span style=color:#ff6ac1>.</span>new(data<span style=color:#ff6ac1>.</span>fetch(<span style=color:#5af78e>&#34;shopping_cart_uuid&#34;</span>))
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-19-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-19-7> 7</a></span><span>      <span style=color:#ff6ac1>when</span> <span style=color:#5af78e>&#34;ItemAdded&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-19-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-19-8> 8</a></span><span>        <span style=color:#ff9f43>ItemAdded</span><span style=color:#ff6ac1>.</span>new(data<span style=color:#ff6ac1>.</span>fetch(<span style=color:#5af78e>&#34;shopping_cart_uuid&#34;</span>), data<span style=color:#ff6ac1>.</span>fetch(<span style=color:#5af78e>&#34;item_name&#34;</span>))
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-19-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-19-9> 9</a></span><span>      <span style=color:#ff6ac1>else</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-19-10><a style=outline:none;text-decoration:none;color:inherit href=#hl-19-10>10</a></span><span>        <span style=color:#ff6ac1>nil</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-19-11><a style=outline:none;text-decoration:none;color:inherit href=#hl-19-11>11</a></span><span>      <span style=color:#ff6ac1>end</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-19-12><a style=outline:none;text-decoration:none;color:inherit href=#hl-19-12>12</a></span><span>    <span style=color:#ff6ac1>end</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-19-13><a style=outline:none;text-decoration:none;color:inherit href=#hl-19-13>13</a></span><span>  <span style=color:#ff6ac1>end</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-19-14><a style=outline:none;text-decoration:none;color:inherit href=#hl-19-14>14</a></span><span><span style=color:#ff6ac1>end</span>
</span></span></code></pre></div><p>Injecting new class as a dependency and replacing the existing build implementation with a call to the <code>event_builder</code> object.</p><div class=highlight><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-20-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-20-1> 1</a></span><span><span style=color:#ff6ac1>class</span> <span style=color:#f3f99d>ShoppingCartRepo</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-20-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-20-2> 2</a></span><span>  <span style=color:#ff6ac1>def</span> <span style=color:#57c7ff>initialize</span>(dynamodb_client, event_builder)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-20-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-20-3> 3</a></span><span>    <span style=color:#ff5c57>@dynamodb_client</span> <span style=color:#ff6ac1>=</span> client
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-20-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-20-4> 4</a></span><span>    <span style=color:#ff5c57>@event_builder</span> <span style=color:#ff6ac1>=</span> event_builder <span style=color:#78787e># New event builder class</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-20-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-20-5> 5</a></span><span>  <span style=color:#ff6ac1>end</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-20-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-20-6> 6</a></span><span>  
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-20-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-20-7> 7</a></span><span>  <span style=color:#78787e># ... fetch and store</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-20-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-20-8> 8</a></span><span>  
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-20-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-20-9> 9</a></span><span>  <span style=color:#ff6ac1>def</span> <span style=color:#57c7ff>build_event</span>(raw_event)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-20-10><a style=outline:none;text-decoration:none;color:inherit href=#hl-20-10>10</a></span><span>    event_builder_module<span style=color:#ff6ac1>.</span>build(raw_event<span style=color:#ff6ac1>.</span>fetch(<span style=color:#5af78e>&#39;Name&#39;</span>), raw_event<span style=color:#ff6ac1>.</span>fetch(<span style=color:#5af78e>&#39;Data&#39;</span>))
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-20-11><a style=outline:none;text-decoration:none;color:inherit href=#hl-20-11>11</a></span><span>  <span style=color:#ff6ac1>end</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-20-12><a style=outline:none;text-decoration:none;color:inherit href=#hl-20-12>12</a></span><span><span style=color:#ff6ac1>end</span>
</span></span></code></pre></div><h4 id=tailored-dynamodb-client>Tailored DynamoDB Client</h4><p>The repository is responsible for both accessing the underlying persistence technology and building an aggregate. Let&rsquo;s separate this.</p><p>First, we&rsquo;ll use <em><a href=https://refactoring.com/catalog/extractFunction.html>Extract Function</a></em> refactoring to move data persistence from <code>store</code> into it&rsquo;s own method.</p><div class=highlight><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-21-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-21-1> 1</a></span><span><span style=color:#ff6ac1>class</span> <span style=color:#f3f99d>ShoppingCartRepo</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-21-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-21-2> 2</a></span><span>  <span style=color:#78787e># ...</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-21-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-21-3> 3</a></span><span>  
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-21-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-21-4> 4</a></span><span>  <span style=color:#ff6ac1>def</span> <span style=color:#57c7ff>store</span>(shopping_cart)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-21-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-21-5> 5</a></span><span>    new_version <span style=color:#ff6ac1>=</span> shopping_cart<span style=color:#ff6ac1>.</span>version <span style=color:#78787e># Will be added below</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-21-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-21-6> 6</a></span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-21-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-21-7> 7</a></span><span>    new_events <span style=color:#ff6ac1>=</span> shopping_cart<span style=color:#ff6ac1>.</span>changes<span style=color:#ff6ac1>.</span>map <span style=color:#ff6ac1>do</span> <span style=color:#ff6ac1>|</span>event<span style=color:#ff6ac1>|</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-21-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-21-8> 8</a></span><span>      new_version <span style=color:#ff6ac1>=</span> new_version <span style=color:#ff6ac1>+</span> <span style=color:#ff9f43>1</span> <span style=color:#78787e># New version for each event</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-21-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-21-9> 9</a></span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-21-10><a style=outline:none;text-decoration:none;color:inherit href=#hl-21-10>10</a></span><span>      {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-21-11><a style=outline:none;text-decoration:none;color:inherit href=#hl-21-11>11</a></span><span>        <span style=color:#5af78e>EventUuid</span>: <span style=color:#ff9f43>SecureRandom</span><span style=color:#ff6ac1>.</span>uuid,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-21-12><a style=outline:none;text-decoration:none;color:inherit href=#hl-21-12>12</a></span><span>        <span style=color:#5af78e>AggregateUuid</span>: shopping_cart<span style=color:#ff6ac1>.</span>uuid,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-21-13><a style=outline:none;text-decoration:none;color:inherit href=#hl-21-13>13</a></span><span>        <span style=color:#5af78e>Name</span>: event<span style=color:#ff6ac1>.</span>class<span style=color:#ff6ac1>::</span><span style=color:#ff9f43>NAME</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-21-14><a style=outline:none;text-decoration:none;color:inherit href=#hl-21-14>14</a></span><span>        <span style=color:#5af78e>Data</span>: event<span style=color:#ff6ac1>.</span>to_h,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-21-15><a style=outline:none;text-decoration:none;color:inherit href=#hl-21-15>15</a></span><span>        <span style=color:#5af78e>Version</span>: new_version
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-21-16><a style=outline:none;text-decoration:none;color:inherit href=#hl-21-16>16</a></span><span>      }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-21-17><a style=outline:none;text-decoration:none;color:inherit href=#hl-21-17>17</a></span><span>    <span style=color:#ff6ac1>end</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-21-18><a style=outline:none;text-decoration:none;color:inherit href=#hl-21-18>18</a></span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-21-19><a style=outline:none;text-decoration:none;color:inherit href=#hl-21-19>19</a></span><span>    insert_aggregate_events!(new_events) <span style=color:#78787e># Call new method</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-21-20><a style=outline:none;text-decoration:none;color:inherit href=#hl-21-20>20</a></span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-21-21><a style=outline:none;text-decoration:none;color:inherit href=#hl-21-21>21</a></span><span>    shopping_cart<span style=color:#ff6ac1>.</span>clear_changes
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-21-22><a style=outline:none;text-decoration:none;color:inherit href=#hl-21-22>22</a></span><span>    shopping_cart<span style=color:#ff6ac1>.</span>version <span style=color:#ff6ac1>=</span> new_version
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-21-23><a style=outline:none;text-decoration:none;color:inherit href=#hl-21-23>23</a></span><span>    shopping_cart
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-21-24><a style=outline:none;text-decoration:none;color:inherit href=#hl-21-24>24</a></span><span>  <span style=color:#ff6ac1>end</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-21-25><a style=outline:none;text-decoration:none;color:inherit href=#hl-21-25>25</a></span><span>  
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-21-26><a style=outline:none;text-decoration:none;color:inherit href=#hl-21-26>26</a></span><span>  <span style=color:#ff6ac1>private</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-21-27><a style=outline:none;text-decoration:none;color:inherit href=#hl-21-27>27</a></span><span>  
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-21-28><a style=outline:none;text-decoration:none;color:inherit href=#hl-21-28>28</a></span><span>  <span style=color:#ff6ac1>def</span> <span style=color:#57c7ff>insert_aggregate_events!</span>(events)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-21-29><a style=outline:none;text-decoration:none;color:inherit href=#hl-21-29>29</a></span><span>    put_operations <span style=color:#ff6ac1>=</span> events<span style=color:#ff6ac1>.</span>map <span style=color:#ff6ac1>do</span> <span style=color:#ff6ac1>|</span>event<span style=color:#ff6ac1>|</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-21-30><a style=outline:none;text-decoration:none;color:inherit href=#hl-21-30>30</a></span><span>      {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-21-31><a style=outline:none;text-decoration:none;color:inherit href=#hl-21-31>31</a></span><span>        <span style=color:#5af78e>put</span>: {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-21-32><a style=outline:none;text-decoration:none;color:inherit href=#hl-21-32>32</a></span><span>          <span style=color:#5af78e>item</span>: event,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-21-33><a style=outline:none;text-decoration:none;color:inherit href=#hl-21-33>33</a></span><span>          <span style=color:#5af78e>table_name</span>: <span style=color:#5af78e>&#34;scd-es-table&#34;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-21-34><a style=outline:none;text-decoration:none;color:inherit href=#hl-21-34>34</a></span><span>          <span style=color:#5af78e>condition_expression</span>: <span style=color:#5af78e>&#34;attribute_not_exists(#v)&#34;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-21-35><a style=outline:none;text-decoration:none;color:inherit href=#hl-21-35>35</a></span><span>          <span style=color:#5af78e>expression_attribute_names</span>: {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-21-36><a style=outline:none;text-decoration:none;color:inherit href=#hl-21-36>36</a></span><span>            <span style=color:#5af78e>&#34;#v&#34;</span> <span style=color:#ff6ac1>=&gt;</span> <span style=color:#5af78e>&#34;Version&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-21-37><a style=outline:none;text-decoration:none;color:inherit href=#hl-21-37>37</a></span><span>          }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-21-38><a style=outline:none;text-decoration:none;color:inherit href=#hl-21-38>38</a></span><span>        }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-21-39><a style=outline:none;text-decoration:none;color:inherit href=#hl-21-39>39</a></span><span>      }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-21-40><a style=outline:none;text-decoration:none;color:inherit href=#hl-21-40>40</a></span><span>    <span style=color:#ff6ac1>end</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-21-41><a style=outline:none;text-decoration:none;color:inherit href=#hl-21-41>41</a></span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-21-42><a style=outline:none;text-decoration:none;color:inherit href=#hl-21-42>42</a></span><span>    <span style=color:#ff5c57>@dynamodb_client</span><span style=color:#ff6ac1>.</span>transact_write_items({<span style=color:#5af78e>transact_items</span>: put_operations})
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-21-43><a style=outline:none;text-decoration:none;color:inherit href=#hl-21-43>43</a></span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-21-44><a style=outline:none;text-decoration:none;color:inherit href=#hl-21-44>44</a></span><span>    <span style=color:#ff6ac1>nil</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-21-45><a style=outline:none;text-decoration:none;color:inherit href=#hl-21-45>45</a></span><span>  <span style=color:#ff6ac1>end</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-21-46><a style=outline:none;text-decoration:none;color:inherit href=#hl-21-46>46</a></span><span><span style=color:#ff6ac1>end</span>
</span></span></code></pre></div><p>Next, we&rsquo;ll use <em>Extract Class</em> refactoring once again to move data access into it&rsquo;s own class. Luckily for us, <em>querying</em> events is already isolated into it&rsquo;s own method.</p><div class=highlight><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-22-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-22-1> 1</a></span><span><span style=color:#ff6ac1>class</span> <span style=color:#f3f99d>EsDynamoTableClient</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-22-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-22-2> 2</a></span><span>  <span style=color:#ff6ac1>def</span> <span style=color:#57c7ff>initialize</span>(dynamodb_client, table_name)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-22-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-22-3> 3</a></span><span>    <span style=color:#ff5c57>@dynamodb_client</span> <span style=color:#ff6ac1>=</span> dynamodb_client
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-22-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-22-4> 4</a></span><span>    <span style=color:#ff5c57>@table_name</span> <span style=color:#ff6ac1>=</span> table_name
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-22-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-22-5> 5</a></span><span>  <span style=color:#ff6ac1>end</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-22-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-22-6> 6</a></span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-22-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-22-7> 7</a></span><span>  <span style=color:#ff6ac1>def</span> <span style=color:#57c7ff>fetch_aggregate_events</span>(aggregate_uuid)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-22-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-22-8> 8</a></span><span>    query_options <span style=color:#ff6ac1>=</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-22-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-22-9> 9</a></span><span>      <span style=color:#5af78e>table_name</span>: <span style=color:#ff5c57>@table_name</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-22-10><a style=outline:none;text-decoration:none;color:inherit href=#hl-22-10>10</a></span><span>      <span style=color:#5af78e>key_condition_expression</span>: <span style=color:#5af78e>&#34;AggregateUuid = :aggregate_uuid&#34;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-22-11><a style=outline:none;text-decoration:none;color:inherit href=#hl-22-11>11</a></span><span>      <span style=color:#5af78e>expression_attribute_values</span>: {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-22-12><a style=outline:none;text-decoration:none;color:inherit href=#hl-22-12>12</a></span><span>        <span style=color:#5af78e>&#34;:aggregate_uuid&#34;</span> <span style=color:#ff6ac1>=&gt;</span> aggregate_uuid,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-22-13><a style=outline:none;text-decoration:none;color:inherit href=#hl-22-13>13</a></span><span>      },
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-22-14><a style=outline:none;text-decoration:none;color:inherit href=#hl-22-14>14</a></span><span>      <span style=color:#5af78e>consistent_read</span>: <span style=color:#ff6ac1>true</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-22-15><a style=outline:none;text-decoration:none;color:inherit href=#hl-22-15>15</a></span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-22-16><a style=outline:none;text-decoration:none;color:inherit href=#hl-22-16>16</a></span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-22-17><a style=outline:none;text-decoration:none;color:inherit href=#hl-22-17>17</a></span><span>    items <span style=color:#ff6ac1>=</span> <span style=color:#ff6ac1>[]</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-22-18><a style=outline:none;text-decoration:none;color:inherit href=#hl-22-18>18</a></span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-22-19><a style=outline:none;text-decoration:none;color:inherit href=#hl-22-19>19</a></span><span>    result <span style=color:#ff6ac1>=</span> <span style=color:#ff5c57>@dynamodb_client</span><span style=color:#ff6ac1>.</span>query(query_options)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-22-20><a style=outline:none;text-decoration:none;color:inherit href=#hl-22-20>20</a></span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-22-21><a style=outline:none;text-decoration:none;color:inherit href=#hl-22-21>21</a></span><span>    <span style=color:#ff6ac1>loop</span> <span style=color:#ff6ac1>do</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-22-22><a style=outline:none;text-decoration:none;color:inherit href=#hl-22-22>22</a></span><span>      items <span style=color:#ff6ac1>&lt;&lt;</span> result<span style=color:#ff6ac1>.</span>items
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-22-23><a style=outline:none;text-decoration:none;color:inherit href=#hl-22-23>23</a></span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-22-24><a style=outline:none;text-decoration:none;color:inherit href=#hl-22-24>24</a></span><span>      <span style=color:#ff6ac1>break</span> <span style=color:#ff6ac1>unless</span> (last_evaluated_key <span style=color:#ff6ac1>=</span> result<span style=color:#ff6ac1>.</span>last_evaluated_key)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-22-25><a style=outline:none;text-decoration:none;color:inherit href=#hl-22-25>25</a></span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-22-26><a style=outline:none;text-decoration:none;color:inherit href=#hl-22-26>26</a></span><span>      result <span style=color:#ff6ac1>=</span> <span style=color:#ff5c57>@dynamodb_client</span><span style=color:#ff6ac1>.</span>query(query_options<span style=color:#ff6ac1>.</span>merge(<span style=color:#5af78e>exclusive_start_key</span>: last_evaluated_key))
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-22-27><a style=outline:none;text-decoration:none;color:inherit href=#hl-22-27>27</a></span><span>    <span style=color:#ff6ac1>end</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-22-28><a style=outline:none;text-decoration:none;color:inherit href=#hl-22-28>28</a></span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-22-29><a style=outline:none;text-decoration:none;color:inherit href=#hl-22-29>29</a></span><span>    items<span style=color:#ff6ac1>.</span>flatten
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-22-30><a style=outline:none;text-decoration:none;color:inherit href=#hl-22-30>30</a></span><span>  <span style=color:#ff6ac1>end</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-22-31><a style=outline:none;text-decoration:none;color:inherit href=#hl-22-31>31</a></span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-22-32><a style=outline:none;text-decoration:none;color:inherit href=#hl-22-32>32</a></span><span>  <span style=color:#ff6ac1>def</span> <span style=color:#57c7ff>insert_aggregate_events!</span>(events)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-22-33><a style=outline:none;text-decoration:none;color:inherit href=#hl-22-33>33</a></span><span>    put_operations <span style=color:#ff6ac1>=</span> events<span style=color:#ff6ac1>.</span>map <span style=color:#ff6ac1>do</span> <span style=color:#ff6ac1>|</span>event<span style=color:#ff6ac1>|</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-22-34><a style=outline:none;text-decoration:none;color:inherit href=#hl-22-34>34</a></span><span>      {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-22-35><a style=outline:none;text-decoration:none;color:inherit href=#hl-22-35>35</a></span><span>        <span style=color:#5af78e>put</span>: {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-22-36><a style=outline:none;text-decoration:none;color:inherit href=#hl-22-36>36</a></span><span>          <span style=color:#5af78e>item</span>: event,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-22-37><a style=outline:none;text-decoration:none;color:inherit href=#hl-22-37>37</a></span><span>          <span style=color:#5af78e>table_name</span>: <span style=color:#ff5c57>@table_name</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-22-38><a style=outline:none;text-decoration:none;color:inherit href=#hl-22-38>38</a></span><span>          <span style=color:#5af78e>condition_expression</span>: <span style=color:#5af78e>&#34;attribute_not_exists(#v)&#34;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-22-39><a style=outline:none;text-decoration:none;color:inherit href=#hl-22-39>39</a></span><span>          <span style=color:#5af78e>expression_attribute_names</span>: {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-22-40><a style=outline:none;text-decoration:none;color:inherit href=#hl-22-40>40</a></span><span>            <span style=color:#5af78e>&#34;#v&#34;</span> <span style=color:#ff6ac1>=&gt;</span> <span style=color:#5af78e>&#34;Version&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-22-41><a style=outline:none;text-decoration:none;color:inherit href=#hl-22-41>41</a></span><span>          }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-22-42><a style=outline:none;text-decoration:none;color:inherit href=#hl-22-42>42</a></span><span>        }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-22-43><a style=outline:none;text-decoration:none;color:inherit href=#hl-22-43>43</a></span><span>      }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-22-44><a style=outline:none;text-decoration:none;color:inherit href=#hl-22-44>44</a></span><span>    <span style=color:#ff6ac1>end</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-22-45><a style=outline:none;text-decoration:none;color:inherit href=#hl-22-45>45</a></span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-22-46><a style=outline:none;text-decoration:none;color:inherit href=#hl-22-46>46</a></span><span>    <span style=color:#ff5c57>@dynamodb_client</span><span style=color:#ff6ac1>.</span>transact_write_items({<span style=color:#5af78e>transact_items</span>: put_operations})
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-22-47><a style=outline:none;text-decoration:none;color:inherit href=#hl-22-47>47</a></span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-22-48><a style=outline:none;text-decoration:none;color:inherit href=#hl-22-48>48</a></span><span>    <span style=color:#ff6ac1>nil</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-22-49><a style=outline:none;text-decoration:none;color:inherit href=#hl-22-49>49</a></span><span>  <span style=color:#ff6ac1>end</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-22-50><a style=outline:none;text-decoration:none;color:inherit href=#hl-22-50>50</a></span><span><span style=color:#ff6ac1>end</span>
</span></span></code></pre></div><p>Now, our <code>ShoppingCartRepo</code> is looking much simpler.</p><div class=highlight><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-23-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-23-1> 1</a></span><span><span style=color:#ff6ac1>class</span> <span style=color:#f3f99d>ShoppingCartRepo</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-23-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-23-2> 2</a></span><span>  <span style=color:#ff6ac1>def</span> <span style=color:#57c7ff>initialize</span>(dynamodb_client, event_builder)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-23-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-23-3> 3</a></span><span>    <span style=color:#ff5c57>@dynamodb_client</span> <span style=color:#ff6ac1>=</span> dynamodb_client
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-23-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-23-4> 4</a></span><span>    <span style=color:#ff5c57>@event_builder</span> <span style=color:#ff6ac1>=</span> event_builder
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-23-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-23-5> 5</a></span><span>  <span style=color:#ff6ac1>end</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-23-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-23-6> 6</a></span><span>  
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-23-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-23-7> 7</a></span><span>  <span style=color:#ff6ac1>def</span> <span style=color:#57c7ff>fetch</span>(uuid)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-23-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-23-8> 8</a></span><span>    shopping_cart <span style=color:#ff6ac1>=</span> <span style=color:#ff9f43>ShoppingCart</span><span style=color:#ff6ac1>.</span>new
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-23-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-23-9> 9</a></span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-23-10><a style=outline:none;text-decoration:none;color:inherit href=#hl-23-10>10</a></span><span>    events <span style=color:#ff6ac1>=</span> <span style=color:#ff5c57>@dynamodb_client</span><span style=color:#ff6ac1>.</span>fetch_aggregate_events(uuid) <span style=color:#78787e># We call the new class explicitly</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-23-11><a style=outline:none;text-decoration:none;color:inherit href=#hl-23-11>11</a></span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-23-12><a style=outline:none;text-decoration:none;color:inherit href=#hl-23-12>12</a></span><span>    <span style=color:#ff6ac1>return</span> <span style=color:#ff6ac1>nil</span> <span style=color:#ff6ac1>if</span> events<span style=color:#ff6ac1>.</span>empty?
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-23-13><a style=outline:none;text-decoration:none;color:inherit href=#hl-23-13>13</a></span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-23-14><a style=outline:none;text-decoration:none;color:inherit href=#hl-23-14>14</a></span><span>    shopping_cart<span style=color:#ff6ac1>.</span>version <span style=color:#ff6ac1>=</span> events<span style=color:#ff6ac1>.</span>last<span style=color:#ff6ac1>.</span>fetch(<span style=color:#5af78e>&#34;Version&#34;</span>)<span style=color:#ff6ac1>.</span>to_i
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-23-15><a style=outline:none;text-decoration:none;color:inherit href=#hl-23-15>15</a></span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-23-16><a style=outline:none;text-decoration:none;color:inherit href=#hl-23-16>16</a></span><span>    events
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-23-17><a style=outline:none;text-decoration:none;color:inherit href=#hl-23-17>17</a></span><span>      <span style=color:#ff6ac1>.</span>map { <span style=color:#ff6ac1>|</span>event<span style=color:#ff6ac1>|</span> build_event(event) }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-23-18><a style=outline:none;text-decoration:none;color:inherit href=#hl-23-18>18</a></span><span>      <span style=color:#ff6ac1>.</span>reject(<span style=color:#ff6ac1>&amp;</span><span style=color:#5af78e>:nil?</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-23-19><a style=outline:none;text-decoration:none;color:inherit href=#hl-23-19>19</a></span><span>      <span style=color:#ff6ac1>.</span>each { <span style=color:#ff6ac1>|</span>event<span style=color:#ff6ac1>|</span> shopping_cart<span style=color:#ff6ac1>.</span>apply(event) }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-23-20><a style=outline:none;text-decoration:none;color:inherit href=#hl-23-20>20</a></span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-23-21><a style=outline:none;text-decoration:none;color:inherit href=#hl-23-21>21</a></span><span>    <span style=color:#ff6ac1>if</span> shopping_cart<span style=color:#ff6ac1>.</span>uuid<span style=color:#ff6ac1>.</span>nil?
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-23-22><a style=outline:none;text-decoration:none;color:inherit href=#hl-23-22>22</a></span><span>      <span style=color:#ff6ac1>nil</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-23-23><a style=outline:none;text-decoration:none;color:inherit href=#hl-23-23>23</a></span><span>    <span style=color:#ff6ac1>else</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-23-24><a style=outline:none;text-decoration:none;color:inherit href=#hl-23-24>24</a></span><span>      shopping_cart
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-23-25><a style=outline:none;text-decoration:none;color:inherit href=#hl-23-25>25</a></span><span>    <span style=color:#ff6ac1>end</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-23-26><a style=outline:none;text-decoration:none;color:inherit href=#hl-23-26>26</a></span><span>  <span style=color:#ff6ac1>end</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-23-27><a style=outline:none;text-decoration:none;color:inherit href=#hl-23-27>27</a></span><span>  
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-23-28><a style=outline:none;text-decoration:none;color:inherit href=#hl-23-28>28</a></span><span>  <span style=color:#ff6ac1>def</span> <span style=color:#57c7ff>store</span>(shopping_cart)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-23-29><a style=outline:none;text-decoration:none;color:inherit href=#hl-23-29>29</a></span><span>    new_version <span style=color:#ff6ac1>=</span> shopping_cart<span style=color:#ff6ac1>.</span>version 
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-23-30><a style=outline:none;text-decoration:none;color:inherit href=#hl-23-30>30</a></span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-23-31><a style=outline:none;text-decoration:none;color:inherit href=#hl-23-31>31</a></span><span>    new_events <span style=color:#ff6ac1>=</span> shopping_cart<span style=color:#ff6ac1>.</span>changes<span style=color:#ff6ac1>.</span>map <span style=color:#ff6ac1>do</span> <span style=color:#ff6ac1>|</span>event<span style=color:#ff6ac1>|</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-23-32><a style=outline:none;text-decoration:none;color:inherit href=#hl-23-32>32</a></span><span>      new_version <span style=color:#ff6ac1>=</span> new_version <span style=color:#ff6ac1>+</span> <span style=color:#ff9f43>1</span> 
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-23-33><a style=outline:none;text-decoration:none;color:inherit href=#hl-23-33>33</a></span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-23-34><a style=outline:none;text-decoration:none;color:inherit href=#hl-23-34>34</a></span><span>      {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-23-35><a style=outline:none;text-decoration:none;color:inherit href=#hl-23-35>35</a></span><span>        <span style=color:#5af78e>EventUuid</span>: <span style=color:#ff9f43>SecureRandom</span><span style=color:#ff6ac1>.</span>uuid,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-23-36><a style=outline:none;text-decoration:none;color:inherit href=#hl-23-36>36</a></span><span>        <span style=color:#5af78e>AggregateUuid</span>: shopping_cart<span style=color:#ff6ac1>.</span>uuid,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-23-37><a style=outline:none;text-decoration:none;color:inherit href=#hl-23-37>37</a></span><span>        <span style=color:#5af78e>Name</span>: event<span style=color:#ff6ac1>.</span>class<span style=color:#ff6ac1>::</span><span style=color:#ff9f43>NAME</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-23-38><a style=outline:none;text-decoration:none;color:inherit href=#hl-23-38>38</a></span><span>        <span style=color:#5af78e>Data</span>: event<span style=color:#ff6ac1>.</span>to_h,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-23-39><a style=outline:none;text-decoration:none;color:inherit href=#hl-23-39>39</a></span><span>        <span style=color:#5af78e>Version</span>: new_version
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-23-40><a style=outline:none;text-decoration:none;color:inherit href=#hl-23-40>40</a></span><span>      }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-23-41><a style=outline:none;text-decoration:none;color:inherit href=#hl-23-41>41</a></span><span>    <span style=color:#ff6ac1>end</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-23-42><a style=outline:none;text-decoration:none;color:inherit href=#hl-23-42>42</a></span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-23-43><a style=outline:none;text-decoration:none;color:inherit href=#hl-23-43>43</a></span><span>    <span style=color:#ff5c57>@dynamodb_client</span><span style=color:#ff6ac1>.</span>insert_aggregate_events!(new_events) <span style=color:#78787e># We call the new class explicitly</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-23-44><a style=outline:none;text-decoration:none;color:inherit href=#hl-23-44>44</a></span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-23-45><a style=outline:none;text-decoration:none;color:inherit href=#hl-23-45>45</a></span><span>    shopping_cart<span style=color:#ff6ac1>.</span>clear_changes
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-23-46><a style=outline:none;text-decoration:none;color:inherit href=#hl-23-46>46</a></span><span>    shopping_cart<span style=color:#ff6ac1>.</span>version <span style=color:#ff6ac1>=</span> new_version
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-23-47><a style=outline:none;text-decoration:none;color:inherit href=#hl-23-47>47</a></span><span>    shopping_cart
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-23-48><a style=outline:none;text-decoration:none;color:inherit href=#hl-23-48>48</a></span><span>  <span style=color:#ff6ac1>end</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-23-49><a style=outline:none;text-decoration:none;color:inherit href=#hl-23-49>49</a></span><span>  
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-23-50><a style=outline:none;text-decoration:none;color:inherit href=#hl-23-50>50</a></span><span>  <span style=color:#78787e># ...</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-23-51><a style=outline:none;text-decoration:none;color:inherit href=#hl-23-51>51</a></span><span><span style=color:#ff6ac1>end</span>
</span></span></code></pre></div><h4 id=dynamodbrepo-parent-class>DynamoDBRepo Parent Class</h4><p>Future aggregate repos will benefit from an existing class which implements aggregate rehydration and storing behaviours.</p><p>First, we&rsquo;ll define our new parent class and inherit it from <code>ShoppingCartRepo</code> class.</p><div class=highlight><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-24-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-24-1>1</a></span><span><span style=color:#ff6ac1>class</span> <span style=color:#f3f99d>DynamoDBRepo</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-24-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-24-2>2</a></span><span>  <span style=color:#ff6ac1>def</span> <span style=color:#57c7ff>initialize</span>(dynamodb_client)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-24-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-24-3>3</a></span><span>    <span style=color:#ff5c57>@dynamodb_client</span> <span style=color:#ff6ac1>=</span> dynamodb_client
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-24-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-24-4>4</a></span><span>  <span style=color:#ff6ac1>end</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-24-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-24-5>5</a></span><span><span style=color:#ff6ac1>end</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-24-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-24-6>6</a></span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-24-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-24-7>7</a></span><span><span style=color:#ff6ac1>class</span> <span style=color:#f3f99d>ShoppingCartRepo</span> <span style=color:#ff6ac1>&lt;</span> <span style=color:#ff9f43>DynamoDBRepo</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-24-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-24-8>8</a></span><span>  <span style=color:#78787e># ...</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-24-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-24-9>9</a></span><span><span style=color:#ff6ac1>end</span>
</span></span></code></pre></div><p>Then, using the <em><a href=https://refactoring.com/catalog/pullUpMethod.html>Pull Up Method</a></em> refactoring, we&rsquo;ll move <code>fetch</code> and <code>store</code> into the parent class.</p><div class=highlight><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-25-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-25-1> 1</a></span><span><span style=color:#ff6ac1>class</span> <span style=color:#f3f99d>DynamoDBRepo</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-25-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-25-2> 2</a></span><span>  <span style=color:#ff6ac1>def</span> <span style=color:#57c7ff>initialize</span>(dynamodb_client, event_builder)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-25-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-25-3> 3</a></span><span>    <span style=color:#ff5c57>@dynamodb_client</span> <span style=color:#ff6ac1>=</span> dynamodb_client
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-25-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-25-4> 4</a></span><span>    <span style=color:#ff5c57>@event_builder</span> <span style=color:#ff6ac1>=</span> event_builder
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-25-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-25-5> 5</a></span><span>  <span style=color:#ff6ac1>end</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-25-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-25-6> 6</a></span><span>  
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-25-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-25-7> 7</a></span><span>  <span style=color:#ff6ac1>def</span> <span style=color:#57c7ff>fetch</span>(uuid)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-25-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-25-8> 8</a></span><span>    shopping_cart <span style=color:#ff6ac1>=</span> <span style=color:#ff9f43>ShoppingCart</span><span style=color:#ff6ac1>.</span>new
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-25-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-25-9> 9</a></span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-25-10><a style=outline:none;text-decoration:none;color:inherit href=#hl-25-10>10</a></span><span>    events <span style=color:#ff6ac1>=</span> <span style=color:#ff5c57>@dynamodb_client</span><span style=color:#ff6ac1>.</span>fetch_aggregate_events(uuid) <span style=color:#78787e># We call the new class explicitly</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-25-11><a style=outline:none;text-decoration:none;color:inherit href=#hl-25-11>11</a></span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-25-12><a style=outline:none;text-decoration:none;color:inherit href=#hl-25-12>12</a></span><span>    <span style=color:#ff6ac1>return</span> <span style=color:#ff6ac1>nil</span> <span style=color:#ff6ac1>if</span> events<span style=color:#ff6ac1>.</span>empty?
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-25-13><a style=outline:none;text-decoration:none;color:inherit href=#hl-25-13>13</a></span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-25-14><a style=outline:none;text-decoration:none;color:inherit href=#hl-25-14>14</a></span><span>    shopping_cart<span style=color:#ff6ac1>.</span>version <span style=color:#ff6ac1>=</span> events<span style=color:#ff6ac1>.</span>last<span style=color:#ff6ac1>.</span>fetch(<span style=color:#5af78e>&#34;Version&#34;</span>)<span style=color:#ff6ac1>.</span>to_i
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-25-15><a style=outline:none;text-decoration:none;color:inherit href=#hl-25-15>15</a></span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-25-16><a style=outline:none;text-decoration:none;color:inherit href=#hl-25-16>16</a></span><span>    events
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-25-17><a style=outline:none;text-decoration:none;color:inherit href=#hl-25-17>17</a></span><span>      <span style=color:#ff6ac1>.</span>map { <span style=color:#ff6ac1>|</span>event<span style=color:#ff6ac1>|</span> build_event(event) }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-25-18><a style=outline:none;text-decoration:none;color:inherit href=#hl-25-18>18</a></span><span>      <span style=color:#ff6ac1>.</span>reject(<span style=color:#ff6ac1>&amp;</span><span style=color:#5af78e>:nil?</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-25-19><a style=outline:none;text-decoration:none;color:inherit href=#hl-25-19>19</a></span><span>      <span style=color:#ff6ac1>.</span>each { <span style=color:#ff6ac1>|</span>event<span style=color:#ff6ac1>|</span> shopping_cart<span style=color:#ff6ac1>.</span>apply(event) }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-25-20><a style=outline:none;text-decoration:none;color:inherit href=#hl-25-20>20</a></span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-25-21><a style=outline:none;text-decoration:none;color:inherit href=#hl-25-21>21</a></span><span>    <span style=color:#ff6ac1>if</span> shopping_cart<span style=color:#ff6ac1>.</span>uuid<span style=color:#ff6ac1>.</span>nil?
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-25-22><a style=outline:none;text-decoration:none;color:inherit href=#hl-25-22>22</a></span><span>      <span style=color:#ff6ac1>nil</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-25-23><a style=outline:none;text-decoration:none;color:inherit href=#hl-25-23>23</a></span><span>    <span style=color:#ff6ac1>else</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-25-24><a style=outline:none;text-decoration:none;color:inherit href=#hl-25-24>24</a></span><span>      shopping_cart
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-25-25><a style=outline:none;text-decoration:none;color:inherit href=#hl-25-25>25</a></span><span>    <span style=color:#ff6ac1>end</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-25-26><a style=outline:none;text-decoration:none;color:inherit href=#hl-25-26>26</a></span><span>  <span style=color:#ff6ac1>end</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-25-27><a style=outline:none;text-decoration:none;color:inherit href=#hl-25-27>27</a></span><span>  
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-25-28><a style=outline:none;text-decoration:none;color:inherit href=#hl-25-28>28</a></span><span>  <span style=color:#ff6ac1>def</span> <span style=color:#57c7ff>store</span>(shopping_cart)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-25-29><a style=outline:none;text-decoration:none;color:inherit href=#hl-25-29>29</a></span><span>    new_version <span style=color:#ff6ac1>=</span> shopping_cart<span style=color:#ff6ac1>.</span>version 
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-25-30><a style=outline:none;text-decoration:none;color:inherit href=#hl-25-30>30</a></span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-25-31><a style=outline:none;text-decoration:none;color:inherit href=#hl-25-31>31</a></span><span>    new_events <span style=color:#ff6ac1>=</span> shopping_cart<span style=color:#ff6ac1>.</span>changes<span style=color:#ff6ac1>.</span>map <span style=color:#ff6ac1>do</span> <span style=color:#ff6ac1>|</span>event<span style=color:#ff6ac1>|</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-25-32><a style=outline:none;text-decoration:none;color:inherit href=#hl-25-32>32</a></span><span>      new_version <span style=color:#ff6ac1>=</span> new_version <span style=color:#ff6ac1>+</span> <span style=color:#ff9f43>1</span> 
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-25-33><a style=outline:none;text-decoration:none;color:inherit href=#hl-25-33>33</a></span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-25-34><a style=outline:none;text-decoration:none;color:inherit href=#hl-25-34>34</a></span><span>      {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-25-35><a style=outline:none;text-decoration:none;color:inherit href=#hl-25-35>35</a></span><span>        <span style=color:#5af78e>EventUuid</span>: <span style=color:#ff9f43>SecureRandom</span><span style=color:#ff6ac1>.</span>uuid,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-25-36><a style=outline:none;text-decoration:none;color:inherit href=#hl-25-36>36</a></span><span>        <span style=color:#5af78e>AggregateUuid</span>: shopping_cart<span style=color:#ff6ac1>.</span>uuid,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-25-37><a style=outline:none;text-decoration:none;color:inherit href=#hl-25-37>37</a></span><span>        <span style=color:#5af78e>Name</span>: event<span style=color:#ff6ac1>.</span>class<span style=color:#ff6ac1>::</span><span style=color:#ff9f43>NAME</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-25-38><a style=outline:none;text-decoration:none;color:inherit href=#hl-25-38>38</a></span><span>        <span style=color:#5af78e>Data</span>: event<span style=color:#ff6ac1>.</span>to_h,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-25-39><a style=outline:none;text-decoration:none;color:inherit href=#hl-25-39>39</a></span><span>        <span style=color:#5af78e>Version</span>: new_version
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-25-40><a style=outline:none;text-decoration:none;color:inherit href=#hl-25-40>40</a></span><span>      }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-25-41><a style=outline:none;text-decoration:none;color:inherit href=#hl-25-41>41</a></span><span>    <span style=color:#ff6ac1>end</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-25-42><a style=outline:none;text-decoration:none;color:inherit href=#hl-25-42>42</a></span><span>  <span style=color:#ff6ac1>end</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-25-43><a style=outline:none;text-decoration:none;color:inherit href=#hl-25-43>43</a></span><span><span style=color:#ff6ac1>end</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-25-44><a style=outline:none;text-decoration:none;color:inherit href=#hl-25-44>44</a></span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-25-45><a style=outline:none;text-decoration:none;color:inherit href=#hl-25-45>45</a></span><span><span style=color:#ff6ac1>class</span> <span style=color:#f3f99d>ShoppingCartRepo</span> <span style=color:#ff6ac1>&lt;</span> <span style=color:#ff9f43>DynamoDBRepo</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-25-46><a style=outline:none;text-decoration:none;color:inherit href=#hl-25-46>46</a></span><span>  <span style=color:#78787e># Now an EmptyClass</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-25-47><a style=outline:none;text-decoration:none;color:inherit href=#hl-25-47>47</a></span><span><span style=color:#ff6ac1>end</span>
</span></span></code></pre></div><p>There is one last thing alteration that is necessary to make. <code>DynamoDBRepo</code> class still references the <code>ShoppingCart</code> aggregate.</p><p>We can fix this with a little bit of meta-programming by making the <code>ShoppingCart</code> class tell it&rsquo;s parent what sort of aggregate it needs.</p><div class=highlight><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-26-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-26-1> 1</a></span><span><span style=color:#ff6ac1>class</span> <span style=color:#f3f99d>DynamoDBRepo</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-26-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-26-2> 2</a></span><span>  <span style=color:#ff6ac1>class</span> <span style=color:#f3f99d>AggregateClassUndefined</span> <span style=color:#ff6ac1>&lt;</span> <span style=color:#ff9f43>StandardError</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-26-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-26-3> 3</a></span><span>    <span style=color:#ff6ac1>def</span> <span style=color:#57c7ff>message</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-26-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-26-4> 4</a></span><span>      <span style=color:#5af78e>&#34;Aggregate class is not defined&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-26-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-26-5> 5</a></span><span>    <span style=color:#ff6ac1>end</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-26-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-26-6> 6</a></span><span>  <span style=color:#ff6ac1>end</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-26-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-26-7> 7</a></span><span>  
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-26-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-26-8> 8</a></span><span>  <span style=color:#ff5c57>@aggregate_class</span> <span style=color:#ff6ac1>=</span> <span style=color:#ff6ac1>nil</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-26-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-26-9> 9</a></span><span>  
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-26-10><a style=outline:none;text-decoration:none;color:inherit href=#hl-26-10>10</a></span><span>  <span style=color:#ff6ac1>def</span> <span style=color:#57c7ff>initialize</span>(dynamodb_client, event_builder)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-26-11><a style=outline:none;text-decoration:none;color:inherit href=#hl-26-11>11</a></span><span>    <span style=color:#ff5c57>@dynamodb_client</span> <span style=color:#ff6ac1>=</span> dynamodb_client
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-26-12><a style=outline:none;text-decoration:none;color:inherit href=#hl-26-12>12</a></span><span>    <span style=color:#ff5c57>@event_builder</span> <span style=color:#ff6ac1>=</span> event_builder
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-26-13><a style=outline:none;text-decoration:none;color:inherit href=#hl-26-13>13</a></span><span>    
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-26-14><a style=outline:none;text-decoration:none;color:inherit href=#hl-26-14>14</a></span><span>    <span style=color:#ff6ac1>raise</span> <span style=color:#ff9f43>AggregateClassUndefined</span> <span style=color:#ff6ac1>if</span> aggregate_class<span style=color:#ff6ac1>.</span>nil?
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-26-15><a style=outline:none;text-decoration:none;color:inherit href=#hl-26-15>15</a></span><span>  <span style=color:#ff6ac1>end</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-26-16><a style=outline:none;text-decoration:none;color:inherit href=#hl-26-16>16</a></span><span>  
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-26-17><a style=outline:none;text-decoration:none;color:inherit href=#hl-26-17>17</a></span><span>  <span style=color:#ff6ac1>def</span> <span style=color:#f3f99d>self</span><span style=color:#ff6ac1>.</span><span style=color:#57c7ff>aggregate</span>(aggregate_class)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-26-18><a style=outline:none;text-decoration:none;color:inherit href=#hl-26-18>18</a></span><span>    <span style=color:#ff5c57>@aggregate_class</span> <span style=color:#ff6ac1>=</span> aggregate_class
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-26-19><a style=outline:none;text-decoration:none;color:inherit href=#hl-26-19>19</a></span><span>  <span style=color:#ff6ac1>end</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-26-20><a style=outline:none;text-decoration:none;color:inherit href=#hl-26-20>20</a></span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-26-21><a style=outline:none;text-decoration:none;color:inherit href=#hl-26-21>21</a></span><span>  <span style=color:#ff6ac1>def</span> <span style=color:#f3f99d>self</span><span style=color:#ff6ac1>.</span><span style=color:#57c7ff>aggregate_class</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-26-22><a style=outline:none;text-decoration:none;color:inherit href=#hl-26-22>22</a></span><span>    <span style=color:#ff5c57>@aggregate_class</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-26-23><a style=outline:none;text-decoration:none;color:inherit href=#hl-26-23>23</a></span><span>  <span style=color:#ff6ac1>end</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-26-24><a style=outline:none;text-decoration:none;color:inherit href=#hl-26-24>24</a></span><span>  
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-26-25><a style=outline:none;text-decoration:none;color:inherit href=#hl-26-25>25</a></span><span>  <span style=color:#78787e># ...</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-26-26><a style=outline:none;text-decoration:none;color:inherit href=#hl-26-26>26</a></span><span>  
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-26-27><a style=outline:none;text-decoration:none;color:inherit href=#hl-26-27>27</a></span><span>  <span style=color:#ff6ac1>private</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-26-28><a style=outline:none;text-decoration:none;color:inherit href=#hl-26-28>28</a></span><span>  
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-26-29><a style=outline:none;text-decoration:none;color:inherit href=#hl-26-29>29</a></span><span>  <span style=color:#ff6ac1>def</span> <span style=color:#57c7ff>aggregate_class</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-26-30><a style=outline:none;text-decoration:none;color:inherit href=#hl-26-30>30</a></span><span>    <span style=color:#ff5c57>self</span><span style=color:#ff6ac1>.</span>class<span style=color:#ff6ac1>.</span>aggregate_class
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-26-31><a style=outline:none;text-decoration:none;color:inherit href=#hl-26-31>31</a></span><span>  <span style=color:#ff6ac1>end</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-26-32><a style=outline:none;text-decoration:none;color:inherit href=#hl-26-32>32</a></span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-26-33><a style=outline:none;text-decoration:none;color:inherit href=#hl-26-33>33</a></span><span>  <span style=color:#ff6ac1>def</span> <span style=color:#57c7ff>event_builder_module</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-26-34><a style=outline:none;text-decoration:none;color:inherit href=#hl-26-34>34</a></span><span>    <span style=color:#ff5c57>self</span><span style=color:#ff6ac1>.</span>class<span style=color:#ff6ac1>.</span>event_builder_module
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-26-35><a style=outline:none;text-decoration:none;color:inherit href=#hl-26-35>35</a></span><span>  <span style=color:#ff6ac1>end</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-26-36><a style=outline:none;text-decoration:none;color:inherit href=#hl-26-36>36</a></span><span><span style=color:#ff6ac1>end</span>
</span></span></code></pre></div><p>Now we may configure our repository by specificying it should persist and build <code>ShoppingCart</code> aggregates.</p><div class=highlight><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-27-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-27-1>1</a></span><span><span style=color:#ff6ac1>class</span> <span style=color:#f3f99d>ShoppingCartRepo</span> <span style=color:#ff6ac1>&lt;</span> <span style=color:#ff9f43>DynamoDBRepo</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-27-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-27-2>2</a></span><span>  aggregate <span style=color:#ff9f43>ShoppingCart</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-27-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-27-3>3</a></span><span><span style=color:#ff6ac1>end</span>
</span></span></code></pre></div><p>Personally, I believe the same behaviour should be used for the <code>EventBuilder</code> class as well.</p><p>By using the <em><a href=https://refactoring.com/catalog/pushDownField.html>Pull Down Field</a></em> refactoring, we can acheive the same result. I&rsquo;ll omit the details from here, as we&rsquo;ll conclude with a breif overview momentarily.</p><div class=highlight><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-28-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-28-1>1</a></span><span><span style=color:#ff6ac1>class</span> <span style=color:#f3f99d>ShoppingCartRepo</span> <span style=color:#ff6ac1>&lt;</span> <span style=color:#ff9f43>DynamoDBRepo</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-28-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-28-2>2</a></span><span>  aggregate <span style=color:#ff9f43>ShoppingCart</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-28-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-28-3>3</a></span><span>  event_builder <span style=color:#ff9f43>Events</span><span style=color:#ff6ac1>::</span><span style=color:#ff9f43>Builder</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-28-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-28-4>4</a></span><span><span style=color:#ff6ac1>end</span>
</span></span></code></pre></div><h3 id=refactoring-conclusion>Refactoring Conclusion</h3><p>This style of refactoring invovles making smaller adjustments that marginally improves a problem. It favors small consistent wins over large - and possibly dangerous - restructorings.</p><p>Quite a few changes were presented with omitted code blocks. For a full capture of the <code>ShoppingCartRepo</code>, <code>DynamoDBRepo</code>, and <code>EsDynamoTableClient</code> classes, you may view them over this <a href=https://gist.github.com/APiercey/2960739a7ec3bd2bfdfdc4cc557d42d6>GitHub Gist</a>.</p><h2 id=test-run>Test Run</h2><p>Let&rsquo;s take our new repository for a spin.</p><div class=highlight><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-29-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-29-1> 1</a></span><span><span style=color:#ff5c57>require</span> <span style=color:#5af78e>&#39;aws-sdk-dynamodb&#39;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-29-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-29-2> 2</a></span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-29-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-29-3> 3</a></span><span><span style=color:#78787e># DynamoDB Client</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-29-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-29-4> 4</a></span><span>dynamo_db_client <span style=color:#ff6ac1>=</span> <span style=color:#ff9f43>EsDynamoTableClient</span><span style=color:#ff6ac1>.</span>new(<span style=color:#ff9f43>Aws</span><span style=color:#ff6ac1>::</span><span style=color:#ff9f43>DynamoDB</span><span style=color:#ff6ac1>::</span><span style=color:#ff9f43>Client</span><span style=color:#ff6ac1>.</span>new, <span style=color:#5af78e>&#34;scd-es-table&#34;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-29-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-29-5> 5</a></span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-29-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-29-6> 6</a></span><span><span style=color:#78787e># ShoppingCartRepo</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-29-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-29-7> 7</a></span><span>shopping_cart_repo <span style=color:#ff6ac1>=</span> <span style=color:#ff9f43>ShoppingCartRepo</span><span style=color:#ff6ac1>.</span>new(dynamo_db_client)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-29-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-29-8> 8</a></span><span>  
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-29-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-29-9> 9</a></span><span>shopping_cart <span style=color:#ff6ac1>=</span> <span style=color:#ff9f43>ShoppingCart</span><span style=color:#ff6ac1>.</span>new(<span style=color:#5af78e>&#34;test-uuid&#34;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-29-10><a style=outline:none;text-decoration:none;color:inherit href=#hl-29-10>10</a></span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-29-11><a style=outline:none;text-decoration:none;color:inherit href=#hl-29-11>11</a></span><span>shopping_cart<span style=color:#ff6ac1>.</span>add_item(<span style=color:#5af78e>&#34;apiercey.github.io subscription&#34;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-29-12><a style=outline:none;text-decoration:none;color:inherit href=#hl-29-12>12</a></span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-29-13><a style=outline:none;text-decoration:none;color:inherit href=#hl-29-13>13</a></span><span><span style=color:#78787e># There should now be two events in @changes</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-29-14><a style=outline:none;text-decoration:none;color:inherit href=#hl-29-14>14</a></span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-29-15><a style=outline:none;text-decoration:none;color:inherit href=#hl-29-15>15</a></span><span><span style=color:#ff5c57>puts</span> shopping_cart<span style=color:#ff6ac1>.</span>inspect
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-29-16><a style=outline:none;text-decoration:none;color:inherit href=#hl-29-16>16</a></span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-29-17><a style=outline:none;text-decoration:none;color:inherit href=#hl-29-17>17</a></span><span>shopping_cart_repo<span style=color:#ff6ac1>.</span>store(shopping_cart)
</span></span></code></pre></div><p>Taking a peak into our DynamoDb table, we see the record there, with the set of changes as events.</p><p><img src=/images/aws-eventsourcing/inspect-dynamo-db.png alt="Inspecting dynamodb"></p><p>We can fetch the same shopping cart and inspect it&rsquo;s state.</p><div class=highlight><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-30-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-30-1>1</a></span><span>rehydrated_shopping_cart <span style=color:#ff6ac1>=</span> shopping_cart_repo<span style=color:#ff6ac1>.</span>fetch(<span style=color:#5af78e>&#34;test-uuid&#34;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-30-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-30-2>2</a></span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-30-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-30-3>3</a></span><span>rehydrated_shopping_cart<span style=color:#ff6ac1>.</span>inspect
</span></span></code></pre></div><p><code>inspect</code>ing the object should show us a complete <code>ShoppingCart</code> with a <code>uuid</code> and an <code>item</code>.</p><p><img src=/images/aws-eventsourcing/inspect-shopping-cart.png alt="Inspecting shopping cart"></p><h2 id=conclusion>Conclusion</h2><p>We&rsquo;ve brought our Aggregates full circle and can now create them and rehdrate them for future use. We&rsquo;ve done so be leveraging DynamoDB.</p><p>Additionally, we saw how we can refactoring complex classes to become gradually more simple.</p><p>The full code for part three of our event sourcing application can be found here: <a href=https://github.com/APiercey/aws-serverless-event-sourcing/tree/part-three-aggregate-persistence>https://github.com/APiercey/aws-serverless-event-sourcing/tree/part-three-aggregate-persistence</a></p><p>Next, we will take the first step into building event handlers for these events using <em>Change Data Capture</em>. We&rsquo;ll accomplish this using DynamoDB Streams, Lambda, and Kinesis!</p></div><br><div class=comments><script src=https://utteranc.es/client.js repo=APiercey/utterances issue-number=1 label=utterances theme=github-light crossorigin=anonymous async></script></div></div><div class=footer><div class=footer-social><span class="social-icon social-icon-github"><a href=https://github.com/apiercey title=github target=_blank rel=noopener><img src=/images/social/github.svg width=24 height=24 alt=github></a></span>
<span class="social-icon social-icon-linkedin"><a href=https://www.linkedin.com/in/alexander-butt-piercey title=linkedin target=_blank rel=noopener><img src=/images/social/linkedin.svg width=24 height=24 alt=linkedin></a></span>
<span class="social-icon social-icon-twitter"><a href=https://twitter.com/programincolour title=twitter target=_blank rel=noopener><img src=/images/social/twitter.svg width=24 height=24 alt=twitter></a></span></div></div></div><script type=text/javascript src=/js/bundle.min.28d149c65e8b43f935b5da6797544f9e363170785f466641db0d007cee894169.js></script>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-CX84WRHVTJ"></script>
<script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-CX84WRHVTJ")</script></body></html>