<!doctype html><html lang=en><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="ie=edge"><title>Event Sourcing with Ruby and AWS Serverless Technologies - Part Three: Aggregate Persistence - apiercey.github.io</title><meta name=viewport content="width=device-width,initial-scale=1"><link rel=icon href=https://apiercey.github.io/favicon.png><meta name=google-site-verification content="NumVaC4w3L9xrwd7wA91DomOegJLYQ-jIhXhWmK7Yd0"><meta name=robots content="index,follow"><link rel=stylesheet href=/css/style.min.b5158346cd0be7c685bb4907526f1b697a94560681b975b89e813e6095001706.css><meta name=description content="Building an Event-Sourced application in Ruby using Lambda, DynamoDB, Kinesis, S3, and Terraform"><meta property="og:title" content="Event Sourcing with Ruby and AWS Serverless Technologies - Part Three: Aggregate Persistence"><meta property="og:type" content="website"><meta property="og:url" content="https://apiercey.github.io/posts/event-sourcing-using-ruby-and-aws-serverless-technologies/aggregate-persistence/"><meta property="og:image" content="https://apiercey.github.io/images/event-sourcing.jpg"><meta property="og:description" content="Building an Event-Sourced application in Ruby using Lambda, DynamoDB, Kinesis, S3, and Terraform"><meta name=twitter:card content="summary"><meta name=twitter:site content="@programincolour"><meta name=twitter:creator content="@programincolour"><link rel=preconnect href=https://fonts.gstatic.com><link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;700&display=swap" rel=stylesheet></head><body class='page page-blog-single'><div id=menu-main-mobile class=menu-main-mobile><ul class=menu><li class=menu-item-about><a href=https://apiercey.github.io/pages/about/>About</a></li><li class=menu-item-blog><a href=https://apiercey.github.io/posts/>Blog</a></li><li class=menu-item-projects><a href=https://apiercey.github.io/projects/>Projects</a></li><li class=menu-item-articles><a href=https://apiercey.github.io/articles/>Articles</a></li></ul></div><div id=wrapper class=wrapper><div class=header><a class=header-logo href=/>apiercey.github.io</a><div class=menu-main><ul><li class=menu-item-about><a href=/pages/about/><span>About</span></a></li><li class="menu-item-blog active"><a href=/posts/><span>Blog</span></a></li><li class=menu-item-projects><a href=/projects/><span>Projects</span></a></li><li class=menu-item-articles><a href=/articles/><span>Articles</span></a></li></ul></div><div id=toggle-menu-main-mobile class=hamburger-trigger><button class=hamburger>Menu</button></div></div><div class=blog><div class=intro><h1>Event Sourcing with Ruby and AWS Serverless Technologies - Part Three: Aggregate Persistence<span class=dot>.</span></h1><img src=/images/event-sourcing.jpg></div><div class=content><aside><h2>Table of Contents</h2><nav id=TableOfContents><ul><li><a href=#todo-add-improving-usage-of-technologies-at-the-end-of-every-chapter>TODO: Add Improving usage of technologies at the end of every chapter</a></li></ul><ul><li><a href=#dynamodb-tables>DynamoDB Tables</a></li><li><a href=#shoppingcart-table-in-terraform>ShoppingCart Table in Terraform</a><ul><li><a href=#defining-the-module>Defining the Module</a></li></ul></li><li><a href=#shoppingcart-repository>ShoppingCart Repository</a><ul><li><a href=#about-the-repository-pattern>About the Repository Pattern</a></li><li><a href=#repository-outline>Repository Outline</a></li><li><a href=#store-method>Store Method</a></li><li><a href=#fetch-method>Fetch Method</a></li></ul></li><li><a href=#small-cleanup>Small Cleanup</a></li><li><a href=#conclusion>Conclusion</a></li></ul></nav></aside><h2 id=todo-add-improving-usage-of-technologies-at-the-end-of-every-chapter>TODO: Add Improving usage of technologies at the end of every chapter</h2><ul><li>At this time of writing, AWS only supports Ruby 2.7 natively. So we wont use fancy new 3.x features</li></ul><h1 id=aggregate-persistence>Aggregate Persistence</h1><ul><li><input checked disabled type=checkbox> Basic DynamoDB table<ul><li><input checked disabled type=checkbox> None of the Event CDC stuff</li><li><input checked disabled type=checkbox> Basic UUID</li><li><input disabled type=checkbox> Include some additional Cloudwatch stuff</li></ul></li><li>Ruby implementation of Repo</li><li><input checked disabled type=checkbox> only has two methods</li><li><input disabled type=checkbox> Designed to handle the <em>write</em> nature of business requirements and not the read</li><li><input checked disabled type=checkbox> Fetch method implementation</li><li><input checked disabled type=checkbox> Store method implementation</li><li><input checked disabled type=checkbox> Implement ShoppingCartRepo</li><li><input disabled type=checkbox> At this time of writing, AWS only supports Ruby 2.7 natively. So we wont use fancy new 3.x features</li><li><input checked disabled type=checkbox> Demonstrate Rebhydrating aggregates</li></ul><h1 id=aggregate-persistence-1>Aggregate Persistence</h1><ul><li>Basic DynamoDB table<ul><li>None of the Event CDC stuff</li><li>Basic UUID</li><li>Include some additional Cloudwatch stuff</li></ul></li><li>Ruby implementation of Repo</li><li>only has two methods</li><li>Designed to handle the <em>write</em> nature of business requirements and not the read</li><li>Fetch method implementation</li><li>Store method implementation</li><li>Implement ShoppingCartRepo</li></ul><h1 id=dynamodb-and-cdc>DynamoDB and CDC</h1><ul><li>DynamoDB Streams and what are they</li><li>Implement OpenCart, GetCart, and AddItem Lambdas</li><li>Demonstrate Rebhydrating aggregates</li><li>Introduce Lambda to capture changes<ul><li>Pluck new events from Aggregate changes</li><li>Simple event logging for now</li></ul></li></ul><h1 id=kinesis-and-downstream-event-handlers>Kinesis and Downstream Event Handlers</h1><ul><li>What is Kinesis</li><li>Lambda that captures changes should publish to Kinesis<ul><li>Map DynamoDB to JSON</li><li>PutRecord/s</li></ul></li><li>EventHandler to handle</li><li>Publish to S3 for long term storage</li><li>Share idea on introducing a lambda to replay events</li><li>Improving Kinesis <a href=https://dashbird.io/blog/lambda-kinesis-trigger/>https://dashbird.io/blog/lambda-kinesis-trigger/</a></li></ul><p>This is part 3 of an ongoing series where we build an EventSourced system in Ruby using AWS Serverless Technologies.</p><p>We&rsquo;re going to implement aggregate persistence by using the Repository pattern and DynamoDB, so let&rsquo;s jump into it!</p><h2 id=dynamodb-tables>DynamoDB Tables</h2><p>DynamoDB is serverless Document DB by AWS that scales automatically to meet your demand. However, there is a difference between DynamoDB and other tranditional databases.</p><p>There are no databases - only tables!</p><p>Yes, as odd as that may seem, we don&rsquo;t collect tables under a single database but rather a Table is our top-level artifact.</p><p>TODO: Why does AWS do it like this?</p><p>To implement a table, very few things are necessary:</p><ul><li>A tablename</li><li>A primary key</li></ul><p>The primary key will act as the the lookup key for the value. It&rsquo;s possible to provide additional lookup keys, called Global Secondaries, but they won&rsquo;t be necessary for our implementation.</p><h2 id=shoppingcart-table-in-terraform>ShoppingCart Table in Terraform</h2><p>The first piece of infrastrcture we will build will be our EventSourced table for ShoppingCarts.</p><p>When implementing Infrastrcutre as Code with Terraform, we must define each piece of our infrastrcture as a distinct resource. After a while, common patterns emerge of what we typically want to include when building infrastrcture.</p><p>A great example that we will see later, is when we build our lambdas we will also want a Cloudwatch Log Group to log to! These two pieces go well together and it would be tedious to implement them both <em>every</em> time we needed them.</p><p>Luckily for us, Terraform allows us to build custom modules where we can build a group of related infrastrcture together aptly called <em>modules</em>.</p><p>We will start by defining a module for our EventSourced table where related infrastrctures will be placed.</p><h3 id=defining-the-module>Defining the Module</h3><p>A Terraform module is simply a directory:</p><div class=highlight><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-1>1</a></span><span>mkdir event_source_table
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-2>2</a></span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-3>3</a></span><span>touch event_source_table/dynamodb.tf
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-4>4</a></span><span>touch event_source_table/variables.tf
</span></span></code></pre></div><p>Our tables primary key will be called <code>Uuid</code> and will store our aggregates&rsquo; identifier. The implementation looks like so:</p><div class=highlight><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-terraform data-lang=terraform><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-1> 1</a></span><span><span style=color:#78787e># event_source_table/dynamodb.tf
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-2> 2</a></span><span><span style=color:#78787e></span><span style=color:#ff6ac1>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-3> 3</a></span><span><span style=color:#ff6ac1>resource</span> <span style=color:#5af78e>&#34;aws_dynamodb_table&#34;</span> <span style=color:#5af78e>&#34;es_table&#34;</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-4> 4</a></span><span>  <span style=color:#57c7ff>name</span>     = <span style=color:#ff5c57>var</span>.table_name<span style=color:#78787e> # Variables come next
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-5> 5</a></span><span><span style=color:#78787e></span>  <span style=color:#57c7ff>hash_key</span> = <span style=color:#5af78e>&#34;Uuid&#34;</span><span style=color:#78787e>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-6> 6</a></span><span><span style=color:#78787e>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-7> 7</a></span><span><span style=color:#78787e>  # Describe `Uuid` as a String
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-8> 8</a></span><span><span style=color:#78787e></span>  attribute {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-9> 9</a></span><span>    <span style=color:#57c7ff>name</span> = <span style=color:#5af78e>&#34;Uuid&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-10><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-10>10</a></span><span>    <span style=color:#57c7ff>type</span> = <span style=color:#5af78e>&#34;S&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-11><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-11>11</a></span><span>  }<span style=color:#78787e>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-12><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-12>12</a></span><span><span style=color:#78787e>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-13><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-13>13</a></span><span><span style=color:#78787e>  # For testing, low read and write capacity is just fine. In production systems, you may require different capacities
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-14><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-14>14</a></span><span><span style=color:#78787e></span>  <span style=color:#57c7ff>read_capacity</span> = <span style=color:#ff9f43>1</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-15><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-15>15</a></span><span>  <span style=color:#57c7ff>write_capacity</span> = <span style=color:#ff9f43>1</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-16><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-16>16</a></span><span>}
</span></span></code></pre></div><p>Our table will require a name, which we can supply as a variable:</p><div class=highlight><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-terraform data-lang=terraform><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-2-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-1>1</a></span><span><span style=color:#78787e># event_source_table/variables.tf
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-2-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-2>2</a></span><span><span style=color:#78787e></span><span style=color:#ff6ac1>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-2-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-3>3</a></span><span><span style=color:#ff6ac1>variable</span> <span style=color:#5af78e>&#34;table_name&#34;</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-2-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-4>4</a></span><span>  <span style=color:#57c7ff>type</span> = string  
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-2-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-5>5</a></span><span>}
</span></span></code></pre></div><p>Now our module is ready to be used, let&rsquo;s source it and build our infrastrcture:</p><div class=highlight><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-terraform data-lang=terraform><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-3-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-3-1> 1</a></span><span><span style=color:#78787e># main.tf
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-3-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-3-2> 2</a></span><span><span style=color:#78787e>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-3-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-3-3> 3</a></span><span><span style=color:#78787e># Use AWS as a terraform provider
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-3-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-3-4> 4</a></span><span><span style=color:#78787e></span><span style=color:#ff6ac1>provider</span> <span style=color:#5af78e>&#34;aws&#34;</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-3-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-3-5> 5</a></span><span>  <span style=color:#57c7ff>version</span> = <span style=color:#5af78e>&#34;~&gt; 4.57&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-3-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-3-6> 6</a></span><span>  <span style=color:#57c7ff>region</span>  = <span style=color:#5af78e>&#34;us-east-1&#34;</span><span style=color:#78787e> # feel free to choose a new region
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-3-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-3-7> 7</a></span><span><span style=color:#78787e></span>}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-3-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-3-8> 8</a></span><span><span style=color:#ff6ac1>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-3-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-3-9> 9</a></span><span><span style=color:#ff6ac1>module</span> <span style=color:#5af78e>&#34;shopping-carts-table&#34;</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-3-10><a style=outline:none;text-decoration:none;color:inherit href=#hl-3-10>10</a></span><span>  <span style=color:#57c7ff>source</span> = <span style=color:#5af78e>&#34;./event_source_table&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-3-11><a style=outline:none;text-decoration:none;color:inherit href=#hl-3-11>11</a></span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-3-12><a style=outline:none;text-decoration:none;color:inherit href=#hl-3-12>12</a></span><span>  <span style=color:#57c7ff>table_name</span> = <span style=color:#5af78e>&#34;ShoppingCarts&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-3-13><a style=outline:none;text-decoration:none;color:inherit href=#hl-3-13>13</a></span><span>}
</span></span></code></pre></div><p>Our <code>main.tf</code> sources our custom module to create a group of resources under the named <code>shopping-carts-table</code>.</p><p>We can apply terraform code by running</p><div class=highlight><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-4-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-1>1</a></span><span>$ terraform apply
</span></span></code></pre></div><p>Logging into AWS and looking at DynamoDB, we can see our table. One really great feature of DynamoDB is you can inspect tables and their items from the console which makes debugging a charm.</p><p>TODO: Insert screenshot.</p><h2 id=shoppingcart-repository>ShoppingCart Repository</h2><p>With our table ready to be used, we can turn our attention towards the code that will interface with it: The <code>ShoppingCartRepository</code>.</p><h3 id=about-the-repository-pattern>About the Repository Pattern</h3><p>The repository pattern is a data (no abstraction&mldr; what that other word?!) pattern for <em>querying</em> and <em>persisting</em> objects. It&rsquo;s responsibility is to ensure it provides <em>whole</em> objects when fetching them and persisting <em>all</em> changes when saving them.</p><p>Often, Repository Pattern is compared against the ActiveRecord pattern. The two key differences are:</p><ul><li>With the ActiveRecord pattern, the persistence methods are implemented on the Entites themselves.</li><li>With the Repository pattern, entire objects and their &ldquo;dependencies&rdquo; <em>must</em> be fetched and built. Where as with ActiveRecord, related objects can be queried for after the initial data access.</li></ul><p>So how is this pattern implemented? Well&mldr;</p><p>The literature around the repository pattern can be a bit eclectic and hard to understand at times. A lot of it is opinion based and handed down, from one generation of engineering teams to another. So let&rsquo;s get on the same page of what <em>we</em> want to build.</p><p>TODO: Get a link</p><p>I quite enjoy the way Vaugn Vernon summaries Repositores in his book, [<em>Implementing Domain Driven Design</em>](<em>Implementing Domain Driven Design</em>) (A.K.A &lsquo;The Red Book&rsquo;), which I&rsquo;ll paraphrase:</p><blockquote><p>There are two kinds of repositories. The first, acts as a collection and provides an interface for querying either single Entities or entire collections of entities. Changed entities are persisted by passing them to a <code>save</code> method. The second kind, provides only two methods: <code>fetch</code> and <code>store</code>, which fetch and persist changed Entities respectfully.</p></blockquote><p>A nice way to look at this is, there are two types of Repository patterns:</p><ul><li>One which is <em>really</em> great at meeting complex querying needs. This is highly suited for the Q in CQRS.</li><li>One which is <em>really</em> great at building and saving single complex object. This is highly suitd for the C in CQRS.</li></ul><p>For our EventSourcing application, we will build the later.</p><h3 id=repository-outline>Repository Outline</h3><p>Our Repository will have only two methods: <code>fetch</code> and <code>store</code>, where fetch takes a <code>uuid</code> and store takes an entire Aggregate.</p><p>Additionally, our Repository will require access to DynamoDB. This will be injected as a dependency.</p><div class=highlight><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-1> 1</a></span><span><span style=color:#ff6ac1>class</span> <span style=color:#f3f99d>ShoppingCartRepository</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-2> 2</a></span><span>  <span style=color:#ff6ac1>def</span> <span style=color:#57c7ff>initialize</span>(dynamodb_client)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-3> 3</a></span><span>    <span style=color:#ff5c57>@dynamodb_client</span> <span style=color:#ff6ac1>=</span> client
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-4> 4</a></span><span>  <span style=color:#ff6ac1>end</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-5> 5</a></span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-6> 6</a></span><span>  <span style=color:#ff6ac1>def</span> <span style=color:#57c7ff>fetch</span>(uuid)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-7> 7</a></span><span>    <span style=color:#78787e># Will implement</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-8> 8</a></span><span>  <span style=color:#ff6ac1>end</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-9> 9</a></span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-10><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-10>10</a></span><span>  <span style=color:#ff6ac1>def</span> <span style=color:#57c7ff>store</span>(shopping_cart)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-11><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-11>11</a></span><span>    <span style=color:#78787e># Will implement</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-12><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-12>12</a></span><span>  <span style=color:#ff6ac1>end</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-13><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-13>13</a></span><span><span style=color:#ff6ac1>end</span>
</span></span></code></pre></div><h3 id=store-method>Store Method</h3><p>Before we can <code>fetch</code> we must be able to <code>store</code>.</p><p>The <code>store</code> method has two responsibilities:</p><ul><li>Persisting new events (changes) that are stored on the aggregate.</li><li>Clearing persisted events and returning a clean aggregate, ready for further interactions.</li></ul><div class=highlight><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-6-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-1> 1</a></span><span><span style=color:#ff6ac1>class</span> <span style=color:#f3f99d>ShoppingCartRepository</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-6-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-2> 2</a></span><span>  <span style=color:#78787e># ...</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-6-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-3> 3</a></span><span>  <span style=color:#ff6ac1>def</span> <span style=color:#57c7ff>store</span>(shopping_cart)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-6-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-4> 4</a></span><span>    update_aggregate_record(shopping_cart)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-6-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-5> 5</a></span><span>    shopping_cart<span style=color:#ff6ac1>.</span>clear_changes
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-6-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-6> 6</a></span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-6-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-7> 7</a></span><span>    shopping_cart
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-6-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-8> 8</a></span><span>  <span style=color:#ff6ac1>end</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-6-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-9> 9</a></span><span>  
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-6-10><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-10>10</a></span><span>  <span style=color:#ff6ac1>def</span> <span style=color:#57c7ff>update_aggregate_record</span>(shopping_cart)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-6-11><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-11>11</a></span><span>    new_events <span style=color:#ff6ac1>=</span> shopping_cart<span style=color:#ff6ac1>.</span>changes<span style=color:#ff6ac1>.</span>map { <span style=color:#ff6ac1>|</span>event<span style=color:#ff6ac1>|</span> { <span style=color:#5af78e>Name</span>: event<span style=color:#ff6ac1>.</span>class<span style=color:#ff6ac1>::</span><span style=color:#ff9f43>NAME</span>, <span style=color:#5af78e>Data</span>: event<span style=color:#ff6ac1>.</span>to_h } }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-6-12><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-12>12</a></span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-6-13><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-13>13</a></span><span>    <span style=color:#ff5c57>@dynamodb_client</span><span style=color:#ff6ac1>.</span>update_item({
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-6-14><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-14>14</a></span><span>      <span style=color:#5af78e>table_name</span>: <span style=color:#5af78e>&#34;ShoppingCart&#34;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-6-15><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-15>15</a></span><span>      <span style=color:#5af78e>key</span>: {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-6-16><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-16>16</a></span><span>        <span style=color:#5af78e>Uuid</span>: shopping_cart<span style=color:#ff6ac1>.</span>uuid
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-6-17><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-17>17</a></span><span>      },
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-6-18><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-18>18</a></span><span>      <span style=color:#5af78e>update_expression</span>: <span style=color:#5af78e>&#34;SET #el = list_append(if_not_exists(#el, :empty_list), :new_events)&#34;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-6-19><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-19>19</a></span><span>      <span style=color:#5af78e>expression_attribute_names</span>: {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-6-20><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-20>20</a></span><span>        <span style=color:#5af78e>&#34;#el&#34;</span> <span style=color:#ff6ac1>=&gt;</span> <span style=color:#5af78e>&#34;Events&#34;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-6-21><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-21>21</a></span><span>      },
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-6-22><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-22>22</a></span><span>      <span style=color:#5af78e>expression_attribute_values</span>: {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-6-23><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-23>23</a></span><span>        <span style=color:#5af78e>&#34;:empty_list&#34;</span> <span style=color:#ff6ac1>=&gt;</span> <span style=color:#ff6ac1>[]</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-6-24><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-24>24</a></span><span>        <span style=color:#5af78e>&#34;:new_events&#34;</span> <span style=color:#ff6ac1>=&gt;</span> new_events
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-6-25><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-25>25</a></span><span>      },
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-6-26><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-26>26</a></span><span>    })
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-6-27><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-27>27</a></span><span>  <span style=color:#ff6ac1>end</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-6-28><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-28>28</a></span><span><span style=color:#ff6ac1>end</span>
</span></span></code></pre></div><p>Lot&rsquo;s to unpack here, so let&rsquo;s break it down. First, the <code>update_aggregate_record</code> method.</p><p>First, we transform new events into a structure suited for persistence. DynamoDB is a document store, so it can handle Hash just fine.</p><p>Our persisted events will be stored in a attribute named <code>Events</code> as an array of hashes with the following keys: <code>Name</code>, which is the name of our event, and <code>Data</code>, which is our event data.</p><p>In order to accomplish this, our events need to implent a <code>to_h</code> method. Let&rsquo;s do that now:</p><div class=highlight><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-1> 1</a></span><span><span style=color:#ff6ac1>class</span> <span style=color:#f3f99d>CartOpened</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-2> 2</a></span><span>  <span style=color:#ff6ac1>attr_reader</span> <span style=color:#5af78e>:shopping_cart_uuid</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-3> 3</a></span><span>  
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-4> 4</a></span><span>  <span style=color:#78787e># ...</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-5> 5</a></span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-6> 6</a></span><span>  <span style=color:#ff6ac1>def</span> <span style=color:#57c7ff>to_h</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-7> 7</a></span><span>    { <span style=color:#5af78e>shopping_cart_uuid</span>: <span style=color:#ff5c57>@shopping_cart_uuid</span> }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-8> 8</a></span><span>  <span style=color:#ff6ac1>end</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-9> 9</a></span><span><span style=color:#ff6ac1>end</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-10><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-10>10</a></span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-11><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-11>11</a></span><span><span style=color:#ff6ac1>class</span> <span style=color:#f3f99d>ItemAdded</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-12><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-12>12</a></span><span>  <span style=color:#ff6ac1>attr_reader</span> <span style=color:#5af78e>:shopping_cart_uuid</span>, <span style=color:#5af78e>:item_name</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-13><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-13>13</a></span><span>  
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-14><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-14>14</a></span><span>  <span style=color:#78787e># ...</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-15><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-15>15</a></span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-16><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-16>16</a></span><span>  <span style=color:#ff6ac1>def</span> <span style=color:#57c7ff>to_h</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-17><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-17>17</a></span><span>    { <span style=color:#5af78e>shopping_cart_uuid</span>: <span style=color:#ff5c57>@shopping_cart_uuid</span>, <span style=color:#5af78e>item_name</span>: <span style=color:#ff5c57>@item_name</span> }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-18><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-18>18</a></span><span>  <span style=color:#ff6ac1>end</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-19><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-19>19</a></span><span><span style=color:#ff6ac1>end</span>
</span></span></code></pre></div><p>Great, so the rest of the method is DynamoDB syntax for <em>updating or inserting</em> a record. We provide enough logic of what should happen if the record doesn&rsquo;t exist.</p><p>In the case that a record does not exist, it&rsquo;s going to insert a new one with the <code>Uuid</code> as the <code>shopping_cart.uuid</code> and the <code>Events</code> will be an merge of two lists: an empty list (<code>[]</code>) and a list of new events. DynamoDB calls this <code>list_append</code>.</p><p>In the case that a record does exist, <code>Events</code> will be updated with a merge of two lists: the old <code>Events</code> list and a list of new events.</p><p>Lastly, we need to clear the persisted events. We can achieve this by implementing a method to do so in the <code>Aggregate</code> module.</p><div class=highlight><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-8-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-1> 1</a></span><span><span style=color:#ff6ac1>module</span> Aggregate
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-8-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-2> 2</a></span><span>  <span style=color:#78787e># ...</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-8-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-3> 3</a></span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-8-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-4> 4</a></span><span>  <span style=color:#ff6ac1>def</span> <span style=color:#57c7ff>clear_changes</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-8-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-5> 5</a></span><span>    <span style=color:#ff5c57>@changes</span> <span style=color:#ff6ac1>=</span> <span style=color:#ff6ac1>[]</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-8-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-6> 6</a></span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-8-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-7> 7</a></span><span>    <span style=color:#ff5c57>self</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-8-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-8> 8</a></span><span>  <span style=color:#ff6ac1>end</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-8-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-9> 9</a></span><span>  
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-8-10><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-10>10</a></span><span>  <span style=color:#78787e># ...</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-8-11><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-11>11</a></span><span><span style=color:#ff6ac1>end</span>
</span></span></code></pre></div><p>Our <code>store</code> method is complete and our Aggregates can now be persisted! Congratulations!</p><h4 id=test-run>Test Run</h4><div class=highlight><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-9-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-1> 1</a></span><span><span style=color:#ff5c57>require</span> <span style=color:#5af78e>&#39;aws-sdk-dynamodb&#39;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-9-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-2> 2</a></span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-9-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-3> 3</a></span><span><span style=color:#78787e># DynamoDB Client</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-9-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-4> 4</a></span><span>dynamo_db_client <span style=color:#ff6ac1>=</span> <span style=color:#ff9f43>Aws</span><span style=color:#ff6ac1>::</span><span style=color:#ff9f43>DynamoDB</span><span style=color:#ff6ac1>::</span><span style=color:#ff9f43>Client</span><span style=color:#ff6ac1>.</span>new
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-9-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-5> 5</a></span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-9-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-6> 6</a></span><span><span style=color:#78787e># ShoppingCartRepo, dependecies injected</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-9-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-7> 7</a></span><span>shopping_cart_repo <span style=color:#ff6ac1>=</span> <span style=color:#ff9f43>ShoppingCartRepo</span><span style=color:#ff6ac1>.</span>new(dynamo_db_client)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-9-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-8> 8</a></span><span>  
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-9-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-9> 9</a></span><span>shopping_cart <span style=color:#ff6ac1>=</span> <span style=color:#ff9f43>ShoppingCart</span><span style=color:#ff6ac1>.</span>new(<span style=color:#5af78e>&#34;test-uuid&#34;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-9-10><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-10>10</a></span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-9-11><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-11>11</a></span><span>shopping_cart<span style=color:#ff6ac1>.</span>add_item(<span style=color:#5af78e>&#34;apiercey.github.io subscription&#34;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-9-12><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-12>12</a></span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-9-13><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-13>13</a></span><span><span style=color:#78787e># There should now be two events in @changes</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-9-14><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-14>14</a></span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-9-15><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-15>15</a></span><span><span style=color:#ff5c57>puts</span> shopping_cart<span style=color:#ff6ac1>.</span>inspect
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-9-16><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-16>16</a></span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-9-17><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-17>17</a></span><span>shopping_cart_repo<span style=color:#ff6ac1>.</span>store(shopping_cart)
</span></span></code></pre></div><p>Taking a peak into our DynamoDb table, we see the record there, with the set of changes as events.</p><p>TODO: Insert screenshot</p><h3 id=fetch-method>Fetch Method</h3><p>The best for last! With everything we&rsquo;ve build up until now, this is by far the easiest.</p><p>But first, let&rsquo;s talk about how our Aggregates are initialized.</p><h4 id=preparing-our-aggregate-module>Preparing our Aggregate Module</h4><p>Currently, to instantiate our ShoppingCart, we must provide a <code>uuid</code>:</p><div class=highlight><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-10-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-10-1> 1</a></span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-10-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-10-2> 2</a></span><span><span style=color:#ff6ac1>class</span> <span style=color:#f3f99d>ShoppingCart</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-10-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-10-3> 3</a></span><span>  <span style=color:#ff6ac1>include</span> <span style=color:#ff9f43>Aggregate</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-10-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-10-4> 4</a></span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-10-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-10-5> 5</a></span><span>  <span style=color:#ff6ac1>attr_reader</span> <span style=color:#5af78e>:items</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-10-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-10-6> 6</a></span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-10-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-10-7> 7</a></span><span>  <span style=color:#ff6ac1>def</span> <span style=color:#57c7ff>initialize</span>(uuid)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-10-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-10-8> 8</a></span><span>    <span style=color:#ff5c57>@items</span> <span style=color:#ff6ac1>=</span> <span style=color:#ff6ac1>[]</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-10-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-10-9> 9</a></span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-10-10><a style=outline:none;text-decoration:none;color:inherit href=#hl-10-10>10</a></span><span>    enqueue(<span style=color:#ff9f43>CartOpened</span><span style=color:#ff6ac1>.</span>new(uuid))
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-10-11><a style=outline:none;text-decoration:none;color:inherit href=#hl-10-11>11</a></span><span>  <span style=color:#ff6ac1>end</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-10-12><a style=outline:none;text-decoration:none;color:inherit href=#hl-10-12>12</a></span><span>  
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-10-13><a style=outline:none;text-decoration:none;color:inherit href=#hl-10-13>13</a></span><span>  <span style=color:#78787e># ...</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-10-14><a style=outline:none;text-decoration:none;color:inherit href=#hl-10-14>14</a></span><span><span style=color:#ff6ac1>end</span>
</span></span></code></pre></div><p>But what about when we need to <em>rebuild</em> an aggregate? We cannot instantiate an empty Aggregate without enqueuing a &ldquo;start&rdquo; event - in our case, a <code>CartOpened</code>. There are a few options</p><p>We could move the responsibilities of <em>building</em> a new ShoppingCart to a <code>build</code> method, that will instantiate the Aggragate and <code>apply</code> the correct event but there are some drawbacks. We now have <em>two</em> methods for instantiating objects, and it can be confusing which one to use, especially as more Engineers join the project.</p><p>We could move the responsibility of instantiating a new ShoppingCart to the repository, where a new Aggregate is instatiated and the correct starting event is applied. This too, has some drawbacks. For one, the <em>event</em> which belongs to the domain model is now part of the Repository! The model has very little control over when these events become applied and this is no bueno!</p><p>I&rsquo;m sure there are a few other clever ways we can do this in ruby but there is one pragmatic way I&rsquo;ve come to enjoy: nullified arguments!</p><p>When instantiating a new Aggregate, we can allow passing in a <code>uuid</code> as <code>nil</code>, and allow the event to choose to enqueue a new starting event or not. This will allow the aggregate to retain control of when events are published and keeps a single method for instantiating aggregates.</p><p>Our new ShoppingCart looks like so:</p><div class=highlight><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-11-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-11-1> 1</a></span><span><span style=color:#ff6ac1>class</span> <span style=color:#f3f99d>ShoppingCart</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-11-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-11-2> 2</a></span><span>  <span style=color:#ff6ac1>include</span> <span style=color:#ff9f43>Aggregate</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-11-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-11-3> 3</a></span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-11-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-11-4> 4</a></span><span>  <span style=color:#ff6ac1>attr_reader</span> <span style=color:#5af78e>:items</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-11-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-11-5> 5</a></span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-11-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-11-6> 6</a></span><span>  <span style=color:#ff6ac1>def</span> <span style=color:#57c7ff>initialize</span>(uuid <span style=color:#ff6ac1>=</span> <span style=color:#ff6ac1>nil</span>) <span style=color:#78787e># uuid is allowed to be nil</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-11-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-11-7> 7</a></span><span>    <span style=color:#ff5c57>@items</span> <span style=color:#ff6ac1>=</span> <span style=color:#ff6ac1>[]</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-11-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-11-8> 8</a></span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-11-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-11-9> 9</a></span><span>    enqueue(<span style=color:#ff9f43>CartOpened</span><span style=color:#ff6ac1>.</span>new(uuid)) <span style=color:#ff6ac1>unless</span> uuid<span style=color:#ff6ac1>.</span>nil? <span style=color:#78787e># if it&#39;s new, it&#39;s a black object</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-11-10><a style=outline:none;text-decoration:none;color:inherit href=#hl-11-10>10</a></span><span>  <span style=color:#ff6ac1>end</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-11-11><a style=outline:none;text-decoration:none;color:inherit href=#hl-11-11>11</a></span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-11-12><a style=outline:none;text-decoration:none;color:inherit href=#hl-11-12>12</a></span><span>  <span style=color:#ff6ac1>def</span> <span style=color:#57c7ff>add_item</span>(item_name)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-11-13><a style=outline:none;text-decoration:none;color:inherit href=#hl-11-13>13</a></span><span>    enqueue(<span style=color:#ff9f43>Events</span><span style=color:#ff6ac1>::</span><span style=color:#ff9f43>ItemAdded</span><span style=color:#ff6ac1>.</span>new(uuid, item_name))
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-11-14><a style=outline:none;text-decoration:none;color:inherit href=#hl-11-14>14</a></span><span>  <span style=color:#ff6ac1>end</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-11-15><a style=outline:none;text-decoration:none;color:inherit href=#hl-11-15>15</a></span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-11-16><a style=outline:none;text-decoration:none;color:inherit href=#hl-11-16>16</a></span><span>  on <span style=color:#ff9f43>CartOpened</span> <span style=color:#ff6ac1>do</span> <span style=color:#ff6ac1>|</span>event<span style=color:#ff6ac1>|</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-11-17><a style=outline:none;text-decoration:none;color:inherit href=#hl-11-17>17</a></span><span>    <span style=color:#ff5c57>@uuid</span> <span style=color:#ff6ac1>=</span> event<span style=color:#ff6ac1>.</span>shopping_cart_uuid
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-11-18><a style=outline:none;text-decoration:none;color:inherit href=#hl-11-18>18</a></span><span>  <span style=color:#ff6ac1>end</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-11-19><a style=outline:none;text-decoration:none;color:inherit href=#hl-11-19>19</a></span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-11-20><a style=outline:none;text-decoration:none;color:inherit href=#hl-11-20>20</a></span><span>  on <span style=color:#ff9f43>ItemAdded</span> <span style=color:#ff6ac1>do</span> <span style=color:#ff6ac1>|</span>event<span style=color:#ff6ac1>|</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-11-21><a style=outline:none;text-decoration:none;color:inherit href=#hl-11-21>21</a></span><span>    <span style=color:#ff5c57>@items</span> <span style=color:#ff6ac1>=</span> <span style=color:#ff5c57>@items</span><span style=color:#ff6ac1>.</span>append(event<span style=color:#ff6ac1>.</span>item_name)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-11-22><a style=outline:none;text-decoration:none;color:inherit href=#hl-11-22>22</a></span><span>  <span style=color:#ff6ac1>end</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-11-23><a style=outline:none;text-decoration:none;color:inherit href=#hl-11-23>23</a></span><span><span style=color:#ff6ac1>end</span>
</span></span></code></pre></div><p>In a way, I find similarities to the <a href=https://en.wikipedia.org/wiki/Null_object_pattern><code>Null-Object</code> pattern</a>.</p><h4 id=implementing-fetch>Implementing <code>fetch</code></h4><p>The <code>fetch</code> method has two responsibilities:</p><ul><li>Fetch previous events using a <code>uuid</code> and apply them against an aggregate.</li><li>If no events can be applied <em>or</em> for some reason the <code>uuid</code> is <em><code>nil</code></em>, return <code>nil</code></li></ul><div class=highlight><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-12-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-12-1> 1</a></span><span><span style=color:#ff6ac1>class</span> <span style=color:#f3f99d>ShoppingCartRepo</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-12-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-12-2> 2</a></span><span>  <span style=color:#ff6ac1>def</span> <span style=color:#57c7ff>initialize</span>(dynamodb_client, event_builder)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-12-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-12-3> 3</a></span><span>    <span style=color:#ff5c57>@dynamodb_client</span> <span style=color:#ff6ac1>=</span> client
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-12-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-12-4> 4</a></span><span>    <span style=color:#ff5c57>@event_builder</span> <span style=color:#ff6ac1>=</span> event_builder
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-12-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-12-5> 5</a></span><span>  <span style=color:#ff6ac1>end</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-12-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-12-6> 6</a></span><span>  
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-12-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-12-7> 7</a></span><span>  <span style=color:#ff6ac1>def</span> <span style=color:#57c7ff>fetch</span>(uuid)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-12-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-12-8> 8</a></span><span>    agg <span style=color:#ff6ac1>=</span> <span style=color:#ff9f43>ShoppingCart</span><span style=color:#ff6ac1>.</span>new <span style=color:#78787e># A blank aggregate</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-12-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-12-9> 9</a></span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-12-10><a style=outline:none;text-decoration:none;color:inherit href=#hl-12-10>10</a></span><span>    record <span style=color:#ff6ac1>=</span> fetch_aggregate_record(uuid)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-12-11><a style=outline:none;text-decoration:none;color:inherit href=#hl-12-11>11</a></span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-12-12><a style=outline:none;text-decoration:none;color:inherit href=#hl-12-12>12</a></span><span>    <span style=color:#ff6ac1>return</span> <span style=color:#ff6ac1>nil</span> <span style=color:#ff6ac1>if</span> record<span style=color:#ff6ac1>.</span>nil?
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-12-13><a style=outline:none;text-decoration:none;color:inherit href=#hl-12-13>13</a></span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-12-14><a style=outline:none;text-decoration:none;color:inherit href=#hl-12-14>14</a></span><span>    record
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-12-15><a style=outline:none;text-decoration:none;color:inherit href=#hl-12-15>15</a></span><span>      <span style=color:#ff6ac1>.</span>fetch(<span style=color:#5af78e>&#34;Events&#34;</span>, <span style=color:#ff6ac1>[]</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-12-16><a style=outline:none;text-decoration:none;color:inherit href=#hl-12-16>16</a></span><span>      <span style=color:#ff6ac1>.</span>map { <span style=color:#ff6ac1>|</span>event<span style=color:#ff6ac1>|</span> build_event(event) }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-12-17><a style=outline:none;text-decoration:none;color:inherit href=#hl-12-17>17</a></span><span>      <span style=color:#ff6ac1>.</span>reject(<span style=color:#ff6ac1>&amp;</span><span style=color:#5af78e>:nil?</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-12-18><a style=outline:none;text-decoration:none;color:inherit href=#hl-12-18>18</a></span><span>      <span style=color:#ff6ac1>.</span>each { <span style=color:#ff6ac1>|</span>event<span style=color:#ff6ac1>|</span> agg<span style=color:#ff6ac1>.</span>apply(event) }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-12-19><a style=outline:none;text-decoration:none;color:inherit href=#hl-12-19>19</a></span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-12-20><a style=outline:none;text-decoration:none;color:inherit href=#hl-12-20>20</a></span><span>    <span style=color:#ff6ac1>if</span> agg<span style=color:#ff6ac1>.</span>uuid<span style=color:#ff6ac1>.</span>nil?
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-12-21><a style=outline:none;text-decoration:none;color:inherit href=#hl-12-21>21</a></span><span>      <span style=color:#ff6ac1>nil</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-12-22><a style=outline:none;text-decoration:none;color:inherit href=#hl-12-22>22</a></span><span>    <span style=color:#ff6ac1>else</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-12-23><a style=outline:none;text-decoration:none;color:inherit href=#hl-12-23>23</a></span><span>      agg
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-12-24><a style=outline:none;text-decoration:none;color:inherit href=#hl-12-24>24</a></span><span>    <span style=color:#ff6ac1>end</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-12-25><a style=outline:none;text-decoration:none;color:inherit href=#hl-12-25>25</a></span><span>  <span style=color:#ff6ac1>end</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-12-26><a style=outline:none;text-decoration:none;color:inherit href=#hl-12-26>26</a></span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-12-27><a style=outline:none;text-decoration:none;color:inherit href=#hl-12-27>27</a></span><span>  <span style=color:#ff6ac1>private</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-12-28><a style=outline:none;text-decoration:none;color:inherit href=#hl-12-28>28</a></span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-12-29><a style=outline:none;text-decoration:none;color:inherit href=#hl-12-29>29</a></span><span>  <span style=color:#ff6ac1>def</span> <span style=color:#57c7ff>fetch_aggregate_record</span>(uuid)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-12-30><a style=outline:none;text-decoration:none;color:inherit href=#hl-12-30>30</a></span><span>    <span style=color:#ff5c57>@dynamodb_client</span><span style=color:#ff6ac1>.</span>get_item({
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-12-31><a style=outline:none;text-decoration:none;color:inherit href=#hl-12-31>31</a></span><span>      <span style=color:#5af78e>table_name</span>: <span style=color:#5af78e>&#34;ShoppingCart&#34;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-12-32><a style=outline:none;text-decoration:none;color:inherit href=#hl-12-32>32</a></span><span>      <span style=color:#5af78e>key</span>: { <span style=color:#5af78e>Uuid</span>: uuid }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-12-33><a style=outline:none;text-decoration:none;color:inherit href=#hl-12-33>33</a></span><span>    })<span style=color:#ff6ac1>.</span>item
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-12-34><a style=outline:none;text-decoration:none;color:inherit href=#hl-12-34>34</a></span><span>  <span style=color:#ff6ac1>end</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-12-35><a style=outline:none;text-decoration:none;color:inherit href=#hl-12-35>35</a></span><span>  
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-12-36><a style=outline:none;text-decoration:none;color:inherit href=#hl-12-36>36</a></span><span>  <span style=color:#ff6ac1>def</span> <span style=color:#57c7ff>build_event</span>(raw_event)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-12-37><a style=outline:none;text-decoration:none;color:inherit href=#hl-12-37>37</a></span><span>    <span style=color:#ff5c57>@event_builder</span><span style=color:#ff6ac1>.</span>build(raw_event<span style=color:#ff6ac1>.</span>fetch(<span style=color:#5af78e>&#39;Name&#39;</span>), raw_event<span style=color:#ff6ac1>.</span>fetch(<span style=color:#5af78e>&#39;Data&#39;</span>))
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-12-38><a style=outline:none;text-decoration:none;color:inherit href=#hl-12-38>38</a></span><span>  <span style=color:#ff6ac1>end</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-12-39><a style=outline:none;text-decoration:none;color:inherit href=#hl-12-39>39</a></span><span>  
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-12-40><a style=outline:none;text-decoration:none;color:inherit href=#hl-12-40>40</a></span><span>  <span style=color:#78787e># ...</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-12-41><a style=outline:none;text-decoration:none;color:inherit href=#hl-12-41>41</a></span><span><span style=color:#ff6ac1>end</span>
</span></span></code></pre></div><p>Our new <code>fetch</code> starts be instantiating a black ShoppingCart (it has not enqueued a <code>CartOpened</code> event). It then fetches a record from DynamoDB with the <code>uuid</code> as the Primary Key. If it <em>cannot</em> find a record, it simply returns <code>nil</code>.</p><p>Otherwise, it loops over each event stored under <code>Events</code>, first <em>building</em> themm then <em>applying</em> them.</p><p>At the end, if the <code>uuid</code> is not <code>nil</code>, you can return the rehdrated <code>ShoppingCart</code>. Otherwise, <code>nil</code>. However, we&rsquo;ve introduced a new clas to help build events. Here it is:</p><div class=highlight><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-13-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-1> 1</a></span><span><span style=color:#ff6ac1>module</span> Events
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-13-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-2> 2</a></span><span>  <span style=color:#ff6ac1>class</span> <span style=color:#f3f99d>Builder</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-13-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-3> 3</a></span><span>    <span style=color:#ff6ac1>def</span> <span style=color:#57c7ff>build</span>(<span style=color:#ff5c57>name</span>, data)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-13-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-4> 4</a></span><span>      <span style=color:#ff6ac1>case</span> <span style=color:#ff5c57>name</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-13-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-5> 5</a></span><span>      <span style=color:#ff6ac1>when</span> <span style=color:#5af78e>&#34;CartOpened&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-13-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-6> 6</a></span><span>        <span style=color:#ff9f43>CartOpened</span><span style=color:#ff6ac1>.</span>new(data<span style=color:#ff6ac1>.</span>fetch(<span style=color:#5af78e>&#34;shopping_cart_uuid&#34;</span>))
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-13-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-7> 7</a></span><span>      <span style=color:#ff6ac1>when</span> <span style=color:#5af78e>&#34;ItemAdded&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-13-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-8> 8</a></span><span>        <span style=color:#ff9f43>ItemAdded</span><span style=color:#ff6ac1>.</span>new(data<span style=color:#ff6ac1>.</span>fetch(<span style=color:#5af78e>&#34;shopping_cart_uuid&#34;</span>), data<span style=color:#ff6ac1>.</span>fetch(<span style=color:#5af78e>&#34;item_name&#34;</span>))
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-13-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-9> 9</a></span><span>      <span style=color:#ff6ac1>else</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-13-10><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-10>10</a></span><span>        <span style=color:#ff6ac1>nil</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-13-11><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-11>11</a></span><span>      <span style=color:#ff6ac1>end</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-13-12><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-12>12</a></span><span>    <span style=color:#ff6ac1>end</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-13-13><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-13>13</a></span><span>  <span style=color:#ff6ac1>end</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-13-14><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-14>14</a></span><span><span style=color:#ff6ac1>end</span>
</span></span></code></pre></div><h4 id=when-would-uuid-be-nil>When would <code>uuid</code> be nil?</h4><p>So what gives? If we can find the record and the starting event <em>always</em> provides a <code>uuid</code>, when would it be <code>nil</code>?</p><p>One of the core aspects of EventSourcing is that events are <strong>never</strong> deleted nor altered. They are immutable! This begs the question, how are Aggregates then &ldquo;deleted&rdquo;?</p><p>By another event of course! In eventually consistent systems, an event which signifies the end of an object is called a <a href=https://en.wikipedia.org/wiki/Tombstone_(data_store)>Tombstone</a>. The motiviation section in the Wikipedia entry describes this as (emphasis my own),</p><blockquote><p>If information is deleted in an eventually-consistent distributed data store, the &ldquo;eventual&rdquo; part of the eventual consistency causes the information to ooze through the node structure, <strong>where some nodes may be unavailable at time of deletion</strong>. But a feature of eventual consistency causes a problem in case of deletion, as a node that was unavailable at that time will try to &ldquo;update&rdquo; the other nodes that no longer have the deleted entry, assuming that they have missed an insert of information. Therefore, <strong>instead of deleting the information, the distributed data store creates a (usually temporary) tombstone record</strong>, which is not returned in response to requests.</p></blockquote><p>When our aggregate should be deleted, a new event is enqueued which sets the <code>uuid</code> to <code>nil</code> effectivly deleting it. Eventually, downstream consumers will receive this event and decide what a tombstone means for their domain.</p><p>In our ShoppingCart, such an example could be:</p><div class=highlight><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-14-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-1> 1</a></span><span><span style=color:#ff6ac1>class</span> <span style=color:#f3f99d>ShoppingCart</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-14-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-2> 2</a></span><span>  <span style=color:#78787e># ...</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-14-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-3> 3</a></span><span>  
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-14-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-4> 4</a></span><span>  <span style=color:#ff6ac1>def</span> <span style=color:#57c7ff>close</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-14-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-5> 5</a></span><span>    enqueue(<span style=color:#ff9f43>CartClosed</span><span style=color:#ff6ac1>.</span>new(uuid))
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-14-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-6> 6</a></span><span>  <span style=color:#ff6ac1>end</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-14-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-7> 7</a></span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-14-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-8> 8</a></span><span>  on <span style=color:#ff9f43>CartClosed</span> <span style=color:#ff6ac1>do</span> <span style=color:#ff6ac1>|</span>event<span style=color:#ff6ac1>|</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-14-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-9> 9</a></span><span>    <span style=color:#ff5c57>@uuid</span> <span style=color:#ff6ac1>=</span> <span style=color:#ff6ac1>nil</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-14-10><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-10>10</a></span><span>  <span style=color:#ff6ac1>end</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-14-11><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-11>11</a></span><span>  
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-14-12><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-12>12</a></span><span>  <span style=color:#78787e># ...</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-14-13><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-13>13</a></span><span><span style=color:#ff6ac1>end</span>
</span></span></code></pre></div><h4 id=test-run-1>Test Run</h4><div class=highlight><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-15-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-15-1> 1</a></span><span><span style=color:#ff5c57>require</span> <span style=color:#5af78e>&#39;aws-sdk-dynamodb&#39;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-15-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-15-2> 2</a></span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-15-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-15-3> 3</a></span><span><span style=color:#78787e># DynamoDB Client</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-15-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-15-4> 4</a></span><span>dynamo_db_client <span style=color:#ff6ac1>=</span> <span style=color:#ff9f43>Aws</span><span style=color:#ff6ac1>::</span><span style=color:#ff9f43>DynamoDB</span><span style=color:#ff6ac1>::</span><span style=color:#ff9f43>Client</span><span style=color:#ff6ac1>.</span>new
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-15-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-15-5> 5</a></span><span>event_builder <span style=color:#ff6ac1>=</span> <span style=color:#ff9f43>EventBuilder</span><span style=color:#ff6ac1>.</span>new
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-15-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-15-6> 6</a></span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-15-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-15-7> 7</a></span><span><span style=color:#78787e># ShoppingCartRepo, dependecies injected</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-15-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-15-8> 8</a></span><span>shopping_cart_repo <span style=color:#ff6ac1>=</span> <span style=color:#ff9f43>ShoppingCartRepo</span><span style=color:#ff6ac1>.</span>new(dynamo_db_client)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-15-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-15-9> 9</a></span><span>  
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-15-10><a style=outline:none;text-decoration:none;color:inherit href=#hl-15-10>10</a></span><span>shopping_cart <span style=color:#ff6ac1>=</span> <span style=color:#ff9f43>ShoppingCart</span><span style=color:#ff6ac1>.</span>new(<span style=color:#5af78e>&#34;test-uuid&#34;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-15-11><a style=outline:none;text-decoration:none;color:inherit href=#hl-15-11>11</a></span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-15-12><a style=outline:none;text-decoration:none;color:inherit href=#hl-15-12>12</a></span><span>shopping_cart<span style=color:#ff6ac1>.</span>add_item(<span style=color:#5af78e>&#34;apiercey.github.io subscription&#34;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-15-13><a style=outline:none;text-decoration:none;color:inherit href=#hl-15-13>13</a></span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-15-14><a style=outline:none;text-decoration:none;color:inherit href=#hl-15-14>14</a></span><span>shopping_cart_repo<span style=color:#ff6ac1>.</span>store(shopping_cart)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-15-15><a style=outline:none;text-decoration:none;color:inherit href=#hl-15-15>15</a></span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-15-16><a style=outline:none;text-decoration:none;color:inherit href=#hl-15-16>16</a></span><span>rehydrated_shopping_cart <span style=color:#ff6ac1>=</span> shopping_cart_repo<span style=color:#ff6ac1>.</span>fetch(<span style=color:#5af78e>&#34;test-uuid&#34;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-15-17><a style=outline:none;text-decoration:none;color:inherit href=#hl-15-17>17</a></span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-15-18><a style=outline:none;text-decoration:none;color:inherit href=#hl-15-18>18</a></span><span><span style=color:#ff5c57>puts</span> rehydrated_shopping_cart<span style=color:#ff6ac1>.</span>inspect
</span></span></code></pre></div><p>We should expect to see a complete <code>ShoppingCart</code> with a <code>uuid</code> and an <code>item</code>.</p><h2 id=small-cleanup>Small Cleanup</h2><p>Our repo is looking good but it could be better, it could be <em>great</em>, in fact! If we carefully read through our Repo, there is hardly anything that is specific about &ldquo;shopping cards&rdquo; really. Events are built using a separate class and even the Table is a hard coded string. All of these things can be supplied at run time, allowing us to refactor this repo to allow it to become a repo for <em>all</em> aggregates.</p><p>We can accomplish this by doing two things:</p><ul><li>Moving these values to the initialize method</li><li>Moving everything to parent class and inherit from it.</li></ul><div class=highlight><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-16-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-1> 1</a></span><span><span style=color:#ff6ac1>class</span> <span style=color:#f3f99d>EsRepo</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-16-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-2> 2</a></span><span>  <span style=color:#ff6ac1>def</span> <span style=color:#57c7ff>initialize</span>(dynamodb_client, event_builder, table_name, aggregate_class)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-16-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-3> 3</a></span><span>    <span style=color:#ff5c57>@dynamodb_client</span> <span style=color:#ff6ac1>=</span> dynamodb_client
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-16-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-4> 4</a></span><span>    <span style=color:#ff5c57>@event_builder</span> <span style=color:#ff6ac1>=</span> event_builder
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-16-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-5> 5</a></span><span>    <span style=color:#ff5c57>@table_name</span> <span style=color:#ff6ac1>=</span> table_name
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-16-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-6> 6</a></span><span>    <span style=color:#ff5c57>@aggregate_class</span> <span style=color:#ff6ac1>=</span> aggregate_class
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-16-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-7> 7</a></span><span>  <span style=color:#ff6ac1>end</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-16-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-8> 8</a></span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-16-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-9> 9</a></span><span>  <span style=color:#ff6ac1>def</span> <span style=color:#57c7ff>fetch</span>(uuid)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-16-10><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-10>10</a></span><span>    agg <span style=color:#ff6ac1>=</span> <span style=color:#ff5c57>@aggregate_class</span><span style=color:#ff6ac1>.</span>new
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-16-11><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-11>11</a></span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-16-12><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-12>12</a></span><span>    record <span style=color:#ff6ac1>=</span> fetch_aggregate_record(uuid)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-16-13><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-13>13</a></span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-16-14><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-14>14</a></span><span>    <span style=color:#ff6ac1>return</span> <span style=color:#ff6ac1>nil</span> <span style=color:#ff6ac1>if</span> record<span style=color:#ff6ac1>.</span>nil?
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-16-15><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-15>15</a></span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-16-16><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-16>16</a></span><span>    record
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-16-17><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-17>17</a></span><span>      <span style=color:#ff6ac1>.</span>fetch(<span style=color:#5af78e>&#34;Events&#34;</span>, <span style=color:#ff6ac1>[]</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-16-18><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-18>18</a></span><span>      <span style=color:#ff6ac1>.</span>map { <span style=color:#ff6ac1>|</span>event<span style=color:#ff6ac1>|</span> build_event(event) }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-16-19><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-19>19</a></span><span>      <span style=color:#ff6ac1>.</span>reject(<span style=color:#ff6ac1>&amp;</span><span style=color:#5af78e>:nil?</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-16-20><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-20>20</a></span><span>      <span style=color:#ff6ac1>.</span>each { <span style=color:#ff6ac1>|</span>event<span style=color:#ff6ac1>|</span> agg<span style=color:#ff6ac1>.</span>apply(event) }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-16-21><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-21>21</a></span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-16-22><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-22>22</a></span><span>    <span style=color:#ff6ac1>if</span> agg<span style=color:#ff6ac1>.</span>uuid<span style=color:#ff6ac1>.</span>nil?
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-16-23><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-23>23</a></span><span>      <span style=color:#ff6ac1>nil</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-16-24><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-24>24</a></span><span>    <span style=color:#ff6ac1>else</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-16-25><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-25>25</a></span><span>      agg
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-16-26><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-26>26</a></span><span>    <span style=color:#ff6ac1>end</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-16-27><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-27>27</a></span><span>  <span style=color:#ff6ac1>end</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-16-28><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-28>28</a></span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-16-29><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-29>29</a></span><span>  <span style=color:#ff6ac1>def</span> <span style=color:#57c7ff>store</span>(agg)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-16-30><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-30>30</a></span><span>    update_aggregate_record(agg)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-16-31><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-31>31</a></span><span>    agg<span style=color:#ff6ac1>.</span>clear_changes
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-16-32><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-32>32</a></span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-16-33><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-33>33</a></span><span>    agg
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-16-34><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-34>34</a></span><span>  <span style=color:#ff6ac1>end</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-16-35><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-35>35</a></span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-16-36><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-36>36</a></span><span>  <span style=color:#ff6ac1>private</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-16-37><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-37>37</a></span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-16-38><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-38>38</a></span><span>  <span style=color:#ff6ac1>def</span> <span style=color:#57c7ff>fetch_aggregate_record</span>(uuid)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-16-39><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-39>39</a></span><span>    <span style=color:#ff5c57>@dynamodb_client</span><span style=color:#ff6ac1>.</span>get_item({
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-16-40><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-40>40</a></span><span>      <span style=color:#5af78e>table_name</span>: <span style=color:#ff5c57>@table_name</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-16-41><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-41>41</a></span><span>      <span style=color:#5af78e>key</span>: { <span style=color:#5af78e>Uuid</span>: uuid }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-16-42><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-42>42</a></span><span>    })<span style=color:#ff6ac1>.</span>item
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-16-43><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-43>43</a></span><span>  <span style=color:#ff6ac1>end</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-16-44><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-44>44</a></span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-16-45><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-45>45</a></span><span>  <span style=color:#ff6ac1>def</span> <span style=color:#57c7ff>update_aggregate_record</span>(agg)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-16-46><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-46>46</a></span><span>    new_events <span style=color:#ff6ac1>=</span> agg<span style=color:#ff6ac1>.</span>changes<span style=color:#ff6ac1>.</span>map { <span style=color:#ff6ac1>|</span>event<span style=color:#ff6ac1>|</span> { <span style=color:#5af78e>Name</span>: event<span style=color:#ff6ac1>.</span>class<span style=color:#ff6ac1>::</span><span style=color:#ff9f43>NAME</span>, <span style=color:#5af78e>Data</span>: event<span style=color:#ff6ac1>.</span>to_h } }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-16-47><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-47>47</a></span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-16-48><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-48>48</a></span><span>    <span style=color:#ff5c57>@dynamodb_client</span><span style=color:#ff6ac1>.</span>update_item({
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-16-49><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-49>49</a></span><span>      <span style=color:#5af78e>table_name</span>: <span style=color:#ff5c57>@table_name</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-16-50><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-50>50</a></span><span>      <span style=color:#5af78e>key</span>: {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-16-51><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-51>51</a></span><span>        <span style=color:#5af78e>Uuid</span>: agg<span style=color:#ff6ac1>.</span>uuid
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-16-52><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-52>52</a></span><span>      },
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-16-53><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-53>53</a></span><span>      <span style=color:#5af78e>update_expression</span>: <span style=color:#5af78e>&#34;SET #el = list_append(if_not_exists(#el, :empty_list), :new_events)&#34;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-16-54><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-54>54</a></span><span>      <span style=color:#5af78e>expression_attribute_names</span>: {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-16-55><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-55>55</a></span><span>        <span style=color:#5af78e>&#34;#el&#34;</span> <span style=color:#ff6ac1>=&gt;</span> <span style=color:#5af78e>&#34;Events&#34;</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-16-56><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-56>56</a></span><span>      },
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-16-57><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-57>57</a></span><span>      <span style=color:#5af78e>expression_attribute_values</span>: {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-16-58><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-58>58</a></span><span>        <span style=color:#5af78e>&#34;:empty_list&#34;</span> <span style=color:#ff6ac1>=&gt;</span> <span style=color:#ff6ac1>[]</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-16-59><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-59>59</a></span><span>        <span style=color:#5af78e>&#34;:new_events&#34;</span> <span style=color:#ff6ac1>=&gt;</span> new_events
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-16-60><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-60>60</a></span><span>      },
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-16-61><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-61>61</a></span><span>    })
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-16-62><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-62>62</a></span><span>  <span style=color:#ff6ac1>end</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-16-63><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-63>63</a></span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-16-64><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-64>64</a></span><span>  <span style=color:#ff6ac1>def</span> <span style=color:#57c7ff>build_event</span>(raw_event)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-16-65><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-65>65</a></span><span>    <span style=color:#ff5c57>@event_builder</span><span style=color:#ff6ac1>.</span>build(raw_event<span style=color:#ff6ac1>.</span>fetch(<span style=color:#5af78e>&#39;Name&#39;</span>), raw_event<span style=color:#ff6ac1>.</span>fetch(<span style=color:#5af78e>&#39;Data&#39;</span>))
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-16-66><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-66>66</a></span><span>  <span style=color:#ff6ac1>end</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-16-67><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-67>67</a></span><span><span style=color:#ff6ac1>end</span>
</span></span></code></pre></div><p>Our new <code>ShoppingCart</code>:</p><div class=highlight><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-17-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-17-1>1</a></span><span><span style=color:#ff6ac1>class</span> <span style=color:#f3f99d>ShoppingCartRepo</span> <span style=color:#ff6ac1>&lt;</span> <span style=color:#ff9f43>EsRepo</span> ; <span style=color:#ff6ac1>end</span>
</span></span></code></pre></div><p>This isn&rsquo;t the only way to accomplish this but I think it&rsquo;s pragmatic enough :). In this case, even the <code>ShoppingCartRepo</code> class isn&rsquo;t necessary from the perspective of initializing a repo but I think the Repo has a fundamental place in our code base and should still be represented as a first-class object.</p><h2 id=conclusion>Conclusion</h2><p>We&rsquo;ve brought our Aggregates full circle and can now create them and rehdrate them for future use. We&rsquo;ve done so be leveraging DynamoDB.</p><p>Next, we will take the first step into building event handlers for these events using <em>Change Data Capture</em>. We&rsquo;ll accomplish this using DynamoDB Streams and Lambda!</p><p>TODO</p><h1 id=dynamodb-and-cdc-1>DynamoDB and CDC</h1><ul><li>DynamoDB Streams and what are they</li><li>Implement OpenCart, GetCart, and AddItem Lambdas</li><li>Introduce Lambda to capture changes<ul><li>Pluck new events from Aggregate changes</li><li>Simple event logging for now</li></ul></li></ul><h1 id=kinesis-and-downstream-event-handlers-1>Kinesis and Downstream Event Handlers</h1><ul><li>What is Kinesis</li><li>Lambda that captures changes should publish to Kinesis<ul><li>Map DynamoDB to JSON</li><li>PutRecord/s</li></ul></li><li>EventHandler to handle</li><li>Publish to S3 for long term storage</li><li>Share idea on introducing a lambda to replay events</li><li>Improving Kinesis <a href=https://dashbird.io/blog/lambda-kinesis-trigger/>https://dashbird.io/blog/lambda-kinesis-trigger/</a></li></ul></div><br><div class=comments><div id=disqus_thread></div><script>var disqus_config=function(){this.page.url="https://apiercey.github.io/posts/event-sourcing-using-ruby-and-aws-serverless-technologies/aggregate-persistence/",this.page.identifier="jzvl7n37kAl7l"};(function(){var e=document,t=e.createElement("script");t.src="https://apiercey.disqus.com/embed.js",t.setAttribute("data-timestamp",+new Date),(e.head||e.body).appendChild(t)})()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript></div></div><div class=footer><div class=footer-social><span class="social-icon social-icon-github"><a href=https://github.com/apiercey title=github target=_blank rel=noopener><img src=/images/social/github.svg width=24 height=24 alt=github></a></span>
<span class="social-icon social-icon-linkedin"><a href=https://www.linkedin.com/in/alexander-butt-piercey title=linkedin target=_blank rel=noopener><img src=/images/social/linkedin.svg width=24 height=24 alt=linkedin></a></span>
<span class="social-icon social-icon-twitter"><a href=https://twitter.com/programincolour title=twitter target=_blank rel=noopener><img src=/images/social/twitter.svg width=24 height=24 alt=twitter></a></span></div></div></div><script type=text/javascript src=/js/bundle.min.28d149c65e8b43f935b5da6797544f9e363170785f466641db0d007cee894169.js></script>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-CX84WRHVTJ"></script>
<script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-CX84WRHVTJ")</script></body></html>