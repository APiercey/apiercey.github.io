<!doctype html><html lang=en><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="ie=edge"><title>Event Sourcing with Ruby and AWS Serverless Technologies - Part Three: The Event Store and DynamoDB - apiercey.github.io</title><meta name=viewport content="width=device-width,initial-scale=1"><link rel=icon href=https://apiercey.github.io/favicon.png><meta name=google-site-verification content="NumVaC4w3L9xrwd7wA91DomOegJLYQ-jIhXhWmK7Yd0"><meta name=robots content="index,follow"><link rel=stylesheet href=/css/style.min.b5158346cd0be7c685bb4907526f1b697a94560681b975b89e813e6095001706.css><meta name=description content="What an event store is, which responsibilities it has in an event sourcing system, and building its first component with DynamoDB."><meta name=keywords content="aws,event sourcing,event driven architecture,dynamodb,serverless,terraform,event store"><meta property="og:title" content="Event Sourcing with Ruby and AWS Serverless Technologies - Part Three: The Event Store and DynamoDB"><meta property="og:type" content="website"><meta property="og:url" content="https://apiercey.github.io/posts/event-sourcing-using-ruby-and-aws-serverless-technologies/event-store-dynamodb-tables/"><meta property="og:image" content="https://apiercey.github.io/images/aws-eventsourcing/eventstore-dynamodb.jpg"><meta property="og:description" content="What an event store is, which responsibilities it has in an event sourcing system, and building its first component with DynamoDB."><meta name=twitter:card content="summary"><meta name=twitter:site content="@programincolour"><meta name=twitter:creator content="@programincolour"><link rel=preconnect href=https://fonts.gstatic.com><link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;700&display=swap" rel=stylesheet></head><body class='page page-blog-single'><div id=menu-main-mobile class=menu-main-mobile><ul class=menu><li class=menu-item-about><a href=https://apiercey.github.io/pages/about/>About</a></li><li class=menu-item-blog><a href=https://apiercey.github.io/posts/>Blog</a></li><li class=menu-item-projects><a href=https://apiercey.github.io/projects/>Projects</a></li><li class=menu-item-articles><a href=https://apiercey.github.io/articles/>Articles</a></li></ul></div><div id=wrapper class=wrapper><div class=header><a class=header-logo href=/>apiercey.github.io</a><div class=menu-main><ul><li class=menu-item-about><a href=/pages/about/><span>About</span></a></li><li class="menu-item-blog active"><a href=/posts/><span>Blog</span></a></li><li class=menu-item-projects><a href=/projects/><span>Projects</span></a></li><li class=menu-item-articles><a href=/articles/><span>Articles</span></a></li></ul></div><div id=toggle-menu-main-mobile class=hamburger-trigger><button class=hamburger>Menu</button></div></div><div class=blog><div class=intro><h1>Event Sourcing with Ruby and AWS Serverless Technologies - Part Three: The Event Store and DynamoDB<span class=dot>.</span></h1><img src=/images/aws-eventsourcing/eventstore-dynamodb.jpg>
<i class=photo-credit><a href="https://instagram.com/moabitdottir?igshid=NTc4MTIwNjQ2YQ==">Single Water Reserve by Moabitdottir</a></i></div><div class=content><aside><h2>Table of Contents</h2><nav id=TableOfContents><ul><li><a href=#what-is-an-event-store>What is an Event Store</a></li><li><a href=#designing-an-event-store>Designing an Event Store</a><ul><li><a href=#the-ability-to-persist-ordered-events>The Ability to Persist Ordered Events</a></li><li><a href=#the-ability-to-fetch-a-range-of-events>The Ability to Fetch a Range of Events</a></li><li><a href=#the-ability-to-push-events-to-downstream-listeners>The Ability to Push Events to Downstream Listeners</a></li><li><a href=#the-ability-to-prevent-conflicting-changes-happening-at-the-same-time>The Ability to Prevent Conflicting Changes Happening at the Same Time</a></li><li><a href=#design-overview>Design Overview</a></li></ul></li><li><a href=#dynamodb-events-table>DynamoDB Events Table</a><ul><li><a href=#defining-the-module>Defining the Module</a></li><li><a href=#using-the-module>Using the Module</a></li></ul></li><li><a href=#conclusion>Conclusion</a></li></ul></nav></aside><p><em>This is the third part in an on-going blog series about <a href=/posts/event-sourcing-using-ruby-and-aws-serverless-technologies/introduction>building an event sourcing system in Ruby using AWS Serverless technologies</a>.</em></p><p><em>It was originally part of Aggregate Persistence. It grew a little bit too large for my tastes and I opted to separate this portion into it&rsquo;s own article. Enjoy!</em></p><p>In event sourcing, events are stored in a database called an event store. We’ll design one using AWS Serverless technologies and it will be the backbone of future articles that extend the event store.</p><p>After the overview, we&rsquo;ll implement the first component - the DynamoDB table.</p><h2 id=what-is-an-event-store>What is an Event Store</h2><p>Event stores are databases for event sourcing systems. It’s often built on top of existing database technologies, such as PostgreSQL, to meet specific event sourcing criteria. It allows querying and persisting events and is the single source of truth for system data.</p><p>Events are stored in an append-only table. Meaning, events are immutable and inserted only at the <em>end</em> of the table.</p><p>When events are appended, they become available to the external world through polling or consumers reacting to them on streams. This is usually facilitated through a CDC feature of the database or by external technologies and make events available to downstream consumers.</p><p>As event sourcing has become more popular, databases specifically designed to be event stores have emerged.</p><p>For example, <a href=https://www.eventstore.com/>EventStoreDB</a>, originally released by <a href=https://twitter.com/gregyoung>Greg Young</a>, is an event store that packages persistence and streaming needs into a single technology. It’s tuned to meet event sourcing needs and cannot be used as a relational database or document storage.</p><p>Open source event stores built on top of existing technologies have emerged as well. <a href=https://martendb.io/>MartenDB</a> is a great example of this. It provides features to act as both an event store and document storage.</p><p><img src=/images/aws-eventsourcing/event-store-table.jpg alt="Event Store Table"></p><h2 id=designing-an-event-store>Designing an Event Store</h2><p>While an event store may be implemented with many different technologies it should meet 4 key criteria:</p><ul><li>The ability to persist ordered events.</li><li>The ability to fetch a range of events (or all events).</li><li>The ability to push events to downstream listeners.</li><li>The ability to prevent conflicting changes happening at the same time.</li></ul><p>Our event store will be implemented using DynamoDB, Lambda, and Kinesis. Let&rsquo;s review each criteria in turn.</p><h3 id=the-ability-to-persist-ordered-events>The Ability to Persist Ordered Events</h3><p>Event ordering is paramount for event sourced aggregates. Aggregate events out of order can have diasterous effects.</p><p>For example, in accounting systems, accounts that are overdrawn (have negative funds) are usually subject to fixed fees regardless of the time span they are overdrawn.</p><p>Let&rsquo;s say Bob deposits 100 dollars on Monday and withdraws 50 dollars on Tuesday. This means there are two events stored in the event store:</p><ul><li>FundsWithdrawn: $100 on Monday</li><li>FundsDeposited: $50 on Tuesday</li></ul><p>If the downstream application responsible for applying overdrawn fees received the FundsDeposited event first before the FundsWithdrawn, poor Bob would loss money (and the customer support member receiving a not-so-fun phone call)!</p><h3 id=the-ability-to-fetch-a-range-of-events>The Ability to Fetch a Range of Events</h3><p>A flexible event store allows fetching events from any time range. Traditionally, when using an event store to rehydrate an aggregate, all events are fetched to build up the state. Expressed as <em><code>[first..last]</code></em></p><p>However, some aggregates may be more popular than others and outside its normal lifecycle. In such cases, these aggregates may have hundreds of events and rehydration takes substantially longer than normal and consumes far greater amounts of memory.</p><p>Through a process called <em>snapshoting</em> an aggregate&rsquo;s complete state may be recorded as an event. From there, only a range starting from the <em>last</em> snapshot till the latest event is necessary. Expressed as <em><code>[n..last]</code></em></p><p>Finally, in some cases a historical range needs to be examined. Expressed as <em><code>[a..b]</code></em>.</p><p>There are two common cases:</p><ul><li>An audit or inspection question is posed, &ldquo;When did <em>x</em> happen to aggregate <em>y</em>?&rdquo;.</li><li>A report must be composed. A range of events can be replayed, building report information.</li></ul><p>Snapshoting is outside the scope of this series, however, as it comes with its own set of challenges. It&rsquo;s imperative to be aware of the pattern if you are experiencing this problem.</p><h3 id=the-ability-to-push-events-to-downstream-listeners>The Ability to Push Events to Downstream Listeners</h3><p><a href=../system-design/#what-problem-does-it-solve>In the first article</a>, one of the primary reasons for introducing event sourcing is to provide stronger guarantees when informing interested parties about data changes. Therefore, this requirement falls under the scope of responsibility of the event store.</p><p>An event store which does not provide this functionality may still be used but the burden falls on either the engineer utilizing the event store to provide a mechanism of informing interested parties or said parties must periodically query the event store looking for new events.</p><h3 id=the-ability-to-prevent-conflicting-changes-happening-at-the-same-time>The Ability to Prevent Conflicting Changes Happening at the Same Time</h3><p>Consider two requests entering a system at the same time, requesting to change a person&rsquo;s name.</p><ol><li>Request One opens a transaction.</li><li>Request Two opens a transaction.</li><li>Request One changes the person&rsquo;s name to &ldquo;Alex&rdquo;</li><li>Request Two changes the person&rsquo;s name to &ldquo;Alexander&rdquo;</li><li>Request Two commits the transaction.</li><li>Request One commits the transaction.</li></ol><p>Despite starting last, request two beats request one to the punch. This software would leave users confused about why their name isn&rsquo;t what they expected.</p><p>In a more series scenario, such as moving money between accounts, the risk can be much higher. A well-designed event store prevents such scenarios from transpiring.</p><p>The most accepted approach is a strategy known as <em>Optimistic Locking</em>. We&rsquo;ll discuss this in detail in this article.</p><h3 id=design-overview>Design Overview</h3><p>Our event store will utilize four AWS technologies to meet the key criteria:</p><ul><li>DynamoDB to store aggregate events and provide optimistic locking. It will act as hot storage.</li><li>Kinesis Streams for pushing events to our to interested parties.</li><li>S3 Bucket to store aggregates events for long term storage. It will act as cold storage.</li><li>Two Lambdas:<ul><li>The first to capture newly added events added to our DynamoDB table and push them to our Kinesis Stream. This will act as an event publisher.</li><li>The second subscribes to the Kinesis stream and records events to the cold storage (the S3 Bucket).</li></ul></li></ul><p><img src=/images/aws-eventsourcing/eventstore-design.jpg alt="Event Store Design"></p><h4 id=hot-vs-cold-storage>Hot vs Cold Storage</h4><p>The hot event storage provides immediate access to events and allows the insertion of new events under optimistic locking. Here, guarantees are made about the data being inserted into the store. Any events added here gain immediate consistency.</p><p>Reading these events must be fast and in tune with our store&rsquo;s non-functional <em>Write</em> requirements.</p><p>On the opposite side, cold event storage provides infrequent access more aligned with out store&rsquo;s non-function <em>Read</em> requirements.</p><p>Large batches of events can be read without impacting write-side performance and subjecting ourselves to large overhead costs.</p><p>For example, with tools such as <a href=https://aws.amazon.com/athena/>Athena</a>, we can query our events using SQL to build reports or derive business insights.</p><h2 id=dynamodb-events-table>DynamoDB Events Table</h2><p>DynamoDB is a serverless Document DB from AWS that scales according to demand. A DynamoDB table does not belong to an overarching entity, unlike traditional databases.</p><p>To implement a table, it requires only a few things:</p><ul><li>A table name.</li><li>A primary key, called a hash key. Must be unique.</li><li>And optionally, a range key, which acts as a second lookup key. Must be unique only for its primary key.</li></ul><p>The primary key will act as the lookup key for the value. It&rsquo;s possible to provide additional lookup keys, called Global or Local Secondaries, but they won&rsquo;t be necessary for our implementation.</p><p>Our first piece of Infrastructure as Code will be our table. We&rsquo;ll define both the table and a <code>event_store</code> module for future components.</p><h3 id=defining-the-module>Defining the Module</h3><p>Firstly, we&rsquo;ll need to setup our infrastructure directory to use the AWS platform.</p><div class=highlight><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-1>1</a></span><span><span style=color:#78787e># cd to an empty directory you choose</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-2>2</a></span><span>touch providers.tf
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-terraform data-lang=terraform><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-1>1</a></span><span><span style=color:#ff6ac1>provider</span> <span style=color:#5af78e>&#34;aws&#34;</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-2>2</a></span><span>  <span style=color:#57c7ff>version</span> = <span style=color:#5af78e>&#34;~&gt; 4.57&#34;</span><span style=color:#78787e> # Version used at the time of writing
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-3>3</a></span><span><span style=color:#78787e></span>  <span style=color:#57c7ff>region</span>  = <span style=color:#5af78e>&#34;us-east-1&#34;</span><span style=color:#78787e> # Change this if you wish
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-4>4</a></span><span><span style=color:#78787e></span>}
</span></span></code></pre></div><p>Next, the event store. A Terraform module is simply a directory.</p><div class=highlight><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-2-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-1>1</a></span><span>mkdir event_store
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-2-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-2>2</a></span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-2-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-3>3</a></span><span>touch event_store/variables.tf
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-2-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-4>4</a></span><span>touch event_store/outputs.tf
</span></span></code></pre></div><p>Our event store will require a name, which we can supply as a variable.</p><div class=highlight><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-terraform data-lang=terraform><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-3-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-3-1>1</a></span><span><span style=color:#78787e># event_store/variables.tf
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-3-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-3-2>2</a></span><span><span style=color:#78787e></span><span style=color:#ff6ac1>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-3-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-3-3>3</a></span><span><span style=color:#ff6ac1>variable</span> <span style=color:#5af78e>&#34;name&#34;</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-3-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-3-4>4</a></span><span>  <span style=color:#57c7ff>type</span> = string
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-3-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-3-5>5</a></span><span>}
</span></span></code></pre></div><p>Next, we&rsquo;ll define our events table.</p><div class=highlight><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-4-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-1>1</a></span><span>touch event_store/dynamodb.tf
</span></span></code></pre></div><p>The hash key (primary key) will be named <code>AggregateUuid</code> and store our aggregate&rsquo;s identifier.</p><p>We&rsquo;ll also include a range key named <code>Version</code>. Versions facilitate Optimistic Locking, so we&rsquo;ll dive deeper later. Unfortunately, due to a flaw in DynamoDB we must provide range keys upfront if we wish to use them.</p><div class=highlight><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-terraform data-lang=terraform><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-1> 1</a></span><span><span style=color:#78787e># event_store/dynamodb.tf
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-2> 2</a></span><span><span style=color:#78787e></span><span style=color:#ff6ac1>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-3> 3</a></span><span><span style=color:#ff6ac1>resource</span> <span style=color:#5af78e>&#34;aws_dynamodb_table&#34;</span> <span style=color:#5af78e>&#34;es_table&#34;</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-4> 4</a></span><span>  <span style=color:#57c7ff>name</span>     = <span style=color:#5af78e>&#34;</span><span style=color:#5af78e>${</span><span style=color:#ff5c57>var</span>.name<span style=color:#5af78e>}</span><span style=color:#5af78e>-es-table&#34;</span><span style=color:#78787e> # Note the variable here
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-5> 5</a></span><span><span style=color:#78787e></span>  <span style=color:#57c7ff>hash_key</span> = <span style=color:#5af78e>&#34;AggregateUuid&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-6> 6</a></span><span>  <span style=color:#57c7ff>range_key</span> = <span style=color:#5af78e>&#34;Version&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-7> 7</a></span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-8> 8</a></span><span>  attribute {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-9> 9</a></span><span>    <span style=color:#57c7ff>name</span> = <span style=color:#5af78e>&#34;AggregateUuid&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-10><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-10>10</a></span><span>    <span style=color:#57c7ff>type</span> = <span style=color:#5af78e>&#34;S&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-11><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-11>11</a></span><span>  }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-12><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-12>12</a></span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-13><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-13>13</a></span><span>  attribute {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-14><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-14>14</a></span><span>    <span style=color:#57c7ff>name</span> = <span style=color:#5af78e>&#34;Version&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-15><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-15>15</a></span><span>    <span style=color:#57c7ff>type</span> = <span style=color:#5af78e>&#34;N&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-16><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-16>16</a></span><span>  }<span style=color:#78787e>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-17><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-17>17</a></span><span><span style=color:#78787e>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-18><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-18>18</a></span><span><span style=color:#78787e>  # For testing purposes, these values will do just fine
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-19><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-19>19</a></span><span><span style=color:#78787e></span>  <span style=color:#57c7ff>read_capacity</span> = <span style=color:#ff9f43>1</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-20><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-20>20</a></span><span>  <span style=color:#57c7ff>write_capacity</span> = <span style=color:#ff9f43>1</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-21><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-21>21</a></span><span>}
</span></span></code></pre></div><h3 id=using-the-module>Using the Module</h3><p>Now our module is ready to be used. Let&rsquo;s define the module in our infrastructure directory.</p><div class=highlight><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-6-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-1>1</a></span><span>touch event_store.tf
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-terraform data-lang=terraform><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-1>1</a></span><span><span style=color:#78787e># event_store.tf
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-2>2</a></span><span><span style=color:#78787e></span><span style=color:#ff6ac1>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-3>3</a></span><span><span style=color:#ff6ac1>module</span> <span style=color:#5af78e>&#34;event-store&#34;</span> {<span style=color:#78787e> # May be whatever name you choose. Must be unique.
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-4>4</a></span><span><span style=color:#78787e></span>  <span style=color:#57c7ff>source</span> = <span style=color:#5af78e>&#34;./event_store&#34;</span><span style=color:#78787e> # points to a directory
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-5>5</a></span><span><span style=color:#78787e></span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-6>6</a></span><span>  <span style=color:#57c7ff>name</span> = <span style=color:#5af78e>&#34;scd&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-7>7</a></span><span>}
</span></span></code></pre></div><p>Our <code>event-store</code> module sources the previously defined custom module. By doing so, it will build all infrastructure resources defined within that module and treat them as a group.</p><p>We can build our infrastructure by running terraform apply.</p><div class=highlight><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-8-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-1>1</a></span><span>$ terraform apply
</span></span></code></pre></div><p>Logging into AWS and looking at DynamoDB, we can see our table. One really great feature of DynamoDB is that you can inspect tables and their items from the console which makes debugging a breeze.</p><p><img src=/images/aws-eventsourcing/dynamodb-scd.png alt="Events Table"></p><p>We&rsquo;ll implement additional components in future articles. For now, only DynamoDB is necessary for persisting aggregates.</p><h2 id=conclusion>Conclusion</h2><p>We&rsquo;ve reviewed our event store design and implemented the DynamoDB table component. The event store itself is broken up into different AWS serverless technologies used to meet the key criteria.</p><p>Next, we will start persisting our aggregates using the <em>repository pattern</em> and our DynamoDB table.</p></div><br><div class=comments><script src=https://utteranc.es/client.js repo=APiercey/utterances issue-number=1 label=utterances theme=github-light crossorigin=anonymous async></script></div></div><div class=footer><div class=footer-social><span class="social-icon social-icon-github"><a href=https://github.com/apiercey title=github target=_blank rel=noopener><img src=/images/social/github.svg width=24 height=24 alt=github></a></span>
<span class="social-icon social-icon-linkedin"><a href=https://www.linkedin.com/in/alexander-butt-piercey title=linkedin target=_blank rel=noopener><img src=/images/social/linkedin.svg width=24 height=24 alt=linkedin></a></span>
<span class="social-icon social-icon-twitter"><a href=https://twitter.com/programincolour title=twitter target=_blank rel=noopener><img src=/images/social/twitter.svg width=24 height=24 alt=twitter></a></span></div></div></div><script type=text/javascript src=/js/bundle.min.28d149c65e8b43f935b5da6797544f9e363170785f466641db0d007cee894169.js></script>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-CX84WRHVTJ"></script>
<script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-CX84WRHVTJ")</script></body></html>