<!doctype html><html lang=en><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="ie=edge"><title>Event Sourcing with Ruby and AWS Serverless Technologies - Part Two: Aggregate Design - apiercey.github.io</title><meta name=viewport content="width=device-width,initial-scale=1"><link rel=icon href=https://apiercey.github.io/favicon.png><meta name=google-site-verification content="NumVaC4w3L9xrwd7wA91DomOegJLYQ-jIhXhWmK7Yd0"><meta name=robots content="index,follow"><link rel=stylesheet href=/css/style.min.3f38d2f71e5638fceca4fb8a10a2fbeb1f6f14c7e4c6581a5c10f939b74fca0f.css><meta name=description content="How Aggregates are designed and the role events play in altering their state."><meta name=keywords content="event sourcing,ruby,aggregates,cqrs,event driven architecture,read projections,meta-programming"><meta property="og:title" content="Event Sourcing with Ruby and AWS Serverless Technologies - Part Two: Aggregate Design"><meta property="og:type" content="website"><meta property="og:url" content="https://apiercey.github.io/posts/event-sourcing-using-ruby-and-aws-serverless-technologies/aggregate-design/"><meta property="og:image" content="https://apiercey.github.io/images/aws-eventsourcing/elbphilharmonie-hamburg.jpg"><meta property="og:description" content="How Aggregates are designed and the role events play in altering their state."><meta name=twitter:card content="summary"><meta name=twitter:site content="@programincolour"><meta name=twitter:creator content="@programincolour"><link rel=preconnect href=https://fonts.gstatic.com><link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;700&display=swap" rel=stylesheet></head><body class='page page-blog-single'><div id=menu-main-mobile class=menu-main-mobile><ul class=menu><li class=menu-item-about><a href=https://apiercey.github.io/pages/about/>About</a></li><li class=menu-item-blog><a href=https://apiercey.github.io/posts/>Blog</a></li><li class=menu-item-projects><a href=https://apiercey.github.io/projects/>Projects</a></li><li class=menu-item-articles><a href=https://apiercey.github.io/articles/>Articles</a></li></ul></div><div id=wrapper class=wrapper><div class=header><a class=header-logo href=/>apiercey.github.io</a><div class=menu-main><ul><li class=menu-item-about><a href=/pages/about/><span>About</span></a></li><li class="menu-item-blog active"><a href=/posts/><span>Blog</span></a></li><li class=menu-item-projects><a href=/projects/><span>Projects</span></a></li><li class=menu-item-articles><a href=/articles/><span>Articles</span></a></li></ul></div><div id=toggle-menu-main-mobile class=hamburger-trigger><button class=hamburger>Menu</button></div></div><div class=blog><div class=intro><h1>Event Sourcing with Ruby and AWS Serverless Technologies - Part Two: Aggregate Design<span class=dot>.</span></h1><img src=/images/aws-eventsourcing/elbphilharmonie-hamburg.jpg>
<i class=photo-credit><a href="https://instagram.com/moabitdottir?igshid=NTc4MTIwNjQ2YQ==">Elbphilharmonie Hamburg by Moabitdottir</a></i></div><div class=content><aside><h2>Table of Contents</h2><nav id=TableOfContents><ul><li><a href=#aggregate-crash-course>Aggregate Crash Course</a></li><li><a href=#aggregates-in-ruby>Aggregates in Ruby</a><ul><li><a href=#aggregate-design-defining-a-shoppingcart>Aggregate Design: Defining a ShoppingCart</a></li><li><a href=#aggregate-design-events>Aggregate Design: Events</a></li><li><a href=#aggregate-design-publishing-events>Aggregate Design: Publishing Events</a></li><li><a href=#aggregate-design-applying-events>Aggregate Design: Applying Events</a></li><li><a href=#aggregate-design-cqrs-intermission>Aggregate Design: CQRS Intermission</a></li><li><a href=#aggregate-design-command-methods>Aggregate Design: Command Methods</a></li><li><a href=#aggregate-design-enforcing-business-constraints>Aggregate Design: Enforcing Business Constraints</a></li></ul></li><li><a href=#conclusion>Conclusion</a></li></ul></nav></aside><p><em>This is the second part in an on-going blog series about <a href=/posts/event-sourcing-using-ruby-and-aws-serverless-technologies/introduction>building an event sourcing system in Ruby using AWS Serverless technologies</a>.</em></p><p>Aggregate design is at the center of how event sourcing systems operate. They encapsulate our events into a greater meaning than the sum of its parts.</p><p>We will implement our ShoppingCart aggregate, the events it publishes, and how these events are applied to alter its state. This will be the foundation of our system.</p><h2 id=aggregate-crash-course>Aggregate Crash Course</h2><p>Let&rsquo;s briefly discuss what they are and which problem they solve.</p><p>Aggregates are groups of objects that enforce business constraints with <strong>one</strong> acting as the root object. The root object acts as the spokesobject for the others and nothing can access the internal objects without traversing the root object first. In DDD nomenclature, these objects are composed of Entities and Value objects.</p><p>This means things <em>outside</em> of the aggregate cannot reference an internal object directly - it must always ask the root object for access to its internal objects.</p><img src=/images/aws-eventsourcing/aggregate.jpg width=400px style=display:block;align-self:center;margin-left:auto;margin-right:auto><p>For example, consider a ledger system that carries Accounts and Bookings. The diagram below shows a Booking Monitoring Class that needs access to an account&rsquo;s bookings. On the left, the Booking Monitoring Class gains access to these bookings by requesting them through the Aggregate Root entity&rsquo;s public interface. While on the right, the same class incorrectly gains access by circumventing the Aggregate Root and accessing bookings directly.</p><p>In the example on the right, the aggregate provides <em>weak</em> protection against direct access.</p><p><img src=/images/aws-eventsourcing/aggregate-access.jpg alt="Aggregate Access"></p><p>This has several fantastic benefits.</p><p>First, meaningful relationships between objects in your domain are formed, instead of ones that are logically derived, making your domain model more expressive.</p><p>Second, because external entities must always interact through the aggregate root, system constraints must always be located within an aggregate. This gives the application&rsquo;s critical rules a singular home and protects multiple (and often different) implementations of a rule throughout an application.</p><p>Lastly, an entire aggregate is treated as a <em>object collection boundary</em>. These objects live together and their state is singular, persisted and rehydrated from the data store as a single cohesive unit. This provides assurance the state is fully loaded and ready.</p><div class=highlight><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-1>1</a></span><span>account <span style=color:#ff6ac1>=</span> <span style=color:#ff9f43>AccountRepository</span><span style=color:#ff6ac1>.</span>fetch(account_identifier)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-2>2</a></span><span><span style=color:#ff6ac1>=&gt;</span> <span style=color:#78787e>#&lt;Account @uuid=&#34;...&#34; @bookings=[#&lt;Booking ...&gt;, ...]&gt;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-3>3</a></span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-4>4</a></span><span><span style=color:#78787e># account traverses through the ledger object </span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-5>5</a></span><span>account<span style=color:#ff6ac1>.</span>bookings
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-0-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-0-6>6</a></span><span><span style=color:#ff6ac1>=&gt;</span> <span style=color:#ff6ac1>[</span><span style=color:#78787e>#&lt;Booking ...&gt;, ...]</span>
</span></span></code></pre></div><p>The account is the gatekeeper for all business logic. If we need to execute logic against a booking, we must go through the account:</p><div class=highlight><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-1>1</a></span><span>account.revert_booking(booking_uuid)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-1-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-1-2>2</a></span><span>=&gt; #&lt;Account @uuid=&#34;...&#34; @bookings=[#&lt;Booking ...&gt;, ...]&gt;
</span></span></code></pre></div><p>Our Account aggregate enforces one additional rule; <strong>a booking cannot exist without being associated with an account</strong>. As this is intentional, we must <em>neglect</em> to create the means of fetching bookings into memory.</p><p>If you have further interest in aggregate design, I highly recommend the following articles:</p><ul><li><a href=https://medium.com/ssense-tech/ddd-beyond-the-basics-mastering-aggregate-design-26591e218c8c>https://medium.com/ssense-tech/ddd-beyond-the-basics-mastering-aggregate-design-26591e218c8c</a></li><li><a href=https://martinfowler.com/bliki/DDD_Aggregate.html>https://martinfowler.com/bliki/DDD_Aggregate.html</a></li></ul><h2 id=aggregates-in-ruby>Aggregates in Ruby</h2><p>Like other architectures born from circles practicing <a href=https://en.wikipedia.org/wiki/Domain-driven_design>Domain-Driven Design</a>, event sourcing focuses on modeling software to match a domain by taking critical concepts given to engineers by domain experts.</p><p>It achieves this by removing the burden of model objects aware of data persistence and elevating facts into events.</p><p>Often, the flow of executing business logic in event sourcing looks like this:</p><p>An aggregate is firstly retrieved from its repository class. Next, a method is executed to carry out a portion of business logic, and in doing so, <em>publishes</em> an event. Whenever an event is published, the aggregate immediately <em>applies</em> it against itself, changing its own state.</p><p>Finally, the aggregate is persisted using its repository class. Published events are pushed to an event stream.</p><p>This means that:</p><ul><li>Methods for executing business logic are responsible for <em>enforcing</em> the rules (E.g. Account balance cannot go below zero!)</li><li>For every action that modifies an aggregate, there is an event.</li><li>Newly published events to an aggregate are stored in memory, waiting to be persisted.</li><li>Aggregates will publish many events over their lifetime.</li></ul><h3 id=aggregate-design-defining-a-shoppingcart>Aggregate Design: Defining a ShoppingCart</h3><p>Our shopping cart will be simple: You can open a shopping cart and add items to it. We&rsquo;ll start with a tiny class definition.</p><div class=highlight><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-2-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-1>1</a></span><span><span style=color:#ff6ac1>class</span> <span style=color:#f3f99d>ShoppingCart</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-2-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-2>2</a></span><span>  <span style=color:#ff6ac1>attr_reader</span> <span style=color:#5af78e>:items</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-2-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-2-3>3</a></span><span><span style=color:#ff6ac1>end</span>
</span></span></code></pre></div><p>Now, we&rsquo;re ready to explore publishing our first event.</p><p>To create an aggregate, it needs two things:</p><ul><li>An identifier, ussually a <a href=UUID>UUID</a></li><li>An event which signifies the <em>starting</em> event of that aggregate. In the CRUD world, this is the <em>creation event</em>.</li></ul><h3 id=aggregate-design-events>Aggregate Design: Events</h3><p>Events themselves are simple. They are static structures that describe <em>facts</em> that have happened. They follow only a few rules:</p><p><strong><em>They are immutable.</em></strong></p><p><strong><em>They are named in the past tense.</em></strong></p><p><strong><em>They describe a meaningful concept in the domain.</em></strong></p><p>Let&rsquo;s define our first event.</p><div class=highlight><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-3-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-3-1>1</a></span><span><span style=color:#ff6ac1>class</span> <span style=color:#f3f99d>CartOpened</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-3-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-3-2>2</a></span><span>  <span style=color:#ff6ac1>attr_reader</span> <span style=color:#5af78e>:shopping_cart_uuid</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-3-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-3-3>3</a></span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-3-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-3-4>4</a></span><span>  <span style=color:#ff6ac1>def</span> <span style=color:#57c7ff>initialize</span>(shopping_cart_uuid)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-3-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-3-5>5</a></span><span>    <span style=color:#ff5c57>@shopping_cart_uuid</span> <span style=color:#ff6ac1>=</span> shopping_cart_uuid
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-3-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-3-6>6</a></span><span>  <span style=color:#ff6ac1>end</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-3-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-3-7>7</a></span><span><span style=color:#ff6ac1>end</span>
</span></span></code></pre></div><p>Simple and neat. When a <code>CartOpened</code> object is instantiated, its members cannot be altered. Additionally, its name is in the past tense and describes a core behaviour of our system.</p><h3 id=aggregate-design-publishing-events>Aggregate Design: Publishing Events</h3><p>Let&rsquo;s implement just enough of our first aggregate to publish our event.</p><div class=highlight><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-4-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-1> 1</a></span><span><span style=color:#ff6ac1>module</span> Aggregate
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-4-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-2> 2</a></span><span>  <span style=color:#ff6ac1>def</span> <span style=color:#f3f99d>self</span><span style=color:#ff6ac1>.</span><span style=color:#57c7ff>included</span>(base)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-4-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-3> 3</a></span><span>    base<span style=color:#ff6ac1>.</span>class_eval <span style=color:#ff6ac1>do</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-4-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-4> 4</a></span><span>      <span style=color:#ff6ac1>attr_reader</span> <span style=color:#5af78e>:uuid</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-4-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-5> 5</a></span><span>    <span style=color:#ff6ac1>end</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-4-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-6> 6</a></span><span>  <span style=color:#ff6ac1>end</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-4-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-7> 7</a></span><span>  
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-4-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-8> 8</a></span><span>  <span style=color:#ff6ac1>def</span> <span style=color:#57c7ff>changes</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-4-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-9> 9</a></span><span>    <span style=color:#ff5c57>@changes</span> <span style=color:#ff6ac1>||=</span> <span style=color:#ff6ac1>[]</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-4-10><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-10>10</a></span><span>  <span style=color:#ff6ac1>end</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-4-11><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-11>11</a></span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-4-12><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-12>12</a></span><span>  <span style=color:#ff6ac1>private</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-4-13><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-13>13</a></span><span>  
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-4-14><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-14>14</a></span><span>  <span style=color:#ff6ac1>def</span> <span style=color:#57c7ff>enqueue</span>(event)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-4-15><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-15>15</a></span><span>    changes<span style=color:#ff6ac1>.</span>append(event)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-4-16><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-16>16</a></span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-4-17><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-17>17</a></span><span>    <span style=color:#ff5c57>self</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-4-18><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-18>18</a></span><span>  <span style=color:#ff6ac1>end</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-4-19><a style=outline:none;text-decoration:none;color:inherit href=#hl-4-19>19</a></span><span><span style=color:#ff6ac1>end</span>
</span></span></code></pre></div><p>Our <code>aggregate</code> module will host the abstract behaviour of all aggregates. It&rsquo;s responsible for managing <code>changes</code> as events and the aggregate <code>uuid</code>.</p><p>Whenever an event is queued to be published using the <code>enqueue</code> method, it stores that event as a <code>change</code>. We will see how these changes can be applied and published later.</p><div class=highlight><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-1> 1</a></span><span><span style=color:#ff6ac1>class</span> <span style=color:#f3f99d>ShoppingCart</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-2> 2</a></span><span>  <span style=color:#ff6ac1>include</span> <span style=color:#ff9f43>Aggregate</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-3> 3</a></span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-4> 4</a></span><span>  <span style=color:#ff6ac1>attr_reader</span> <span style=color:#5af78e>:items</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-5> 5</a></span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-6> 6</a></span><span>  <span style=color:#ff6ac1>def</span> <span style=color:#57c7ff>initialize</span>(uuid)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-7> 7</a></span><span>    <span style=color:#ff5c57>@items</span> <span style=color:#ff6ac1>=</span> <span style=color:#ff6ac1>[]</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-8> 8</a></span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-9> 9</a></span><span>    enqueue(<span style=color:#ff9f43>CartOpened</span><span style=color:#ff6ac1>.</span>new(uuid))
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-10><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-10>10</a></span><span>  <span style=color:#ff6ac1>end</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-5-11><a style=outline:none;text-decoration:none;color:inherit href=#hl-5-11>11</a></span><span><span style=color:#ff6ac1>end</span>
</span></span></code></pre></div><p>When our <code>ShoppingCart</code> is instantiated, it will generate a <code>CartOpened</code> event and queue this change to be published.</p><div class=highlight><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-6-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-1>1</a></span><span><span style=color:#ff9f43>ShoppingCart</span><span style=color:#ff6ac1>.</span>new(<span style=color:#5af78e>&#34;test-uuid&#34;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-6-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-6-2>2</a></span><span><span style=color:#ff6ac1>=&gt;</span> <span style=color:#78787e>#&lt;ShoppingCart:0x0000000155b7cd60 @items=[], @changes=[#&lt;CartOpened:0x0000000155b7cd10 @shopping_cart_uuid=&#34;test-uuid&#34;&gt;]&gt;</span>
</span></span></code></pre></div><p>We can see a change has been queued, waiting to be applied. We are now ready to move forward with the right foundation.</p><h3 id=aggregate-design-applying-events>Aggregate Design: Applying Events</h3><p>Our ShoppingCart aggregate understands events and can queue them, but lacks the means to alter its own state. As an example from the step above, it has no <code>uuid</code>. Let&rsquo;s expand our <code>aggregate</code> module to start applying events.</p><div class=highlight><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-1> 1</a></span><span><span style=color:#ff6ac1>module</span> Aggregate
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-2> 2</a></span><span>  <span style=color:#ff6ac1>def</span> <span style=color:#f3f99d>self</span><span style=color:#ff6ac1>.</span><span style=color:#57c7ff>included</span>(base)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-3> 3</a></span><span>    base<span style=color:#ff6ac1>.</span>class_eval <span style=color:#ff6ac1>do</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-4> 4</a></span><span>      <span style=color:#ff6ac1>attr_reader</span> <span style=color:#5af78e>:uuid</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-5> 5</a></span><span>      
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-6> 6</a></span><span>      <span style=color:#ff6ac1>def</span> <span style=color:#f3f99d>self</span><span style=color:#ff6ac1>.</span><span style=color:#57c7ff>on</span>(event_class, <span style=color:#ff6ac1>&amp;</span>block)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-7> 7</a></span><span>        define_method <span style=color:#5af78e>&#34;apply_</span><span style=color:#5af78e>#{</span>event_class<span style=color:#ff6ac1>::</span><span style=color:#ff9f43>NAME</span><span style=color:#5af78e>}</span><span style=color:#5af78e>&#34;</span>, <span style=color:#ff6ac1>&amp;</span>block
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-8> 8</a></span><span>      <span style=color:#ff6ac1>end</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-9> 9</a></span><span>    <span style=color:#ff6ac1>end</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-10><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-10>10</a></span><span>  <span style=color:#ff6ac1>end</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-11><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-11>11</a></span><span>  
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-12><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-12>12</a></span><span>  <span style=color:#ff6ac1>def</span> <span style=color:#57c7ff>changes</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-13><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-13>13</a></span><span>    <span style=color:#ff5c57>@changes</span> <span style=color:#ff6ac1>||=</span> <span style=color:#ff6ac1>[]</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-14><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-14>14</a></span><span>  <span style=color:#ff6ac1>end</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-15><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-15>15</a></span><span>  
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-16><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-16>16</a></span><span>  <span style=color:#ff6ac1>def</span> <span style=color:#57c7ff>apply</span>(event)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-17><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-17>17</a></span><span>    <span style=color:#ff5c57>self</span><span style=color:#ff6ac1>.</span>send(<span style=color:#5af78e>&#34;apply_</span><span style=color:#5af78e>#{</span>event<span style=color:#ff6ac1>.</span>class<span style=color:#ff6ac1>::</span><span style=color:#ff9f43>NAME</span><span style=color:#5af78e>}</span><span style=color:#5af78e>&#34;</span>, event)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-18><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-18>18</a></span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-19><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-19>19</a></span><span>    <span style=color:#ff5c57>self</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-20><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-20>20</a></span><span>  <span style=color:#ff6ac1>end</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-21><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-21>21</a></span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-22><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-22>22</a></span><span>  <span style=color:#ff6ac1>private</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-23><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-23>23</a></span><span>  
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-24><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-24>24</a></span><span>  <span style=color:#ff6ac1>def</span> <span style=color:#57c7ff>enqueue</span>(event)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-25><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-25>25</a></span><span>    apply(event)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-26><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-26>26</a></span><span>    changes<span style=color:#ff6ac1>.</span>append(event)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-27><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-27>27</a></span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-28><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-28>28</a></span><span>    <span style=color:#ff5c57>self</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-29><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-29>29</a></span><span>  <span style=color:#ff6ac1>end</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-7-30><a style=outline:none;text-decoration:none;color:inherit href=#hl-7-30>30</a></span><span><span style=color:#ff6ac1>end</span>
</span></span></code></pre></div><p>Now we must define how these events are applied to our <code>ShoppingCart</code>.</p><div class=highlight><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-8-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-1> 1</a></span><span><span style=color:#ff6ac1>class</span> <span style=color:#f3f99d>ShoppingCart</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-8-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-2> 2</a></span><span>  <span style=color:#ff6ac1>include</span> <span style=color:#ff9f43>Aggregate</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-8-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-3> 3</a></span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-8-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-4> 4</a></span><span>  <span style=color:#ff6ac1>attr_reader</span> <span style=color:#5af78e>:items</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-8-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-5> 5</a></span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-8-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-6> 6</a></span><span>  <span style=color:#ff6ac1>def</span> <span style=color:#57c7ff>initialize</span>(uuid <span style=color:#ff6ac1>=</span> <span style=color:#ff6ac1>nil</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-8-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-7> 7</a></span><span>    <span style=color:#ff5c57>@items</span> <span style=color:#ff6ac1>=</span> <span style=color:#ff6ac1>[]</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-8-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-8> 8</a></span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-8-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-9> 9</a></span><span>    enqueue(<span style=color:#ff9f43>CartOpened</span><span style=color:#ff6ac1>.</span>new(uuid)) <span style=color:#ff6ac1>unless</span> uuid<span style=color:#ff6ac1>.</span>nil?
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-8-10><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-10>10</a></span><span>  <span style=color:#ff6ac1>end</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-8-11><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-11>11</a></span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-8-12><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-12>12</a></span><span>  on <span style=color:#ff9f43>CartOpened</span> <span style=color:#ff6ac1>do</span> <span style=color:#ff6ac1>|</span>event<span style=color:#ff6ac1>|</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-8-13><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-13>13</a></span><span>    <span style=color:#ff5c57>@uuid</span> <span style=color:#ff6ac1>=</span> event<span style=color:#ff6ac1>.</span>shopping_cart_uuid
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-8-14><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-14>14</a></span><span>  <span style=color:#ff6ac1>end</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-8-15><a style=outline:none;text-decoration:none;color:inherit href=#hl-8-15>15</a></span><span><span style=color:#ff6ac1>end</span>
</span></span></code></pre></div><p>There is a fair bit of meta-programming happening here, so let&rsquo;s explore what is happening under the hood.</p><div class=highlight><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-9-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-1> 1</a></span><span><span style=color:#ff6ac1>module</span> Aggregate
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-9-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-2> 2</a></span><span>  <span style=color:#78787e># ...</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-9-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-3> 3</a></span><span>  <span style=color:#ff6ac1>def</span> <span style=color:#f3f99d>self</span><span style=color:#ff6ac1>.</span><span style=color:#57c7ff>included</span>(base) <span style=color:#78787e># This will execute whenever the module is included</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-9-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-4> 4</a></span><span>    base<span style=color:#ff6ac1>.</span>class_eval <span style=color:#ff6ac1>do</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-9-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-5> 5</a></span><span>      <span style=color:#ff6ac1>attr_reader</span> <span style=color:#5af78e>:uuid</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-9-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-6> 6</a></span><span>      
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-9-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-7> 7</a></span><span>      <span style=color:#ff6ac1>def</span> <span style=color:#f3f99d>self</span><span style=color:#ff6ac1>.</span><span style=color:#57c7ff>on</span>(event_class, <span style=color:#ff6ac1>&amp;</span>block) <span style=color:#78787e># This will become a class method for our aggregate</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-9-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-8> 8</a></span><span>        define_method <span style=color:#5af78e>&#34;apply_</span><span style=color:#5af78e>#{</span>event_class<span style=color:#ff6ac1>::</span><span style=color:#ff9f43>NAME</span><span style=color:#5af78e>}</span><span style=color:#5af78e>&#34;</span>, <span style=color:#ff6ac1>&amp;</span>block
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-9-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-9> 9</a></span><span>      <span style=color:#ff6ac1>end</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-9-10><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-10>10</a></span><span>    <span style=color:#ff6ac1>end</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-9-11><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-11>11</a></span><span>  <span style=color:#ff6ac1>end</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-9-12><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-12>12</a></span><span>  <span style=color:#78787e># ...</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-9-13><a style=outline:none;text-decoration:none;color:inherit href=#hl-9-13>13</a></span><span><span style=color:#ff6ac1>end</span>
</span></span></code></pre></div><p>When the <code>Aggregate</code> module is included into a class, Ruby will execute the <code>included</code> method at run time, <a href=#hl-7-2>passing in the base class</a>. This method accomplishes two things:</p><p>First, it ensures there is an <a href=#hl-7-4>instance member named <code>uuid</code></a> and it is only readable.</p><p>Second, it defines a new class method named <code>on</code> which accepts two arguments, an event class object and a block.</p><p>When the <code>on</code> method is called, it is responsible for defining a dynamic method <em>at run time</em> that accepts an event class and a block. When this dynamic method is called, it executes the supplied block. We will see how this works below.</p><div class=highlight><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-10-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-10-1> 1</a></span><span><span style=color:#ff6ac1>module</span> Aggregate
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-10-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-10-2> 2</a></span><span>  <span style=color:#78787e># ...</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-10-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-10-3> 3</a></span><span>  <span style=color:#ff6ac1>def</span> <span style=color:#57c7ff>apply</span>(event)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-10-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-10-4> 4</a></span><span>    <span style=color:#ff5c57>self</span><span style=color:#ff6ac1>.</span>send(<span style=color:#5af78e>&#34;apply_</span><span style=color:#5af78e>#{</span>event<span style=color:#ff6ac1>.</span>class<span style=color:#ff6ac1>::</span><span style=color:#ff9f43>NAME</span><span style=color:#5af78e>}</span><span style=color:#5af78e>&#34;</span>, event)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-10-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-10-5> 5</a></span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-10-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-10-6> 6</a></span><span>    <span style=color:#ff5c57>self</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-10-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-10-7> 7</a></span><span>  <span style=color:#ff6ac1>end</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-10-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-10-8> 8</a></span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-10-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-10-9> 9</a></span><span>  <span style=color:#ff6ac1>private</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-10-10><a style=outline:none;text-decoration:none;color:inherit href=#hl-10-10>10</a></span><span>  
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-10-11><a style=outline:none;text-decoration:none;color:inherit href=#hl-10-11>11</a></span><span>  <span style=color:#ff6ac1>def</span> <span style=color:#57c7ff>enqueue</span>(event)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-10-12><a style=outline:none;text-decoration:none;color:inherit href=#hl-10-12>12</a></span><span>    apply(event)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-10-13><a style=outline:none;text-decoration:none;color:inherit href=#hl-10-13>13</a></span><span>    changes<span style=color:#ff6ac1>.</span>append(event)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-10-14><a style=outline:none;text-decoration:none;color:inherit href=#hl-10-14>14</a></span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-10-15><a style=outline:none;text-decoration:none;color:inherit href=#hl-10-15>15</a></span><span>    <span style=color:#ff5c57>self</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-10-16><a style=outline:none;text-decoration:none;color:inherit href=#hl-10-16>16</a></span><span>  <span style=color:#ff6ac1>end</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-10-17><a style=outline:none;text-decoration:none;color:inherit href=#hl-10-17>17</a></span><span>  <span style=color:#78787e># ...</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-10-18><a style=outline:none;text-decoration:none;color:inherit href=#hl-10-18>18</a></span><span><span style=color:#ff6ac1>end</span>
</span></span></code></pre></div><p>We&rsquo;ve added a new instance method named <code>apply</code>. It is responsible for calling the correct dynamic method, passing the event object as an argument.</p><p>Additionally, the <code>apply</code> method is now the <a href=#hl-10-13>first method called when applying</a>, finally bringing the aggregate to the state it expects to be in.</p><p>However, this magic needs a bit of help. It needs to understand event name in order to create the dynamic apply methods. This can be achieved in a few ways in Ruby. We&rsquo;ll be simple and add a class constant called <code>NAME</code> to our events:</p><div class=highlight><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-11-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-11-1>1</a></span><span><span style=color:#ff6ac1>class</span> <span style=color:#f3f99d>CartOpened</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-11-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-11-2>2</a></span><span>  <span style=color:#ff9f43>NAME</span> <span style=color:#ff6ac1>=</span> <span style=color:#5af78e>&#34;CartOpened&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-11-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-11-3>3</a></span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-11-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-11-4>4</a></span><span>  <span style=color:#78787e># ...</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-11-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-11-5>5</a></span><span><span style=color:#ff6ac1>end</span>
</span></span></code></pre></div><p>You may derive this from the class name as well.</p><p>Lastly, we can create the apply method that is called when an event is applied by using the <code>on</code> method.</p><div class=highlight><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-12-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-12-1>1</a></span><span><span style=color:#ff6ac1>class</span> <span style=color:#f3f99d>ShoppingCart</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-12-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-12-2>2</a></span><span>  <span style=color:#78787e># ...</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-12-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-12-3>3</a></span><span>  on <span style=color:#ff9f43>CartOpened</span> <span style=color:#ff6ac1>do</span> <span style=color:#ff6ac1>|</span>event<span style=color:#ff6ac1>|</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-12-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-12-4>4</a></span><span>    <span style=color:#ff5c57>@uuid</span> <span style=color:#ff6ac1>=</span> event<span style=color:#ff6ac1>.</span>shopping_cart_uuid
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-12-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-12-5>5</a></span><span>  <span style=color:#ff6ac1>end</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-12-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-12-6>6</a></span><span>  <span style=color:#78787e># ...</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-12-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-12-7>7</a></span><span><span style=color:#ff6ac1>end</span>
</span></span></code></pre></div><p>With our aggregates applying events, we are finally we are able to see the result.</p><div class=highlight><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-13-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-1>1</a></span><span><span style=color:#ff9f43>ShoppingCart</span><span style=color:#ff6ac1>.</span>new(<span style=color:#5af78e>&#34;test-uuid&#34;</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-13-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-13-2>2</a></span><span><span style=color:#ff6ac1>=&gt;</span> <span style=color:#78787e>#&lt;ShoppingCart:0x0000000135a8ac10 @items=[], @uuid=&#34;test-uuid&#34;, @changes=[#&lt;CartOpened:0x0000000135a8ab70 @shopping_cart_uuid=&#34;test-uuid&#34;&gt;]&gt;</span>
</span></span></code></pre></div><p>We can clearly see that the aggregate applies events correctly, as it has the correct <code>uuid</code>.</p><h3 id=aggregate-design-cqrs-intermission>Aggregate Design: CQRS Intermission</h3><p>Quite often, event sourcing is used in conjunction with <a href=https://martinfowler.com/bliki/CQRS.html>Command-Query-Responsibility-Segregation</a> (CQRS) as they represent a natural fit.</p><p>CQRS gives us clear seperation between <em>writing</em> data and <em>reading</em> data with Commands executing a set of business functions and Queries retreiving information.</p><p>Event sourcing provides event streams in which a specialized set of event handlers called <em>Read Projections</em> subscribe to.</p><p><a href=https://event-driven.io/en/projections_and_read_models_in_event_driven_architecture/>Read Projections</a> holds the responsibility of understanding events in the domain and transforming them into something readable. Often this is building up data in an SQL datasbase. However, the primary benefit is that it is possible to run as many Read Projections as you require.</p><p>Often, this is used to meet different querying needs. For example, you may have two Read Projections: one for inserting data into an SQL database for querying on the <em>read</em> side of the application and another for inserting into a CSV file used in reporting.</p><p><img src=/images/aws-eventsourcing/cqrs-read-projections.jpg alt="Multiple Read Projections"></p><p>By elevating the <em>read</em> requirements out of objects used for enforcing and executing our business logic, we gain a <em>write model</em> free of this extrenuous burdon.</p><p>Commands are an effective way of expressing what your domain is designed to achieve and which business rules are enforced when they are executed. They are often implemented as distinct objects executed in an aggregate. For example, given this command exists:</p><div class=highlight><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-14-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-1>1</a></span><span><span style=color:#ff6ac1>class</span> <span style=color:#f3f99d>CloseCartCommand</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-14-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-2>2</a></span><span>  <span style=color:#ff6ac1>attr_reader</span> <span style=color:#5af78e>:shopping_cart_uuid</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-14-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-3>3</a></span><span>  
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-14-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-4>4</a></span><span>  <span style=color:#ff6ac1>def</span> <span style=color:#57c7ff>initialize</span>(shopping_cart_uuid)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-14-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-5>5</a></span><span>    <span style=color:#ff5c57>@shopping_cart_uuid</span> <span style=color:#ff6ac1>=</span> shopping_cart_uuid
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-14-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-6>6</a></span><span>  <span style=color:#ff6ac1>end</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-14-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-14-7>7</a></span><span><span style=color:#ff6ac1>end</span>
</span></span></code></pre></div><p>This could be executed using an aggregate. In doing so, an event would be published and downstream event handlers (including Read Projections) would have a chance to react.</p><div class=highlight><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-15-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-15-1> 1</a></span><span><span style=color:#ff6ac1>class</span> <span style=color:#f3f99d>CloseCartCommandHandler</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-15-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-15-2> 2</a></span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-15-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-15-3> 3</a></span><span>  <span style=color:#78787e># Our repo is initialized externally</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-15-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-15-4> 4</a></span><span>  <span style=color:#ff6ac1>def</span> <span style=color:#57c7ff>initialize</span>(shopping_cart_repo)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-15-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-15-5> 5</a></span><span>    <span style=color:#ff5c57>@shopping_cart_repo</span> <span style=color:#ff6ac1>=</span> shopping_cart_repo
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-15-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-15-6> 6</a></span><span>  <span style=color:#ff6ac1>end</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-15-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-15-7> 7</a></span><span>  
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-15-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-15-8> 8</a></span><span>  <span style=color:#ff6ac1>def</span> <span style=color:#57c7ff>handle</span>(command)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-15-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-15-9> 9</a></span><span>    shopping_cart <span style=color:#ff6ac1>=</span> <span style=color:#ff5c57>@shopping_cart_repo</span><span style=color:#ff6ac1>.</span>fetch(command<span style=color:#ff6ac1>.</span>shopping_cart_uuid)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-15-10><a style=outline:none;text-decoration:none;color:inherit href=#hl-15-10>10</a></span><span>    
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-15-11><a style=outline:none;text-decoration:none;color:inherit href=#hl-15-11>11</a></span><span>    <span style=color:#78787e># An event is published but not persisted</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-15-12><a style=outline:none;text-decoration:none;color:inherit href=#hl-15-12>12</a></span><span>    shopping_cart<span style=color:#ff6ac1>.</span>execute(command)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-15-13><a style=outline:none;text-decoration:none;color:inherit href=#hl-15-13>13</a></span><span>    
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-15-14><a style=outline:none;text-decoration:none;color:inherit href=#hl-15-14>14</a></span><span>    <span style=color:#78787e># An event is persisted and pushed into the event stream</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-15-15><a style=outline:none;text-decoration:none;color:inherit href=#hl-15-15>15</a></span><span>    <span style=color:#ff5c57>@shopping_cart_repo</span><span style=color:#ff6ac1>.</span>store(shopping_cart)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-15-16><a style=outline:none;text-decoration:none;color:inherit href=#hl-15-16>16</a></span><span>  <span style=color:#ff6ac1>end</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-15-17><a style=outline:none;text-decoration:none;color:inherit href=#hl-15-17>17</a></span><span><span style=color:#ff6ac1>end</span>
</span></span></code></pre></div><h3 id=aggregate-design-command-methods>Aggregate Design: Command Methods</h3><p>Another way Commands can be implemented, is by expressing the command as a method on an aggregate instead of a distinct object. These are called <em>command methods</em>.</p><p>The penalty in doing so, is we lose one degree of expressivness in our model. However, it becomes simpler.</p><p>We will use this style for our commands as our focus is on <em>event sourcing</em> rather than Command objects. You may want to adopt a fuller Command object in your own system if the business rules become complex.</p><p>Let&rsquo;s add a command method to add items to our cart. We will start by defining a new event.</p><div class=highlight><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-16-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-1>1</a></span><span><span style=color:#ff6ac1>class</span> <span style=color:#f3f99d>ItemAdded</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-16-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-2>2</a></span><span>  <span style=color:#ff9f43>NAME</span> <span style=color:#ff6ac1>=</span> <span style=color:#5af78e>&#34;ItemAdded&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-16-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-3>3</a></span><span>  <span style=color:#ff6ac1>attr_reader</span> <span style=color:#5af78e>:shopping_cart_uuid</span>, <span style=color:#5af78e>:item_name</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-16-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-4>4</a></span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-16-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-5>5</a></span><span>  <span style=color:#ff6ac1>def</span> <span style=color:#57c7ff>initialize</span>(shopping_cart_uuid, item_name)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-16-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-6>6</a></span><span>    <span style=color:#ff5c57>@shopping_cart_uuid</span> <span style=color:#ff6ac1>=</span> shopping_cart_uuid
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-16-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-7>7</a></span><span>    <span style=color:#ff5c57>@item_name</span> <span style=color:#ff6ac1>=</span> item_name
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-16-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-8>8</a></span><span>  <span style=color:#ff6ac1>end</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-16-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-16-9>9</a></span><span><span style=color:#ff6ac1>end</span>
</span></span></code></pre></div><p>Now the command method and <code>apply</code> handler.</p><div class=highlight><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-17-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-17-1> 1</a></span><span><span style=color:#ff6ac1>class</span> <span style=color:#f3f99d>ShoppingCart</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-17-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-17-2> 2</a></span><span>  <span style=color:#ff6ac1>include</span> <span style=color:#ff9f43>Aggregate</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-17-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-17-3> 3</a></span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-17-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-17-4> 4</a></span><span>  <span style=color:#ff6ac1>attr_reader</span> <span style=color:#5af78e>:items</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-17-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-17-5> 5</a></span><span>  
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-17-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-17-6> 6</a></span><span>  <span style=color:#78787e># ...</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-17-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-17-7> 7</a></span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-17-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-17-8> 8</a></span><span>  <span style=color:#ff6ac1>def</span> <span style=color:#57c7ff>add_item</span>(item_name)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-17-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-17-9> 9</a></span><span>    enqueue(<span style=color:#ff9f43>ItemAdded</span><span style=color:#ff6ac1>.</span>new(uuid, item_name))
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-17-10><a style=outline:none;text-decoration:none;color:inherit href=#hl-17-10>10</a></span><span>  <span style=color:#ff6ac1>end</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-17-11><a style=outline:none;text-decoration:none;color:inherit href=#hl-17-11>11</a></span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-17-12><a style=outline:none;text-decoration:none;color:inherit href=#hl-17-12>12</a></span><span>  <span style=color:#78787e># ...</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-17-13><a style=outline:none;text-decoration:none;color:inherit href=#hl-17-13>13</a></span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-17-14><a style=outline:none;text-decoration:none;color:inherit href=#hl-17-14>14</a></span><span>  on <span style=color:#ff9f43>ItemAdded</span> <span style=color:#ff6ac1>do</span> <span style=color:#ff6ac1>|</span>event<span style=color:#ff6ac1>|</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-17-15><a style=outline:none;text-decoration:none;color:inherit href=#hl-17-15>15</a></span><span>    <span style=color:#ff5c57>@items</span><span style=color:#ff6ac1>.</span>append(event<span style=color:#ff6ac1>.</span>item_name)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-17-16><a style=outline:none;text-decoration:none;color:inherit href=#hl-17-16>16</a></span><span>  <span style=color:#ff6ac1>end</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-17-17><a style=outline:none;text-decoration:none;color:inherit href=#hl-17-17>17</a></span><span><span style=color:#ff6ac1>end</span>
</span></span></code></pre></div><p>The newly command method is named <code>add_item</code>. When it is executed against our <code>ShoppingCart</code> aggregate, it enqueues an <code>ItemAdded</code> event to be published. Under the hood, this event is applied by dynamically looking up the correct <code>apply</code> handler.</p><p>The <code>apply</code> handler will append the item to the aggregate&rsquo;s list of items.</p><h3 id=aggregate-design-enforcing-business-constraints>Aggregate Design: Enforcing Business Constraints</h3><p>CQRS is beyond the scope of this series. However, is helps to understand the role it plays when designing our aggregates as CQRS promotes really healthy object design in complex software.</p><p>One of the critical goals of CQRS is to provide a clear understanding of where a business constraint is and having it enforced in a single location in the code.</p><p>Attempting to execute a command should always result in raising an error if the constraint is broken. This is a critical difference between other architectures such as MVC, where invalid state is allowed in our objects often accompanied by a list of errors.</p><p>At its root, event sourcing is specifically about the persistence and rehydration of our aggregates by using a collection of events. How its events are created is only an adjunct to these mechanisms.</p><p>Enforcing business constraints happens in our command methods and is straightforward.</p><div class=highlight><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-18-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-18-1>1</a></span><span><span style=color:#ff6ac1>class</span> <span style=color:#f3f99d>ItemAlreadyAdded</span> <span style=color:#ff6ac1>&lt;</span> <span style=color:#ff9f43>StandardError</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-18-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-18-2>2</a></span><span>  <span style=color:#ff6ac1>def</span> <span style=color:#57c7ff>initialize</span>(<span style=color:#5af78e>uuid</span>:, <span style=color:#5af78e>item_name</span>:)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-18-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-18-3>3</a></span><span>    <span style=color:#ff5c57>@msg</span> <span style=color:#ff6ac1>=</span> <span style=color:#5af78e>&#34;</span><span style=color:#5af78e>#{</span>item_name<span style=color:#5af78e>}</span><span style=color:#5af78e> has already been added to cart </span><span style=color:#5af78e>#{</span>uuid<span style=color:#5af78e>}</span><span style=color:#5af78e>!&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-18-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-18-4>4</a></span><span>  <span style=color:#ff6ac1>end</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-18-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-18-5>5</a></span><span><span style=color:#ff6ac1>end</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-19-1><a style=outline:none;text-decoration:none;color:inherit href=#hl-19-1>1</a></span><span><span style=color:#ff6ac1>class</span> <span style=color:#f3f99d>ShoppingCart</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-19-2><a style=outline:none;text-decoration:none;color:inherit href=#hl-19-2>2</a></span><span>  <span style=color:#78787e># ...</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-19-3><a style=outline:none;text-decoration:none;color:inherit href=#hl-19-3>3</a></span><span>  <span style=color:#ff6ac1>def</span> <span style=color:#57c7ff>add_item</span>(item_name)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-19-4><a style=outline:none;text-decoration:none;color:inherit href=#hl-19-4>4</a></span><span>    <span style=color:#ff5c57>fail</span> <span style=color:#ff9f43>ItemAlreadyAdded</span>, <span style=color:#5af78e>uuid</span>: uuid, <span style=color:#5af78e>item_name</span>: item_name <span style=color:#ff6ac1>if</span> <span style=color:#ff5c57>@items</span><span style=color:#ff6ac1>.</span>contains?(item_name)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-19-5><a style=outline:none;text-decoration:none;color:inherit href=#hl-19-5>5</a></span><span>    
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-19-6><a style=outline:none;text-decoration:none;color:inherit href=#hl-19-6>6</a></span><span>    enqueue(<span style=color:#ff9f43>ItemAdded</span><span style=color:#ff6ac1>.</span>new(uuid, item_name))
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-19-7><a style=outline:none;text-decoration:none;color:inherit href=#hl-19-7>7</a></span><span>  <span style=color:#ff6ac1>end</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-19-8><a style=outline:none;text-decoration:none;color:inherit href=#hl-19-8>8</a></span><span>  <span style=color:#78787e># ...</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f" id=hl-19-9><a style=outline:none;text-decoration:none;color:inherit href=#hl-19-9>9</a></span><span><span style=color:#ff6ac1>end</span>
</span></span></code></pre></div><p>If an item is already added, raise an <code>ItemAlreadyAdded</code> error.</p><p>The idea behind this is the ability to <em>Fail Fast</em>. Any input which puts the system into an invalid state must fail <a href=_https://www.martinfowler.com/ieeeSoftware/failFast.pdf_><em>&ldquo;immediately and visibly&rdquo;</em></a>.</p><h2 id=conclusion>Conclusion</h2><p>We&rsquo;ve taken a crash course in what aggregates are and dived deep into their design for event sourcing systems. We can see how changes are executed against our aggregates with events, and where and how constraints are enforced.</p><p>Finally, we touched on why event sourcing so often goes hand-in-hand with CQRS.</p><p>You may go back to the <a href=../introduction>introduction page</a> or directly to the next article; <a href=../event-store-dynamodb-tables>The Event Store and DynamoDB</a> where we introduce the event store in real detail and it&rsquo;s first component.</p></div><br><div class=comments><script src=https://utteranc.es/client.js repo=APiercey/utterances issue-number=3 label=utterances theme=github-light crossorigin=anonymous async></script></div></div><div class=footer><div class=footer-social><span class="social-icon social-icon-github"><a href=https://github.com/apiercey title=github target=_blank rel=noopener><img src=/images/social/github.svg width=24 height=24 alt=github></a></span>
<span class="social-icon social-icon-linkedin"><a href=https://www.linkedin.com/in/alexander-butt-piercey title=linkedin target=_blank rel=noopener><img src=/images/social/linkedin.svg width=24 height=24 alt=linkedin></a></span>
<span class="social-icon social-icon-twitter"><a href=https://twitter.com/programincolour title=twitter target=_blank rel=noopener><img src=/images/social/twitter.svg width=24 height=24 alt=twitter></a></span></div></div></div><script type=text/javascript src=/js/bundle.min.28d149c65e8b43f935b5da6797544f9e363170785f466641db0d007cee894169.js></script>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-CX84WRHVTJ"></script>
<script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-CX84WRHVTJ")</script></body></html>